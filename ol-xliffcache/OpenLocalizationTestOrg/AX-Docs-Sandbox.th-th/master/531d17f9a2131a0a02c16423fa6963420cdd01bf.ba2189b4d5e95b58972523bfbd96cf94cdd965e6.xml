{"content":"---\n# required metadata\n\ntitle: Set up and deploy on-premises environments\ndescription: This topic provides information about how to plan, set up, and deploy an on-premises environment.\nauthor: kfend\nmanager: AnnBe\nms.date: 06/14/2017\nms.topic: article\nms.prod: \nms.service: dynamics-ax-platform\nms.technology: \n\n# optional metadata\n\n# ms.search.form: \n# ROBOTS: \naudience: Application User, Developer, IT Pro\n# ms.devlang: \n# ms.reviewer: 71\nms.search.scope: Core\n# ms.tgt_pltfrm: \nms.custom: 55651\nms.assetid: \nms.search.region: Global\n# ms.search.industry: \nms.author: sarvanisathish\nms.search.validFrom: 2016-08-30\nms.dyn365.ops.version: Platform update 8\n\n---\n\n# Set up and deploy on-premises environments\n\nThis document describes how to plan your deployment, set up the infrastructure, and deploy Microsoft Dynamics 365 for Finance and Operations, Enterprise edition (on-premises).\n\n## Finance and Operations components\n\nThe Finance and Operations application consists of three main components:\n\n- Application Object Server (AOS)\n- Business Intelligence (BI)\n- Financial Reporting/Management Reporter\n\nThese components depend on the following system software:\n\n- Microsoft Windows Server 2016\n- Microsoft SQL Server 2016 SP1, which has following features:\n\n    - Full-text index search is enabled.\n    - SQL Server Reporting Services (SSRS).\n    - SQL Server Integration Services (SSIS).\n    \n     > [!NOTE]\n     > The application will not run if Full Text Search is not enabled.\n\n- SQL Server Management Studio\n- Standalone Microsoft Azure Service Fabric\n- Windows PowerShell 5.0 or later\n- Active Directory Federation Services (AD FS) on Windows Server 2016\n\n  The domain controller must be Windows Server 2012 R2 or later with a domain functional level of 2012 R2, or greater\n\n  For more information about domain functional levels, see: \n  - [What Are Active Directory Functional Levels](https://technet.microsoft.com/en-us/library/cc787290(v=ws.10).aspx)\n  - [Understanding Active Directory Domain Services Functional Levels](https://technet.microsoft.com/en-us/library/understanding-active-directory-functional-levels(v=ws.10).aspx)\n\n\n## Lifecycle Services\n\nFinance and Operations bits are distributed through Microsoft Dynamics Lifecycle Services (LCS). Before you can deploy, you must purchase license keys through the [Enterprise Agreements](https://www.microsoft.com/en-us/Licensing/licensing-programs/enterprise.aspx) channel and set up an on-premises project in LCS. Deployments can be initiated only through LCS. For more information about how to set up on-premises projects in LCS, see [Create an on-premises project in Lifecycle Services](../lifecycle-services/lbd-create-lcs-on-prem-project.md).\n\n## Authentication\n\nThe on-premises application works with AD FS. To interact with LCS, you must also configure Azure Active Directory (Azure AD).\n\n## Standalone Service Fabric\n\nFinance and Operations uses Standalone Service Fabric. For more information, see the [Service Fabric documentation](/azure/service-fabric/).\n\n## Infrastructure\n\nFinance and Operations is designed to work on a hyper-converged architecture. The hardware configuration includes the following components:\n\n- Standalone Service Fabric cluster that is based on Windows Server 2016 virtual machines (VMs)\n- SQL Server (both Clustered SQL and Always-On are supported)\n- AD FS for authentication\n- Server Message Block (SMB) version 3 file share for storage\n- Optional: Microsoft Office Server 2017\n\nFor more information, see [System requirements](../get-started/system-requirements.md) and Sizing guidelines.\n\n### Hardware layout\n\nPlan your infrastructure and Service Fabric cluster, based on the recommended sizing in [Hardware sizing for on-premises environments](../get-started/hardware-sizing-on-premises-environments.md). For more information about how to plan the Service Fabric cluster, see [Plan and prepare your Service Fabric standalone cluster deployment](/azure/service-fabric/service-fabric-cluster-standalone-deployment-preparation).\n\nThe following table shows an example of the hardware layout. This example is used throughout this topic to illustrate the setup.\n\n> [!NOTE]\n> The Primary node of the Service Fabric cluster must have at least three nodes. In this example, **OrchestratorType** is designated as the Primary node type.\n\n| Machine purpose                                 | Machine name    | IP address    |\n|-------------------------------------------------|-----------------|---------------|\n| Domain controller                               | DAX7SQLAODC1    | 10.179.108.2  |\n| AD FS                                           | DAX7SQLAOADFS1  | 10.179.108.3  |\n| File server                                     | DAX7SQLAOFILE1  | 10.179.108.4  |\n| SQL Always-On cluster                           | DAX7SQLAOSQLA01 | 10.179.108.5  |\n|                                                 | DAX7SQLAOSQLA02 | 10.179.108.6  |\n|                                                 | DAX7SQLAOSQLA   | 10.179.108.9  |\n| Client                                          | SQLAOCLIENT1    | 10.179.108.11 |\n| Service Fabric cluster/AOS 1                    | SQLAOSF1AOS1    | 10.179.108.12 |\n| Service Fabric cluster/AOS 2                    | SQLAOSF1AOS2    | 10.179.108.13 |\n| Service Fabric cluster/AOS 3                    | SQLAOSF1AOS3    | 10.179.108.14 |\n| Service Fabric cluster/Orchestrator 1           | SQLAOSF1ORCH1   | 10.179.108.15 |\n| Service Fabric cluster/Orchestrator 2           | SQLAOSF1ORCH2   | 10.179.108.16 |\n| Service Fabric cluster/Orchestrator 3           | SQLAOSF1ORCH3   | 10.179.108.17 |\n| Service Fabric cluster/Management Reporter node | SQLAOSMR1       | 10.179.108.18 |\n| Service Fabric cluster/SSRS node                | SQLAOSFBIN1     | 10.179.108.10 |\n\n## Setup\n\n### Prerequisites\n\nBefore you start the setup, the following prerequisites must be met. The setup of these prerequisites is out of scope for this document.\n\n- Active Directory Domain Services (AD DS) is installed and configured in your network.\n- AD FS is deployed.\n- SQL Server, SSRS, and Management Studio are installed.\n\n### Overview\n\nThe following steps must be completed to set up the infrastructure for Finance and Operations.\n\n1. Plan your domain name and DNS zones\n2. Plan and acquire your certificates\n3. Plan your users and Service accounts\n4. Create DNS zones and add A records\n5. Join VMs to the Domain\n6. Add prerequisite software to VMs\n7. Download setup scripts from LCS\n8. Describe your configuration\n9. Install Certificates\n10. Set up a standaalone Service Fabric CLuster\n11. Configure LCS connectivity for the tenant\n12. Set up File Storage\n13. Set up SQL Server\n14. Configure the Databases\n15. Encrypt credentials\n16. Set up SSRS\n17. Configure AD FS\n\n### Plan your domain name and DNS zones\n\nWe recommend that you use a publicly registered domain name for your production installation of AOS. In that way, it can be accessed outside the network, if outside access is required.\n\nFor example, if your company's domain is contoso.com, your zone for Finance and Operations (on-premises) might be d365ffo.onprem.contoso.com, and the host names might be as follows:\n\n- ax.d365ffo.onprem.contoso.com for AOS machines\n- sf.d365ffo.onprem.contoso.com for the Service Fabric cluster\n\n### Plan and acquire your certificates\n\nSecure Sockets Layer (SSL) certificates are required in order to secure a Service Fabric cluster and all the applications that are deployed. For your production and sandbox workloads, we recommend that you acquire certificates from a certificate authority (CA) such as [DigiCert](https://www.digicert.com/ssl-certificate/), [Comodo](https://ssl.comodo.com/), [Symantec](https://www.websecurity.symantec.com/ssl-certificate), [GoDaddy](https://www.godaddy.com/web-security/ssl-certificate), or [GlobalSign](https://www.globalsign.com/en/ssl/). If your domain is set up with [Active Directory Certificate Services](https://technet.microsoft.com/en-us/library/cc772393(v=ws.10).aspx) (AD CS), you can create the certificates through AD CS. Each certificate must contain a private key that was created for key exchange, and it must be exportable to a Personal Information Exchange (.pfx) file.\n\nSelf-signed certificates can be used only for testing purposes. For convenience, the setup scripts include scripts that generate and export self-signed certificates. As we've mentioned, these certificates must be used for testing purposes only.\n\n| Purpose                                      | Explanation | Additional requirements |\n|----------------------------------------------|-------------|-------------------------|\n| SQL Server SSL certificate                   | This certificate is used to encrypt data that is transmitted across a network between an instance of SQL Server and a client application. | <p>The domain name of the certificate should match the fully qualified domain name (FQDN) of the SQL Server instance or listener.</p><p>For example, if the SQL listener is hosted on the machine DAX7SQLAOSQLA, the certificate's DNS name is DAX7SQLAOSQLA.onprem.contoso.com.</p> |\n| Service Fabric Server certificate            | This certificate is used to help secure the node-to-node communication between the Service Fabric nodes. This certificate is also used as the Server certificate that is presented to the client that connects to the cluster. | <p>The domain name of the certificate must match the DNS zone where AOS and Service Fabric are hosted.</p><p>For example, the domain name of the certificate might be \\*.onprem.contoso.com or \\*.contoso.com.</p><p>If you use a wildcard certificate, the wildcard character applies to only one level. A subdomain, subject alternative name (SAN), must be applied to the certificate if it's more than one level, such as \\*.contoso.com in the previous example.</p> |\n| Service Fabric Client certificate            | This certificate is used by clients to view and manage the Service Fabric cluster. | |\n| Encipherment Certificate                     | This certificate is used to encrypt sensitive information such as the SQL Server password and user account passwords. | <p>The certificate key usage must include Data Encipherment (10) and should not include Server Authentication or Client Authentication.</p><p>For more information, see [Managing secrets in Service Fabric applications](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-application-secret-management).</p> |\n| AOS SSL Certificate                          | <p>This certificate is used as the Server certificate that is presented to the client for the AOS website. It's also used to enable Windows Communication Foundation (WCF)/Simple Object Access Protocol (SOAP) certificates.</p><p>The Service Fabric Server certificate can be used here if it's a wildcard certificate.</p> | <p>The domain name of the certificate must match the DNS zone where AOS and Service fabric are hosted.</p><p>For example, the domain name of the certificate might be \\*.d365ffo.onprem.contoso.com, \\*.onprem.contoso.com, or \\*.contoso.com.</p><p>If you use a wildcard certificate, the wildcard applies to only one level. A subdomain, SAN, must be applied to the certificate if it's more than one level, such as \\*.contoso.com in the previous example.</p> |\n| Session Authentication certificate           | This certificate is used by AOS to help secure a user's session information. | This is also the **File Share** Certificate that will used at the time of deployment from LCS. |\n| Data Encryption and Data Signing certificate | These certificates are used by AOS to encrypt sensitive information. | |\n| Financial Reporting client certificate       | This certificate is used to help secure the communication between the Financial Reporting services and AOS. | |\n| Reporting Certificate                        | This certificate is used to help secure the communication between SSRS and AOS. | |\n| On-Premise local agent certificate           | <p>This certificate is used to help secure the communication between a local agent that is hosted on-premises and LCS.</p><p>This certificate enables the local agent to act on behalf of your Azure AD tenant, and to communicate with LCS to orchestrate and monitor deployments.</p> | |\n\n### Plan your users and service accounts\n\nYou must create several user or service accounts for Finance and Operations (on-premises) to work. You must create a combination of group managed service accounts (gMSAs), domain accounts, and SQL accounts. The following table shows the user accounts, their purpose, and example names that will be used in this topic.\n\n| User account                                            | Type           | Purpose | User name |\n|---------------------------------------------------------|----------------|---------|-----------|\n| Financial Reporting Application Service Account         | gMSA           |         | Contoso\\\\svc-FRAS$ |\n| Financial Reporting Process Service Account             | gMSA           |         | Contoso\\\\svc-FRPS$ |\n| Financial Reporting Click Once Designer Service Account | gMSA           |         | Contoso\\\\svc-FRCO$ |\n| AOS Service Account                                     | gMSA           | This user should be created for future-proofing. We plan to enable AOS to work with the gMSA in upcoming releases. By creating this user at the time of setup, you will help guarantee a seamless transition to the gMSA. | Contoso\\\\svc-AXSF$ |\n| AOS Service Account                                     | Domain account | AOS uses this user in the GA release. | Contoso\\\\AXServiceUser |\n| AOS SQL DB Admin user                                   | SQL user       | Finance and Operations uses this user to authenticate with SQL\\*. This user will also be replaced by the gMSA user in upcoming releases. | AXDBAdmin |\n| Local Deployment Agent Service Account                  | gMSA           | This account is used by the local agent to orchestrate the deployment on various nodes. | Contoso\\\\Svc-LocalAgent$ |\n\n\\* The SQL user name and password for SQL authentication are secured, because they are encrypted and stored in the file share.\n\n### Create DNS zones and add A records\n\nDNS is integrated with AD DS, and lets you organize, manage, and find resources in a network. Create a DNS forward lookup zone and A records for the AOS host name and the Service Fabric cluster. In this example setup, the DNS zone name is d365ffo.onprem.contoso.com, and the A records/host names are as follows:\n\n- **ax**.d365ffo.onprem.contoso.com for AOS machines\n- **sf**.d365ffo.onprem.contoso.com for the Service Fabric cluster\n\n#### Add a DNS zone\n\nUse the following procedure to add a DNS zone.\n\n1. Sign in to the domain controller machine, click **Start**, and start DNS Manager by typing **dnsmgmt.msc**.\n2. Right-click the domain controller name, and then click **New Zone** \\> **Next**.\n3. Select **Primary Zone**.\n4. Leave the **Store the zone in Active Directory (available only if the DNS Server is a writeable domain controller** check box selected, and then click **Next**.\n5. Select **To all DNS Servers running on Domain Controllers in this domain: Contoso.com**, and then click **Next**.\n6. Select **Forward Lookup Zone**, and then click **Next**.\n7. Enter the zone name for your setup, and then click **Next**. For example, enter **d365ffo.onprem.contoso.com**.\n8. Select **Do not allow dynamic updates**, and then click **Next**.\n\n#### Set up an A record for AOS\n\nIn the new DNS zone, create one A record that is named **ax.d365ffo.onprem.contoso.com** for **each** Service Fabric cluster node of the **AOSNodeType** type. Don't create A records for the other node types.\n\n1. Right-click the new zone, and then click **New Host**.\n2. Enter the name and IP address of the Service Fabric node (e.g. 10.179.108.12), and then click **Add Host**.\n\n#### Set up an A Record for the orchestrator\n\nIn the new DNS zone, create an A record that is named **sf.d365ffo.onprem.contoso.com** for **each** Service Fabric cluster node of the **OrchestratorType** type. Don't create A records for the other node types.\n\n1. Right-click the new zone, and then click **New Host**.\n2. Enter the name and IP address of the Service Fabric node (e.g. 10.179.108.15), and then click **Add Host**.\n\n#### Join VMs to the domain\n\nJoin each of the VMs to the domain by completing the steps in [How to join Windows Server 2016 to an Active Directory domain](http://www.tomsitpro.com/articles/join-windows-server-2016-to-ad-domain,2-1063.html). Alternatively, use the Windows PowerShell script.\n\n```\n$domainName = Read-Host -Prompt 'Specify domain name (ex: contoso.com)'\nAdd-Computer -DomainName $domainName -Credential (Get-Credential -Message 'Enter domain credential')\nRestart-Computer\n```\n#### Disable User Access Control \n\nExecute the below script to disable the User Access Control on **every** Service Fabric node.\n```\n$RegPath = \"HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\"\nNew-ItemProperty -Path $RegPath -Name \"EnableLUA\" -Value 0 -PropertyType \"DWORD\" -Force\nNew-ItemProperty -Path $RegPath -Name \"ConsentPromptBehaviorAdmin\" -Value 0 -PropertyType \"DWORD\" -Force\nNew-ItemProperty -Path $RegPath -Name \"EnableUIADesktopToggle\" -Value 0 -PropertyType \"DWORD\" -Force\nNew-ItemProperty -Path $RegPath -Name \"LocalAccountTokenFilterPolicy\" -Value 1 -PropertyType \"DWORD\" -Force\n```\n**Reboot the node after the script completes successfully.**\n\n#### Add prerequisite software to VMs\n\nThe following table lists the prerequisite software that must be applied to the machines of each node type.\n\n> [!NOTE]\n> You will have to restart your computer after you install the components.\n\n| Node type | Component | Command |\n|-----------|-----------|---------|\n| AOS       | SNAC – ODBC driver | See [Microsoft ODBC Driver 13.1 for SQL Server - Windows + Linux](https://www.microsoft.com/en-us/download/details.aspx?id=53339). |\n| AOS       | The Microsoft .NET Framework version 2.0–3.5 (CLR 2.0) | `Add-WindowsFeature -Name NET-Framework-Features, NET-Framework-Core, NET-HTTP-Activation, NET-Non-HTTP-Activ` |\n| AOS       | The Microsoft .NET Framework version 4.0–4.6 (CLR 4.0) | `Add-WindowsFeature -Name NET-Framework-45-Features, NET-Framework-45-Core, NET-Framework-45-ASPNET, NET-WCF-Services45, NET-WCF-TCP-PortSharing45` |\n| AOS       | Internet Information Services (IIS) | `Add-WindowsFeature WAS, WAS-Process-Model, WAS-NET-Environment, WAS-Config-APIs`<br>`# Windows Process Activation Service`<br>`Add-WindowsFeature Web-Server, Web-WebServer, Web-Security, Web-Filtering, Web-App-Dev, Web-Net-Ext, Web-Mgmt-Tools, Web-Mgmt-Console` |\n| AOS       | Microsoft SQL Server Management Studio 2016 | |\n| AOS       | Microsoft Visual C++ Redistributable Packages for Microsoft Visual Studio 2013 | See [Microsoft Visual C++ Redistributable Packages for Visual Studio 2013](https://support.microsoft.com/en-us/help/3179560). |\n| AOS       | Microsoft Access Database Engine 2010 Redistributable | See [Microsoft Access Database Engine 2010 Redistributable](https://www.microsoft.com/en-us/download/details.aspx?id=13255) |\n| BI        | The .NET Framework version 2.0–3.5 (CLR 2.0) | `Add-WindowsFeature -Name NET-Framework-Features, NET-Framework-Core, NET-HTTP-Activation, NET-Non-HTTP-Activ` |\n| BI        | The .NET Framework version 4.0–4.6 (CLR 4.0) | `Add-WindowsFeature -Name NET-Framework-45-Features, NET-Framework-45-Core, NET-Framework-45-ASPNET, NET-WCF-Services45, NET-WCF-TCP-PortSharing45` |\n| BI        | Microsoft SQL Server 2016 SP1 | |\n| BI        | Management Studio 2016 | |\n| BI        | SQL Server Reporting Services 2016 in **Native** mode | |\n| MR        | The .NET Framework version 2.0–3.5 (CLR 2.0) | `Add-WindowsFeature -Name NET-Framework-Features, NET-Framework-Core, NET-HTTP-Activation, NET-Non-HTTP-Activ` |\n| MR        | The .NET Framework version 4.0–4.6 (CLR 4.0) | `Add-WindowsFeature -Name NET-Framework-45-Features, NET-Framework-45-Core, NET-Framework-45-ASPNET, NET-WCF-Services45, NET-WCF-TCP-PortSharing45` |\n| MR        | Visual C++ Redistributable Packages for Visual Studio 2013 | See [Microsoft Visual C++ Redistributable Packages for Visual Studio 2013](https://support.microsoft.com/en-us/help/3179560). |\n\n#### Download setup scripts from LCS\n\nWe have provided several scripts to help improve the setup experience. Follow these steps to download the setup scripts from LCS.\n\n1. Sign in to LCS (<https://lcs.dynamics.com/v2>).\n2. On the dashboard, click the **Shared asset library** tile.\n3. Click the **Deployment** tab (or the **Model** tab).\n4. In the grid, select the **Dynamics 365 for Operations - On-premises Deployment scripts** row.\n5. Click **Versions**, and download the latest version of the scripts.\n\n### Describe your configuration\n\nThis section provides information about the scripts that you must run. The scripts are discussed in the order that you must run them in. To run the scripts, fill in the template file at $(downloadPath)\\\\ConfigTemplate.xml. The ConfigTemplate.xml file describes the Service Fabric clusters, the certificates that are used to configure them, and the accounts that must be granted access to the relevant certificates. In the example that is provided, the values are filled in for the example infrastructure that is described in this topic. The template file will be used in the next section.\n\n#### Create the domain account for a service user\n\nRun the following command to create the domain user account, contoso\\\\AXServiceUser.\n\n```\nNew-ADUser -Name 'AXServiceUser' `\n    -AccountPassword (Read-Host -Prompt 'Specify User Password' -AsSecureString) `\n    -PasswordNeverExpires $true -ChangePasswordAtLogon $false `\n    -Enabled $true -UserPrincipalName 'AXServiceUser@contoso.com'\n```\n\n#### Create gMSAs\n\n1. Change the directory to **$(DownloadPath)**, and run the following Windows PowerShell command.\n\n    > [!NOTE]\n    > This script doesn't create the users. Instead, it prints the commands that must be manually run on the domain controller machine.\n\n    ```\n    # Generate gMSA account creation script (shows in console):\n    .\\Get-NewGMSAInDomainScript.ps1 -InputXml .\\ConfigTemplate.xml\n    ```\n\n2. Copy the output of the command into a Windows PowerShell window. Make sure that the line breaks are removed, and run the lines on the Active Directory domain controller machine by using elevated privileges (right-click, and then click **Run as Administrator**).\n3. Run the following script on the Active Directory domain controller machine to validate that the accounts have been successfully created. Make sure that you run the script after you replace the pattern that matches the naming convention of the service accounts.\n\n    ```\n    #Use this command to validate the gMSA accounts are added to AD.\n    #Ensure to replace the Filter parameter with the pattern used to create your accounts.\n    Get-ADServiceAccount -Filter { samAccountName -like \"svc-*\" }\n    ```\n\n4. Run the Export-AddGMSAsONVMScript.ps1 script on the client machine. This script generates scripts that are run on each Service Fabric VM and adds them to a folder that corresponds to each VM name.\n\n    ```\n    # Exports a script for installing gMSA on VM nodes into a directory VMs\\<VMName>, again feed from XML\n    .\\Export-AddGMSAsOnVMScript.ps1 -InputXml .\\ConfigTemplate.xml\n    ```\n\n#### Stop IIS\n\nUse Remote Desktop Protocol (RDP) to connect to each Service Fabric VM, and complete the manual steps in [Start or Stop the Web Server (IIS 7)](https://technet.microsoft.com/en-us/library/cc732317(v=ws.10).aspx). Alternatively, use the following Windows PowerShell script by using RDP to connect to each Service Fabric VM.\n\n```\n$ServiceName = \"WAS\"\n$wasService = Get-Service $ServiceName -ErrorAction SilentlyContinue\nif($wasService)\n{\n    $wasService.DependentServices | Stop-Service -Force -ErrorAction Continue\n    $wasService | Stop-Service -ErrorAction Continue\n    Set-Service $ServiceName -StartupType Disabled\n}\n\n$ServiceName = 'W3SVC'\n$w3svc = Get-Service $ServiceName -ErrorAction SilentlyContinue\nif($w3svc)\n{\n    $w3svc.DependentServices | Stop-Service -Force -ErrorAction Continue\n    $w3svc | Stop-Service -ErrorAction Continue\n    Set-Service $ServiceName -StartupType Disabled\n}\n```\n_IIS feature should be installed but disabled as there are some dependencies to the IIS dlls in the product._\n\n### Install Certificates\n\n1. If you acquired the certificates that were listed earlier in this topic from a valid CA, fill in the .pfx file name and thumbprint for the certificates in the ConfigTemplate.xml file. Set the **generateSelfSignedCert** attribute to **False** and the **exportable** attribute to **False**. Copy the .pfx files to the $(DownloadPath)\\\\InfrastructureScripts\\\\Certs folder.\n2. If you're using self-signed certificates (for testing purposes only), run the following script. To create self-signed certificates, in the ConfigTemplate.xml file, make sure that **generateSelfSignedCert** is set to **True** and **exportable** is set to **True**. The script will update the XML with the thumbprint for the certificates.\n\n    ```\n    # Create self-signed certs (optionally, use -Display if you only want to see commands):\n    # Note: this script is completely driven off ConfigTemplate.xml\n    .\\New-SelfSignedCertificates.ps1 -InputXml .\\ConfigTemplate.xml\n    ```\n\n3. Export the new certificates with the private key (the .pfx file). Use the following script to generate and run the export commands in Windows PowerShell. The .pfx files will be put into the Certs folder.\n\n    ```\n    # Exports Pfx files into a directory VMs\\<VMName>, all the certs will reside in a folder named Certs\\\n    # Feeds from XML, if certs don't have passwords then you are prompted to enter one\n    .\\Export-PfxFiles.ps1 -InputXml .\\ConfigTemplate.xml\n    ```\n\n    > [!NOTE]\n    > The certificates must have been installed and must be present in cert:\\\\CurrentUser\\\\My. The certificates must also be exportable.\n\n    If you're using self-signed certificates, skip to the next section. You don't have to complete this procedure.\n\n4. After you export or copy the .pfx files into the $(DownloadPath)\\\\InfrastructureScripts\\\\Certs folder, run the following commands to generate scripts that will be put in the folders that correspond to the VMs.\n\n    ```\n    # Exports script for adding ACLs to certs into a directory VMs\\<VMName>\n    .\\Export-CertificateAclsForVMs.ps1 -InputXml .\\ConfigTemplate.xml\n    \n    # Exports Import-PfxFiles.ps1 script for importing PFXs on VM nodes into a directory VMS\\<VMname>:\n    .\\Export-ImportPfxFilesScript.ps1 -InputXml .\\ConfigTemplate.xml\n    \n    .\\Export-UnblockStrongNameScript.ps1 -InputXml .\\ConfigTemplate.xml\n    ```\n\n5. Copy the scripts in each folder to the VMs that correspond to the folder name.\n6. On each VM, run the following scripts in the order that they appear in.\n\n    ```\n    #Run this script only if it exists\n    .\\Add-GMSAOnVM.ps1\n    \n    .\\Import-PfxFiles.ps1\n    \n    .\\Set-CertificateAcls.ps1\n    \n    #Run this script only if it exists\n    .\\Unblock-StrongName.ps1\n    ```\n\n### Set up a standalone Service Fabric cluster\n\n1. Run the following command to generate the ClusterConfig.json file.\n\n    ```\n    .\\New-SFClusterConfig.ps1 -InputXml .\\ConfigTemplate.xml\n    ```\n\n    For more information, see, [Step 1B: Create a multi-machine cluster](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-for-windows-server#create-the-cluster), [Secure a standalone cluster on Windows using X.509 certificates](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-windows-cluster-x509-security), and [Create a standalone cluster running on Windows Server](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-for-windows-server#create-the-cluster).\n\n2. Download the [Service Fabric standalone installation package](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-for-windows-server#download-the-service-fabric-standalone-package) onto one of your Service Fabric nodes. After the zip file is downloaded, unblock it by right-clicking the zip file and then clicking **Properties**. In the dialog box, select the **Unblock** check box in the lower right.\n3. Copy the zip file to one of the nodes in the Service Fabric cluster, and unzip it.\n4. Run the following commands to create an inbound firewall rule on ports 443 and 445 in all nodes.\n\n    ```\n    #Create inbound Rule\n    New-NetFirewallRule -DisplayName \"SFInbound443445\" -LocalPort 135, 137, 138, 139, 445, 443 -Direction Inbound -Enabled True -Protocol TCP\n    \n    #Test inbound Rule\n    Get-NetFirewallRule -DisplayName \"SFInbound443445\"\n    ```\n\n5. Run the following commands to create an inbound firewall rule on port 80 for the SSRS node only.\n\n    ```\n    #Create inbound Rule\n    New-NetFirewallRule -DisplayName \"Reporting80\" -LocalPort 80 -Direction Inbound -Enabled True -Protocol TCP\n    \n    #Test inbound Rule\n    Get-NetFirewallRule -DisplayName \"Reporting80\"\n    ```\n\n6. Copy your ClusterConfig.json file to your unzipped install location of standalone Service Fabric.\n7. Navigate to the unzipped install location in Windows PowerShell by using elevated privileges, and run the following command to test ClusterConfig.\n\n    ```\n    .\\TestConfiguration.ps1 -ClusterConfigFilePath .\\clusterConfig.json\n    ```\n\n8. If the test is successful, run the following command to deploy the cluster.\n\n    ```\n    .\\CreateServiceFabricCluster.ps1 -ClusterConfigFilePath .\\ClusterConfig.json\n    ```\n\n9. After the cluster is created, open the Service Fabric explorer on any client machine to validate the installation:\n\n    1. Install the Service Fabric client certificate in CurrentUser\\\\My if it isn't already installed.\n    2. Go to **IE settings** \\> **Compatibility Mode**, and clear the **Display Intranet sites in compatibility mode** check box.\n    3. Go to `https://sf.d365ffo.onprem.contoso.com:19080`, where sf.d365ffo.onprem.contoso.com is the host name of the Service Fabric cluster that is specified in the zone. If DNS name resolution isn't configured, use the IP address of the machine.\n    4. Select the client certificate. The **Service Fabric explorer** page appears.\n\n### Configure LCS connectivity for the tenant\n\nDeployment and servicing of Finance and Operations are orchestrated through LCS by using an on-premises local agent. To establish connectivity from LCS to the Finance and Operations tenant, you must configure a certificate that enables the local agent to act on behalf on your Azure AD tenant (for example, Contoso.Onmicrosoft.com).\n\nUse the on-premises agent certificate that you acquired from a CA or the self-signed certificate that you generated by using scripts.\n\nOnly user accounts that have the Global Administrator directory role can add certificates to authorize LCS. By default, the person who signs up for Microsoft Office 365 for your organization will be the global administrator for the directory.\n\n> [!NOTE]\n> You must configure the certificate exactly one time per tenant. All on-premises environments can use the same certificate to connect with LCS.\n\n1. Download and install the latest version of Azure PowerShell on a client machine. For more information, see [Install and configure Azure PowerShell](https://docs.microsoft.com/en-us/powershell/azure/install-azurerm-ps?view=azurermps-4.1.0&viewFallbackFrom=azurermps-4.0.0).\n2. Sign in to the [customer's Azure portal](https://portal.azure.com) to verify that you have the Global Administrator directory role.\n3. Run the following script from $(DownloadPath)\\\\InfrastructureScripts.\n\n   ```\n   .\\AddCertToServicePrincipal.ps1 -CertificateThumbprint <OnPremLocalAgent Certificate Thumbprint>\n   ```\n\n### Set up file storage\n\nYou must set up two highly available SMB 3.0 file shares. For information about how to enable SMB 3.0, see[SMB Security Enhancements](https://technet.microsoft.com/en-us/library/dn551363(v=ws.11).aspx#BKMK_disablesmb1).\nSecure dialect negotiation can't detect or prevent downgrades from SMB 2.0 or 3.0 to SMB 1.0. Because of this, and to take advantage of the full capabilities of SMB encryption, we strongly recommend that you disable the SMB 1.0 server\n\n> [!NOTE]\n> To help guarantee that your data is protected while it's at rest in your environment, BitLocker Drive Encryption must be enabled on every machine. For information about how to enable BitLocker, see [BitLocker: How to deploy on Windows Server 2012 and later](https://docs.microsoft.com/en-us/windows/device-security/bitlocker/bitlocker-how-to-deploy-on-windows-server).\n\n- A file share that stores user documents that are uploaded to AOS (for example, \\\\\\\\DAX7SQLAOFILE1\\\\aos-storage).\n- A file share that stores the latest build and configuration files to orchestrate the deployment (for example, \\\\\\\\DAX7SQLAOFILE1\\\\agent))\n\n    > [!NOTE]\n    > Keep this file share path as short as possible to avoid exceeding the maximum path length on the files that will be put in the share.\n\n1. On the file share machine, run the following command.\n\n    ```\n    Install-WindowsFeature -Name FS-FileServer -IncludeAllSubFeature -IncludeManagementTools\n    ```\n#### Set up the \\\\\\\\DAX7SQLAOFILE1\\\\aos-storage file share\n\n2. In Server Manager, select **File and Storage Services** \\> **Shares**.\n3. Click **Tasks** \\> **New Share** to create a new share with name **aos-storage**.\n4. Grant **Modify** permissions for each machine in the Service Fabric cluster except **OrchestratorNodeType**.\n5. Grant **Modify** permissions for the user AOS domain user (contoso\\\\AXServiceUser) and the gMSA user (contoso\\\\svc-AXSF).\n\n#### Set up the \\\\\\\\DAX7SQLAOFILE1\\\\agent file share\n\n6. Go back to Server Manager, select **File and Storage Services** \\> **Shares**.\n7. Click **Tasks** \\> **New Share** to create a new share with name **agent**.\n8. Grant **Full-Control** permissions to the gMSA user for the local deployment agent (contoso\\\\svc-LocalAgent$).\n\n### Set up SQL Server\n\n1. Install SQL Server 2016 SP1 with high availability, either as SQL clusters that include a Storage Area Network (SAN) or in an Always-On configuration.  Verify that the **Database Engine, Reporting Services, Full Text Search**, and **Management Tools** are already installed.\n> [!NOTE]\n> Please ensure that the SQL Always On is setup according to [Select Initial Data Synchronization Page (Always On Availability Group Wizards)](https://docs.microsoft.com/en-us/sql/database-engine/availability-groups/windows/select-initial-data-synchronization-page-always-on-availability-group-wizards) and follow [To Prepare Secondary Databases Manually](https://docs.microsoft.com/en-us/sql/database-engine/availability-groups/windows/select-initial-data-synchronization-page-always-on-availability-group-wizards#PrepareSecondaryDbs)\n2. Run the SQL Service as a domain user.\n3. Get an SSL certificate from a CA to configure Finance and Operations. For testing purposes, you can create and use a self-signed certificate.\n\n**Self-signed certificate for Clustered SQL instance**\n   ```\n   New-SelfSignedCertificate -CertStoreLocation \"cert:\\CurrentUser\\My\" -DnsName \"DAX7SQLAOSQLA.contososqlao.com\" -Provider \"Microsoft Enhanced RSA and AES Cryptographic Provider\" -Subject \"DAX7SQLAOSQLA.contososqlao.com\"\n   ```\n**Self-signed certificate for Always-On SQL instance**\n```\n#https://www.derekseaman.com/2014/11/sql-2014-alwayson-ag-pt-13-ssl.html\n\n# Create certificate for each SQL Node (i.e. 2 nodes = 2 certificates)\n# Run script on each node\n$computerName = $env:COMPUTERNAME.ToLower() \n$domain = $env:USERDNSDOMAIN.ToLower()\n$listenerName = 'dax7sqlaosqla' \n$cert = New-SelfSignedCertificate -Subject \"$computerName.$domain\" -DnsName \"$listenerName.$domain\", $listenerName, $computerName -Provider 'Microsoft Enhanced RSA and AES Cryptographic Provider'\n\n```\n4. Using the certificate, complete the steps in [How to enable SSL encryption for an instance of SQL Server by using Microsoft Management Console](https://support.microsoft.com/en-us/help/316898/how-to-enable-ssl-encryption-for-an-instance-of-sql-server-by-using-microsoft-management-console) to configure SSL on SQL Server.\n5. For each node of the cluster, follow these steps. Make sure that you make the changes on the non-active node and fail over to it after changes are made.\n\n    1. Import the certificate into LocalMachine\\\\My.\n    2. Grant certificate permissions to the service account that is used to run SQL service. In Microsoft Management Console (MMC), right-click the certificate (certlm.msc), and then click **Tasks** \\> **Manage Private Keys**.\n    3. Add the certificate thumbprint to HKEY\\_LOCAL\\_MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Microsoft SQL Server\\\\*MSSQL.x*\\\\MSSQLServer\\\\SuperSocketNetLib\\\\Certificate.\n    4. In Microsoft SQL Server Configuration Manager, set **ForceEncryption** to **Yes**.\n\n6. Export the public key of the certificate (the .cer file), and install it in the trusted root of each Service Fabric node.\n\n### Configure the OrchestratorData database\n\n1.  Create an empty database, and name it **OrchestratorData**. This database is used by the on-premises local agent to orchestrate deployments.\n2.  Grant the local agent gMSA (svc-LocalAgent$) **db\\_owner** permissions on the database:\n\n    1. In the tree, expand the server name, expand **Security** \\> **Logins**, and then right-click, and click **New Login**.\n\n        ![New Login command](./media/OPSetup_01_NewLogin.png)\n\n\n    2. Look up the **svc-LocalAgent$** service account. Click **Locations**, and select **Entire Directory**, and then click **Object Types**, and select **Service Account**.\n\n        ![Select User, Service Account, or Group dialog box](./media/OPSetup_02_SelectUserServiceAccountOrGroupDialogBox.png)\n\n    3. Set **Assign ServerRole** to **Public**.\n    4. Assign the **db\\_owner** database role permission to the OrchestratorData database.\n\n### Configure the Finance and Operations database\n\n1. In LCS, download and then restore the AxBootstrapDB\\_DemoData.bak database.\n2. Rename the database **AXDBRAIN**.\n3. Run the following queries on the restored database.\n\n    ```\n    ALTER DATABASE AXDBRAIN\n    SET READ_COMMITTED_SNAPSHOT ON\n    GO\n    \n    ALTER DATABASE AXDBRAIN\n    SET ALLOW_SNAPSHOT_ISOLATION ON\n    GO\n    ```\n\n4. Update the database files:\n\n    1. Right-click the database, and then click **Properties**.\n    2. Click **Files** to change the database file properties.\n    3. In the **Initial Size (MB)** field, enter a value that is more than 5,120.\n\n        ![Database Properties dialog box](./media/OPSetup_03_DatabasePropertiesDialogBox.png)\n\n    4. For **AXDBBuild\\_Data**, set the **Autogrowth/Maximize** field to **200** megabytes (MB).\n    5. For **AXDBBuild\\_Log**, set the **Autogrowth/Maximize** field to **500** MB.\n\n        ![Change Autogrowth dialog box](./media/OPSetup_04_ChangeAutogrowthDialogBox.png)\n\n5. Create a new user that has SQL authentication enabled (axdbadmin).\n6. Use the information in the following table to map the users and database roles.\n\n    | User             | Type    | Database role |\n    |------------------|---------|---------------|\n    | svc-AXSF$        | gMSA    | db\\_owner     |\n    | svc-LocalAgent$  | gMSA    | db\\_owner     |\n    | svc-FRPS$        | gMSA    | db\\_owner     |\n    | svc-FRAS$        | gMSA    | db\\_owner     |\n    | axdbadmin        | SqlUser | db\\_owner     |\n\n7. Give the svc-AXSF$ user and the axdbadmin SQL user access to the following roles in the tempdb database:\n\n    - db\\_datareader\n    - db\\_datawriter\n    - db\\_ddladmin\n\n8. In Management Studio, run the following Transact SQL (T-SQL) commands:\n\n    ```\n    GRANT VIEW SERVER STATE TO axdbadmin\n    GRANT VIEW SERVER STATE TO [contososqlao\\svc-AXSF$]\n    ```\n\n### Configure the Financial Reporting database\n\n1.  Create an empty database, and name it **FinancialReporting**.\n2.  Use the information in the following table to map the users and database roles.\n\n    | User             | Type | Database role |\n    |------------------|------|---------------|\n    | svc-LocalAgent$  | gMSA | db\\_owner     |\n    | svc-FRPS$        | gMSA | db\\_owner     |\n    | svc-FRAS$        | gMSA | db\\_owner     |\n\n### Encrypt credentials\n\n1. On any client machine, install the encipherment certificate in the LocalMachine\\\\My certificate store.\n2. Grant the current user read access to the private key of this certificate.\n3. Create the Credentials.json file as shown here.\n\n    ```\n    {\n        \"AosPrincipal\": {\n            \"AccountPassword\": \"<encryptedDomainUserPassword>\"\n        },\n        \"AosSqlAuth\": {\n            \"SqlUser\": \"<encryptedSqlUser>\",\n            \"SqlPwd\": \"<encryptedSqlPassword>\"\n        }\n    }\n    ```\n\n    - **AccountPassword** is the encrypted domain user password for the AOS domain user (contoso\\\\axserviceuser).\n    - **SqlUser** is the encrypted SQL user (axdbadmin) that has access to the Finance and Operations database (AXDBRAIN), and **SqlPassword** is the encrypted SQL password.\n\n4. Copy the .json file to the SMB file share, \\\\\\\\AX7SQLAOFILE1\\\\agent\\\\Credentials\\\\Credentials.json.\n5. Update the Credentials.json file with encrypted values.\n\n    ```\n    # Service fabric API to encrypt text and copy it to the clipboard.\n    Invoke-ServiceFabricEncryptText -Text '<textToEncrypt>' -CertThumbprint '<DataEncipherment Thumbprint>' -CertStore -StoreLocation LocalMachine -StoreName My | clip\n    ```\n\n    1. In Credentials.json, replace **\\<encryptedDomainUserPassword\\>** with the encrypted domain password.\n    2. Replace **\\<encryptedSqlUser\\>** with the encrypted Finance and Operations SQL user.\n    3. Replace **\\<encryptedSqlPassword\\>** with the Finance and Operations SQL password.\n    \n### Set up SSRS\n\n1.  Before you begin, make sure that the prerequisites that are listed at the beginning of this topic are installed.\n2.  Follow the steps to [Configure SQL Server Reporting Services for an on-premises deployment](../analytics/configure-ssrs-on-premises.md).\n\n### Configure AD FS\n\nBefore you can complete this procedure, AD FS must be deployed on Windows Server 2016. For information about how to deploy AD FS, see [Deployment Guide Windows Server 2016 and 2012 R2 AD FS Deployment Guide](https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/deployment/windows-server-2012-r2-ad-fs-deployment-guide).\n\nFinance and Operations requires additional configuration beyond the default out-of-box configuration of AD FS. For the following steps, Windows PowerShell runs on a machine that has the AD FS role service installed. The user account must have enough permissions to administer AD FS. For example, the user must have a domain administrator account.\n\n1. Configure the AD FS identifier so that it matches the AD FS token issuer.\n\n    ```\n    $adfsProperties = Get-AdfsProperties\n    Set-AdfsProperties -Identifier $adfsProperties.IdTokenIssuer\n    ```\n\n2. You should disable Windows Integrated Authentication (WIA) for intranet authentication connections unless you've configured AD FS for mixed environments. For more information about how to configure WIA so that it can be used with AD FS, see [Configure browsers to use Windows Integrated Authentication (WIA) with AD FS](https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/operations/configure-ad-fs-browser-wia).\n\n   ```\n   Set-AdfsGlobalAuthenticationPolicy -PrimaryIntranetAuthenticationProvider FormsAuthentication, MicrosoftPassportAuthentication\n   ```\n\n3. For sign-in, the user's email address must be an acceptable authentication input.\n\n   ```\n   Add-Type -AssemblyName System.Net\n   $fdqn = ([System.Net.Dns]::GetHostEntry('localhost').HostName).ToLower()\n   $domainName = $fdqn.Substring($fdqn.IndexOf('.')+1)\n   Set-AdfsClaimsProviderTrust -TargetIdentifier 'AD AUTHORITY' -AlternateLoginID mail -LookupForests $domainName\n   ```\n\nIn order for AD FS to trust Finance and Operations for the exchange of authentication, various application entries must be registered in AD FS under an AD FS application group. To speed up setup process and help reduce errors, you can use the following script for registration. Copy the Publish-ADFSApplicationGroup.ps1 script and D365FO-OP directory to a machine that has the AD FS role service installed. Then run the script by using a user account, such as an administrator account, that has enough permissions to administer AD FS. For more information about how to use the script, see the documentation that is listed in the script. Make a note of the client IDs that are specified in the output, because you will be asked for this information in LCS in a later step.\n\n```\n# Host URL is your DNS record\\host name for accessing the AOS\n.\\Publish-ADFSApplicationGroup.ps1 -HostUrl 'ax.d365ffo.onprem.contoso.com'\n```\n\nThe AD FS management console should resemble the following illustration. To open Server Manager, click **Tools** \\> **AD FS Management**, and then, at the bottom of the tree view on the left, click **Application Groups**. Double-click the application group to view more details.\n\n![Application group properties](./media/OPSetup_05_ApplicatioGroupProperties.png)\n\nFinally, for a sanity check, make sure that you can access the AD FS OpenID Configuration URL on a Service Fabric node of the **AOSNodeType** type by going to `https://<adfs-dns-name>/adfs/.well-known/openid-configuration` in a web browser. If you receive a message that states that the site isn't secure, you haven't added your AD FS SSL certificate to the Trusted Root Certification Authorities store. This step is described in the AD FS deployment guide. If you successfully access the URL, a JavaScript Object Notation (JSON) file is returned that contains your AD FS configuration, and you will see that your AD FS URL is trusted.\n\nWith this the setup of infrastructure is complete. The following sections describe how to navigate to [LCS](https://lcs.dynamics.com) to set up your connector and deploy your Dynamics 365 for Finance and Operations environment.\n\n## Configure connector and install on-premises local agent\n\n1. Sign in to [LCS](https://lcs.dynamics.com/) and open the on-premises implementation project.\n2. On the hamburger menu, click **Project settings**.\n\n    ![Project settings command](./media/OPSetup_06_ProjectSettings.png)\n\n3. Click **On-premises connectors**.\n4. Click **Add** to create a new connector.\n5. On the **Setup host infrastructure** tab, download the agent installer.\n\n    ![Download agent installer button on the Setup host infrastructure tab](./media/OPSetup_07_DownloadAgentInstaller.png)\n\n6. Verify that the zip file is unblocked. Right-click the file, click **Properties**, and then select **Unblock**.\n7. Unzip the agent installer on one of the Service fabric nodes of the **OrchestratorType** type.\n8. On the **Configure agent** tab, enter the configuration settings.\n9. Save the configuration, and then click **Download configurations** to download the localagent-config.json configuration file.\n\n    ![Download configurations button on the Configure agent tab](./media/OPSetup_08_DownloadConfigurations.png)\n\n10. Copy the localagent-config.json file to the machine where the agent installer package is located.\n11. In a Command Prompt window, run the following command by navigating to the folder that contains the agent installer.\n\n    ```\n    LocalAgentCLI.exe Install <path to config.json>\n    ```\n\n    > [!NOTE]\n    > The user who runs this command must have **db\\_owner** permissions on the OrchestratorData database.\n    \n12. Once the local agent is installed successfully navigate back to your on-premises connector in LCS.\n13. On the **Validate setup** tab click on **Message agent** button. This will test for LCS connectivity to your local agent. When connection is established successfully the page will look like the graphic below.\n\n     ![Validate agent](./media/ValidateAgent.PNG)\n\n## Deploy your Dynamics 365 for Finance and Operations (on-premises) environment\n\n1. Navigate to your on-premises project in LCS, go to **Environment**, **Sandbox** and click on **Configure**\n2. Select your **Environment topology** and go through the wizard to intitiate your deployment.\n3. The local agent will pick up the deployment request, kick off the deployment and communicate back to LCS when ready.\n","nodes":[{"pos":[4,660],"content":"# required metadata\n\ntitle: Set up and deploy on-premises environments\ndescription: This topic provides information about how to plan, set up, and deploy an on-premises environment.\nauthor: kfend\nmanager: AnnBe\nms.date: 06/14/2017\nms.topic: article\nms.prod: \nms.service: dynamics-ax-platform\nms.technology: \n\n# optional metadata\n\n# ms.search.form: \n# ROBOTS: \naudience: Application User, Developer, IT Pro\n# ms.devlang: \n# ms.reviewer: 71\nms.search.scope: Core\n# ms.tgt_pltfrm: \nms.custom: 55651\nms.assetid: \nms.search.region: Global\n# ms.search.industry: \nms.author: sarvanisathish\nms.search.validFrom: 2016-08-30\nms.dyn365.ops.version: Platform update 8\n","nodes":[{"content":"Set up and deploy on-premises environments","nodes":[{"pos":[0,42],"content":"Set up and deploy on-premises environments","nodes":[{"content":"Set up and deploy on-premises environments","pos":[0,42]}]}],"path":["title"]},{"content":"This topic provides information about how to plan, set up, and deploy an on-premises environment.","nodes":[{"pos":[0,97],"content":"This topic provides information about how to plan, set up, and deploy an on-premises environment.","nodes":[{"content":"This topic provides information about how to plan, set up, and deploy an on-premises environment.","pos":[0,97]}]}],"path":["description"]}],"header":"# required metadata\n","yml":true},{"pos":[668,710],"content":"Set up and deploy on-premises environments","linkify":"Set up and deploy on-premises environments","nodes":[{"content":"Set up and deploy on-premises environments","pos":[0,42]}]},{"content":"This document describes how to plan your deployment, set up the infrastructure, and deploy Microsoft Dynamics 365 for Finance and Operations, Enterprise edition (on-premises).","pos":[712,887]},{"pos":[892,925],"content":"Finance and Operations components","linkify":"Finance and Operations components","nodes":[{"content":"Finance and Operations components","pos":[0,33]}]},{"content":"The Finance and Operations application consists of three main components:","pos":[927,1000]},{"content":"Application Object Server (AOS)","pos":[1004,1035]},{"content":"Business Intelligence (BI)","pos":[1038,1064]},{"content":"Financial Reporting/Management Reporter","pos":[1067,1106]},{"content":"These components depend on the following system software:","pos":[1108,1165]},{"content":"Microsoft Windows Server 2016","pos":[1169,1198]},{"content":"Microsoft SQL Server 2016 SP1, which has following features:","pos":[1201,1261]},{"content":"Full-text index search is enabled.","pos":[1269,1303]},{"content":"SQL Server Reporting Services (SSRS).","pos":[1310,1347]},{"content":"SQL Server Integration Services (SSIS).","pos":[1354,1393]},{"pos":[1406,1485],"content":"[!NOTE]\nThe application will not run if Full Text Search is not enabled.","leadings":["","     > "],"nodes":[{"content":"The application will not run if Full Text Search is not enabled.","pos":[8,72]}]},{"content":"SQL Server Management Studio","pos":[1489,1517]},{"content":"Standalone Microsoft Azure Service Fabric","pos":[1520,1561]},{"content":"Windows PowerShell 5.0 or later","pos":[1564,1595]},{"content":"Active Directory Federation Services (AD FS) on Windows Server 2016","pos":[1598,1665]},{"content":"The domain controller must be Windows Server 2012 R2 or later with a domain functional level of 2012 R2, or greater","pos":[1669,1784]},{"content":"For more information about domain functional levels, see:","pos":[1788,1845]},{"pos":[1851,1964],"content":"<bpt id=\"p1\">[</bpt>What Are Active Directory Functional Levels<ept id=\"p1\">](https://technet.microsoft.com/en-us/library/cc787290(v=ws.10).aspx)</ept>","source":"[What Are Active Directory Functional Levels](https://technet.microsoft.com/en-us/library/cc787290(v=ws.10).aspx)"},{"pos":[1969,2143],"content":"<bpt id=\"p1\">[</bpt>Understanding Active Directory Domain Services Functional Levels<ept id=\"p1\">](https://technet.microsoft.com/en-us/library/understanding-active-directory-functional-levels(v=ws.10).aspx)</ept>","source":"[Understanding Active Directory Domain Services Functional Levels](https://technet.microsoft.com/en-us/library/understanding-active-directory-functional-levels(v=ws.10).aspx)"},{"pos":[2149,2167],"content":"Lifecycle Services","linkify":"Lifecycle Services","nodes":[{"content":"Lifecycle Services","pos":[0,18]}]},{"content":"Finance and Operations bits are distributed through Microsoft Dynamics Lifecycle Services (LCS).","pos":[2169,2265]},{"content":"Before you can deploy, you must purchase license keys through the <bpt id=\"p1\">[</bpt>Enterprise Agreements<ept id=\"p1\">](https://www.microsoft.com/en-us/Licensing/licensing-programs/enterprise.aspx)</ept> channel and set up an on-premises project in LCS.","pos":[2266,2483],"source":" Before you can deploy, you must purchase license keys through the [Enterprise Agreements](https://www.microsoft.com/en-us/Licensing/licensing-programs/enterprise.aspx) channel and set up an on-premises project in LCS."},{"content":"Deployments can be initiated only through LCS.","pos":[2484,2530]},{"content":"For more information about how to set up on-premises projects in LCS, see <bpt id=\"p1\">[</bpt>Create an on-premises project in Lifecycle Services<ept id=\"p1\">](../lifecycle-services/lbd-create-lcs-on-prem-project.md)</ept>.","pos":[2531,2716],"source":" For more information about how to set up on-premises projects in LCS, see [Create an on-premises project in Lifecycle Services](../lifecycle-services/lbd-create-lcs-on-prem-project.md)."},{"pos":[2721,2735],"content":"Authentication","linkify":"Authentication","nodes":[{"content":"Authentication","pos":[0,14]}]},{"content":"The on-premises application works with AD FS.","pos":[2737,2782]},{"content":"To interact with LCS, you must also configure Azure Active Directory (Azure AD).","pos":[2783,2863]},{"pos":[2868,2893],"content":"Standalone Service Fabric","linkify":"Standalone Service Fabric","nodes":[{"content":"Standalone Service Fabric","pos":[0,25]}]},{"content":"Finance and Operations uses Standalone Service Fabric.","pos":[2895,2949]},{"content":"For more information, see the <bpt id=\"p1\">[</bpt>Service Fabric documentation<ept id=\"p1\">](/azure/service-fabric/)</ept>.","pos":[2950,3035],"source":" For more information, see the [Service Fabric documentation](/azure/service-fabric/)."},{"pos":[3040,3054],"content":"Infrastructure","linkify":"Infrastructure","nodes":[{"content":"Infrastructure","pos":[0,14]}]},{"content":"Finance and Operations is designed to work on a hyper-converged architecture.","pos":[3056,3133]},{"content":"The hardware configuration includes the following components:","pos":[3134,3195]},{"content":"Standalone Service Fabric cluster that is based on Windows Server 2016 virtual machines (VMs)","pos":[3199,3292]},{"content":"SQL Server (both Clustered SQL and Always-On are supported)","pos":[3295,3354]},{"content":"AD FS for authentication","pos":[3357,3381]},{"content":"Server Message Block (SMB) version 3 file share for storage","pos":[3384,3443]},{"content":"Optional: Microsoft Office Server 2017","pos":[3446,3484]},{"pos":[3486,3595],"content":"For more information, see <bpt id=\"p1\">[</bpt>System requirements<ept id=\"p1\">](../get-started/system-requirements.md)</ept> and Sizing guidelines.","source":"For more information, see [System requirements](../get-started/system-requirements.md) and Sizing guidelines."},{"pos":[3601,3616],"content":"Hardware layout","linkify":"Hardware layout","nodes":[{"content":"Hardware layout","pos":[0,15]}]},{"content":"Plan your infrastructure and Service Fabric cluster, based on the recommended sizing in <bpt id=\"p1\">[</bpt>Hardware sizing for on-premises environments<ept id=\"p1\">](../get-started/hardware-sizing-on-premises-environments.md)</ept>.","pos":[3618,3813],"source":"Plan your infrastructure and Service Fabric cluster, based on the recommended sizing in [Hardware sizing for on-premises environments](../get-started/hardware-sizing-on-premises-environments.md)."},{"content":"For more information about how to plan the Service Fabric cluster, see <bpt id=\"p1\">[</bpt>Plan and prepare your Service Fabric standalone cluster deployment<ept id=\"p1\">](/azure/service-fabric/service-fabric-cluster-standalone-deployment-preparation)</ept>.","pos":[3814,4034],"source":" For more information about how to plan the Service Fabric cluster, see [Plan and prepare your Service Fabric standalone cluster deployment](/azure/service-fabric/service-fabric-cluster-standalone-deployment-preparation)."},{"content":"The following table shows an example of the hardware layout.","pos":[4036,4096]},{"content":"This example is used throughout this topic to illustrate the setup.","pos":[4097,4164]},{"pos":[4168,4334],"content":"[!NOTE]\nThe Primary node of the Service Fabric cluster must have at least three nodes. In this example, **OrchestratorType** is designated as the Primary node type.","leadings":["","> "],"nodes":[{"content":"The Primary node of the Service Fabric cluster must have at least three nodes. In this example, **OrchestratorType** is designated as the Primary node type.","pos":[8,164],"nodes":[{"content":"The Primary node of the Service Fabric cluster must have at least three nodes.","pos":[0,78]},{"content":"In this example, <bpt id=\"p1\">**</bpt>OrchestratorType<ept id=\"p1\">**</ept> is designated as the Primary node type.","pos":[79,156],"source":" In this example, **OrchestratorType** is designated as the Primary node type."}]}]},{"content":"Machine purpose","pos":[4338,4353]},{"content":"Machine name","pos":[4388,4400]},{"content":"IP address","pos":[4406,4416]},{"content":"Domain controller","pos":[4510,4527]},{"content":"DAX7SQLAODC1","pos":[4560,4572]},{"content":"10.179.108.2","pos":[4578,4590]},{"content":"AD FS","pos":[4596,4601]},{"content":"DAX7SQLAOADFS1","pos":[4646,4660]},{"content":"10.179.108.3","pos":[4664,4676]},{"content":"File server","pos":[4682,4693]},{"content":"DAX7SQLAOFILE1","pos":[4732,4746]},{"content":"10.179.108.4","pos":[4750,4762]},{"content":"SQL Always-On cluster","pos":[4768,4789]},{"content":"DAX7SQLAOSQLA01","pos":[4818,4833]},{"content":"10.179.108.5","pos":[4836,4848]},{"content":"DAX7SQLAOSQLA02","pos":[4904,4919]},{"content":"10.179.108.6","pos":[4922,4934]},{"content":"DAX7SQLAOSQLA","pos":[4990,5003]},{"content":"10.179.108.9","pos":[5008,5020]},{"content":"Client","pos":[5026,5032]},{"content":"SQLAOCLIENT1","pos":[5076,5088]},{"content":"10.179.108.11","pos":[5094,5107]},{"content":"Service Fabric cluster/AOS 1","pos":[5112,5140]},{"content":"SQLAOSF1AOS1","pos":[5162,5174]},{"content":"10.179.108.12","pos":[5180,5193]},{"content":"Service Fabric cluster/AOS 2","pos":[5198,5226]},{"content":"SQLAOSF1AOS2","pos":[5248,5260]},{"content":"10.179.108.13","pos":[5266,5279]},{"content":"Service Fabric cluster/AOS 3","pos":[5284,5312]},{"content":"SQLAOSF1AOS3","pos":[5334,5346]},{"content":"10.179.108.14","pos":[5352,5365]},{"content":"Service Fabric cluster/Orchestrator 1","pos":[5370,5407]},{"content":"SQLAOSF1ORCH1","pos":[5420,5433]},{"content":"10.179.108.15","pos":[5438,5451]},{"content":"Service Fabric cluster/Orchestrator 2","pos":[5456,5493]},{"content":"SQLAOSF1ORCH2","pos":[5506,5519]},{"content":"10.179.108.16","pos":[5524,5537]},{"content":"Service Fabric cluster/Orchestrator 3","pos":[5542,5579]},{"content":"SQLAOSF1ORCH3","pos":[5592,5605]},{"content":"10.179.108.17","pos":[5610,5623]},{"content":"Service Fabric cluster/Management Reporter node","pos":[5628,5675]},{"content":"SQLAOSMR1","pos":[5678,5687]},{"content":"10.179.108.18","pos":[5696,5709]},{"content":"Service Fabric cluster/SSRS node","pos":[5714,5746]},{"content":"SQLAOSFBIN1","pos":[5764,5775]},{"content":"10.179.108.10","pos":[5782,5795]},{"pos":[5802,5807],"content":"Setup","linkify":"Setup","nodes":[{"content":"Setup","pos":[0,5]}]},{"pos":[5813,5826],"content":"Prerequisites","linkify":"Prerequisites","nodes":[{"content":"Prerequisites","pos":[0,13]}]},{"content":"Before you start the setup, the following prerequisites must be met.","pos":[5828,5896]},{"content":"The setup of these prerequisites is out of scope for this document.","pos":[5897,5964]},{"content":"Active Directory Domain Services (AD DS) is installed and configured in your network.","pos":[5968,6053]},{"content":"AD FS is deployed.","pos":[6056,6074]},{"content":"SQL Server, SSRS, and Management Studio are installed.","pos":[6077,6131]},{"pos":[6137,6145],"content":"Overview","linkify":"Overview","nodes":[{"content":"Overview","pos":[0,8]}]},{"content":"The following steps must be completed to set up the infrastructure for Finance and Operations.","pos":[6147,6241]},{"content":"Plan your domain name and DNS zones","pos":[6246,6281]},{"content":"Plan and acquire your certificates","pos":[6285,6319]},{"content":"Plan your users and Service accounts","pos":[6323,6359]},{"content":"Create DNS zones and add A records","pos":[6363,6397]},{"content":"Join VMs to the Domain","pos":[6401,6423]},{"content":"Add prerequisite software to VMs","pos":[6427,6459]},{"content":"Download setup scripts from LCS","pos":[6463,6494]},{"content":"Describe your configuration","pos":[6498,6525]},{"content":"Install Certificates","pos":[6529,6549]},{"content":"Set up a standaalone Service Fabric CLuster","pos":[6554,6597]},{"content":"Configure LCS connectivity for the tenant","pos":[6602,6643]},{"content":"Set up File Storage","pos":[6648,6667]},{"content":"Set up SQL Server","pos":[6672,6689]},{"content":"Configure the Databases","pos":[6694,6717]},{"content":"Encrypt credentials","pos":[6722,6741]},{"content":"Set up SSRS","pos":[6746,6757]},{"content":"Configure AD FS","pos":[6762,6777]},{"pos":[6783,6818],"content":"Plan your domain name and DNS zones","linkify":"Plan your domain name and DNS zones","nodes":[{"content":"Plan your domain name and DNS zones","pos":[0,35]}]},{"content":"We recommend that you use a publicly registered domain name for your production installation of AOS.","pos":[6820,6920]},{"content":"In that way, it can be accessed outside the network, if outside access is required.","pos":[6921,7004]},{"content":"For example, if your company's domain is contoso.com, your zone for Finance and Operations (on-premises) might be d365ffo.onprem.contoso.com, and the host names might be as follows:","pos":[7006,7187]},{"content":"ax.d365ffo.onprem.contoso.com for AOS machines","pos":[7191,7237]},{"content":"sf.d365ffo.onprem.contoso.com for the Service Fabric cluster","pos":[7240,7300]},{"pos":[7306,7340],"content":"Plan and acquire your certificates","linkify":"Plan and acquire your certificates","nodes":[{"content":"Plan and acquire your certificates","pos":[0,34]}]},{"content":"Secure Sockets Layer (SSL) certificates are required in order to secure a Service Fabric cluster and all the applications that are deployed.","pos":[7342,7482]},{"content":"For your production and sandbox workloads, we recommend that you acquire certificates from a certificate authority (CA) such as <bpt id=\"p1\">[</bpt>DigiCert<ept id=\"p1\">](https://www.digicert.com/ssl-certificate/)</ept>, <bpt id=\"p2\">[</bpt>Comodo<ept id=\"p2\">](https://ssl.comodo.com/)</ept>, <bpt id=\"p3\">[</bpt>Symantec<ept id=\"p3\">](https://www.websecurity.symantec.com/ssl-certificate)</ept>, <bpt id=\"p4\">[</bpt>GoDaddy<ept id=\"p4\">](https://www.godaddy.com/web-security/ssl-certificate)</ept>, or <bpt id=\"p5\">[</bpt>GlobalSign<ept id=\"p5\">](https://www.globalsign.com/en/ssl/)</ept>.","pos":[7483,7884],"source":" For your production and sandbox workloads, we recommend that you acquire certificates from a certificate authority (CA) such as [DigiCert](https://www.digicert.com/ssl-certificate/), [Comodo](https://ssl.comodo.com/), [Symantec](https://www.websecurity.symantec.com/ssl-certificate), [GoDaddy](https://www.godaddy.com/web-security/ssl-certificate), or [GlobalSign](https://www.globalsign.com/en/ssl/)."},{"content":"If your domain is set up with <bpt id=\"p1\">[</bpt>Active Directory Certificate Services<ept id=\"p1\">](https://technet.microsoft.com/en-us/library/cc772393(v=ws.10).aspx)</ept> (AD CS), you can create the certificates through AD CS.","pos":[7885,8078],"source":" If your domain is set up with [Active Directory Certificate Services](https://technet.microsoft.com/en-us/library/cc772393(v=ws.10).aspx) (AD CS), you can create the certificates through AD CS."},{"content":"Each certificate must contain a private key that was created for key exchange, and it must be exportable to a Personal Information Exchange (.pfx) file.","pos":[8079,8231]},{"content":"Self-signed certificates can be used only for testing purposes.","pos":[8233,8296]},{"content":"For convenience, the setup scripts include scripts that generate and export self-signed certificates.","pos":[8297,8398]},{"content":"As we've mentioned, these certificates must be used for testing purposes only.","pos":[8399,8477]},{"content":"Purpose","pos":[8481,8488]},{"content":"Explanation","pos":[8528,8539]},{"content":"Additional requirements","pos":[8542,8565]},{"content":"SQL Server SSL certificate","pos":[8659,8685]},{"content":"This certificate is used to encrypt data that is transmitted across a network between an instance of SQL Server and a client application.","pos":[8706,8843]},{"content":"The domain name of the certificate should match the fully qualified domain name (FQDN) of the SQL Server instance or listener.","pos":[8849,8975]},{"content":"For example, if the SQL listener is hosted on the machine DAX7SQLAOSQLA, the certificate's DNS name is DAX7SQLAOSQLA.onprem.contoso.com.","pos":[8982,9118]},{"content":"Service Fabric Server certificate","pos":[9127,9160]},{"content":"This certificate is used to help secure the node-to-node communication between the Service Fabric nodes.","pos":[9174,9278]},{"content":"This certificate is also used as the Server certificate that is presented to the client that connects to the cluster.","pos":[9279,9396]},{"content":"The domain name of the certificate must match the DNS zone where AOS and Service Fabric are hosted.","pos":[9402,9501]},{"content":"For example, the domain name of the certificate might be <ph id=\"ph1\">\\*</ph>.onprem.contoso.com or <ph id=\"ph2\">\\*</ph>.contoso.com.","pos":[9508,9605],"source":"For example, the domain name of the certificate might be \\*.onprem.contoso.com or \\*.contoso.com."},{"content":"If you use a wildcard certificate, the wildcard character applies to only one level.","pos":[9612,9696]},{"content":"A subdomain, subject alternative name (SAN), must be applied to the certificate if it's more than one level, such as <ph id=\"ph1\">\\*</ph>.contoso.com in the previous example.","pos":[9697,9853],"source":" A subdomain, subject alternative name (SAN), must be applied to the certificate if it's more than one level, such as \\*.contoso.com in the previous example."},{"content":"Service Fabric Client certificate","pos":[9862,9895]},{"content":"This certificate is used by clients to view and manage the Service Fabric cluster.","pos":[9909,9991]},{"content":"Encipherment Certificate","pos":[9998,10022]},{"content":"This certificate is used to encrypt sensitive information such as the SQL Server password and user account passwords.","pos":[10045,10162]},{"content":"The certificate key usage must include Data Encipherment (10) and should not include Server Authentication or Client Authentication.","pos":[10168,10300]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>Managing secrets in Service Fabric applications<ept id=\"p1\">](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-application-secret-management)</ept>.","pos":[10307,10483],"source":"For more information, see [Managing secrets in Service Fabric applications](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-application-secret-management)."},{"content":"AOS SSL Certificate","pos":[10492,10511]},{"content":"This certificate is used as the Server certificate that is presented to the client for the AOS website.","pos":[10542,10645]},{"content":"It's also used to enable Windows Communication Foundation (WCF)/Simple Object Access Protocol (SOAP) certificates.","pos":[10646,10760]},{"content":"The Service Fabric Server certificate can be used here if it's a wildcard certificate.","pos":[10767,10853]},{"content":"The domain name of the certificate must match the DNS zone where AOS and Service fabric are hosted.","pos":[10863,10962]},{"content":"For example, the domain name of the certificate might be <ph id=\"ph1\">\\*</ph>.d365ffo.onprem.contoso.com, <ph id=\"ph2\">\\*</ph>.onprem.contoso.com, or <ph id=\"ph3\">\\*</ph>.contoso.com.","pos":[10969,11098],"source":"For example, the domain name of the certificate might be \\*.d365ffo.onprem.contoso.com, \\*.onprem.contoso.com, or \\*.contoso.com."},{"content":"If you use a wildcard certificate, the wildcard applies to only one level.","pos":[11105,11179]},{"content":"A subdomain, SAN, must be applied to the certificate if it's more than one level, such as <ph id=\"ph1\">\\*</ph>.contoso.com in the previous example.","pos":[11180,11309],"source":" A subdomain, SAN, must be applied to the certificate if it's more than one level, such as \\*.contoso.com in the previous example."},{"content":"Session Authentication certificate","pos":[11318,11352]},{"content":"This certificate is used by AOS to help secure a user's session information.","pos":[11365,11441]},{"pos":[11444,11538],"content":"This is also the <bpt id=\"p1\">**</bpt>File Share<ept id=\"p1\">**</ept> Certificate that will used at the time of deployment from LCS.","source":"This is also the **File Share** Certificate that will used at the time of deployment from LCS."},{"content":"Data Encryption and Data Signing certificate","pos":[11543,11587]},{"content":"These certificates are used by AOS to encrypt sensitive information.","pos":[11590,11658]},{"content":"Financial Reporting client certificate","pos":[11665,11703]},{"content":"This certificate is used to help secure the communication between the Financial Reporting services and AOS.","pos":[11712,11819]},{"content":"Reporting Certificate","pos":[11826,11847]},{"content":"This certificate is used to help secure the communication between SSRS and AOS.","pos":[11873,11952]},{"content":"On-Premise local agent certificate","pos":[11959,11993]},{"content":"This certificate is used to help secure the communication between a local agent that is hosted on-premises and LCS.","pos":[12009,12124]},{"content":"This certificate enables the local agent to act on behalf of your Azure AD tenant, and to communicate with LCS to orchestrate and monitor deployments.","pos":[12131,12281]},{"pos":[12295,12331],"content":"Plan your users and service accounts","linkify":"Plan your users and service accounts","nodes":[{"content":"Plan your users and service accounts","pos":[0,36]}]},{"content":"You must create several user or service accounts for Finance and Operations (on-premises) to work.","pos":[12333,12431]},{"content":"You must create a combination of group managed service accounts (gMSAs), domain accounts, and SQL accounts.","pos":[12432,12539]},{"content":"The following table shows the user accounts, their purpose, and example names that will be used in this topic.","pos":[12540,12650]},{"content":"User account","pos":[12654,12666]},{"content":"Type","pos":[12712,12716]},{"content":"Purpose","pos":[12729,12736]},{"content":"User name","pos":[12739,12748]},{"content":"Financial Reporting Application Service Account","pos":[12852,12899]},{"content":"gMSA","pos":[12910,12914]},{"content":"Contoso<ph id=\"ph1\">\\\\</ph>svc-FRAS$","pos":[12937,12955],"source":"Contoso\\\\svc-FRAS$"},{"content":"Financial Reporting Process Service Account","pos":[12960,13003]},{"content":"gMSA","pos":[13018,13022]},{"content":"Contoso<ph id=\"ph1\">\\\\</ph>svc-FRPS$","pos":[13045,13063],"source":"Contoso\\\\svc-FRPS$"},{"content":"Financial Reporting Click Once Designer Service Account","pos":[13068,13123]},{"content":"gMSA","pos":[13126,13130]},{"content":"Contoso<ph id=\"ph1\">\\\\</ph>svc-FRCO$","pos":[13153,13171],"source":"Contoso\\\\svc-FRCO$"},{"content":"AOS Service Account","pos":[13176,13195]},{"content":"gMSA","pos":[13234,13238]},{"content":"This user should be created for future-proofing.","pos":[13251,13299]},{"content":"We plan to enable AOS to work with the gMSA in upcoming releases.","pos":[13300,13365]},{"content":"By creating this user at the time of setup, you will help guarantee a seamless transition to the gMSA.","pos":[13366,13468]},{"content":"Contoso<ph id=\"ph1\">\\\\</ph>svc-AXSF$","pos":[13471,13489],"source":"Contoso\\\\svc-AXSF$"},{"content":"AOS Service Account","pos":[13494,13513]},{"content":"Domain account","pos":[13552,13566]},{"content":"AOS uses this user in the GA release.","pos":[13569,13606]},{"content":"Contoso<ph id=\"ph1\">\\\\</ph>AXServiceUser","pos":[13609,13631],"source":"Contoso\\\\AXServiceUser"},{"content":"AOS SQL DB Admin user","pos":[13636,13657]},{"content":"SQL user","pos":[13694,13702]},{"content":"Finance and Operations uses this user to authenticate with SQL<ph id=\"ph1\">\\*</ph>.","pos":[13711,13776],"source":"Finance and Operations uses this user to authenticate with SQL\\*."},{"content":"This user will also be replaced by the gMSA user in upcoming releases.","pos":[13777,13847]},{"content":"AXDBAdmin","pos":[13850,13859]},{"content":"Local Deployment Agent Service Account","pos":[13864,13902]},{"content":"gMSA","pos":[13922,13926]},{"content":"This account is used by the local agent to orchestrate the deployment on various nodes.","pos":[13939,14026]},{"content":"Contoso<ph id=\"ph1\">\\\\</ph>Svc-LocalAgent$","pos":[14029,14053],"source":"Contoso\\\\Svc-LocalAgent$"},{"content":"<ph id=\"ph1\">\\*</ph> The SQL user name and password for SQL authentication are secured, because they are encrypted and stored in the file share.","pos":[14057,14183],"source":"\\* The SQL user name and password for SQL authentication are secured, because they are encrypted and stored in the file share."},{"pos":[14189,14223],"content":"Create DNS zones and add A records","linkify":"Create DNS zones and add A records","nodes":[{"content":"Create DNS zones and add A records","pos":[0,34]}]},{"content":"DNS is integrated with AD DS, and lets you organize, manage, and find resources in a network.","pos":[14225,14318]},{"content":"Create a DNS forward lookup zone and A records for the AOS host name and the Service Fabric cluster.","pos":[14319,14419]},{"content":"In this example setup, the DNS zone name is d365ffo.onprem.contoso.com, and the A records/host names are as follows:","pos":[14420,14536]},{"pos":[14540,14590],"content":"<bpt id=\"p1\">**</bpt>ax<ept id=\"p1\">**</ept>.d365ffo.onprem.contoso.com for AOS machines","source":"**ax**.d365ffo.onprem.contoso.com for AOS machines"},{"pos":[14593,14657],"content":"<bpt id=\"p1\">**</bpt>sf<ept id=\"p1\">**</ept>.d365ffo.onprem.contoso.com for the Service Fabric cluster","source":"**sf**.d365ffo.onprem.contoso.com for the Service Fabric cluster"},{"pos":[14664,14678],"content":"Add a DNS zone","linkify":"Add a DNS zone","nodes":[{"content":"Add a DNS zone","pos":[0,14]}]},{"content":"Use the following procedure to add a DNS zone.","pos":[14680,14726]},{"pos":[14731,14838],"content":"Sign in to the domain controller machine, click <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept>, and start DNS Manager by typing <bpt id=\"p2\">**</bpt>dnsmgmt.msc<ept id=\"p2\">**</ept>.","source":"Sign in to the domain controller machine, click **Start**, and start DNS Manager by typing **dnsmgmt.msc**."},{"pos":[14842,14922],"content":"Right-click the domain controller name, and then click <bpt id=\"p1\">**</bpt>New Zone<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\&gt;</ph> <bpt id=\"p2\">**</bpt>Next<ept id=\"p2\">**</ept>.","source":"Right-click the domain controller name, and then click **New Zone** \\> **Next**."},{"pos":[14926,14950],"content":"Select <bpt id=\"p1\">**</bpt>Primary Zone<ept id=\"p1\">**</ept>.","source":"Select **Primary Zone**."},{"pos":[14954,15114],"content":"Leave the <bpt id=\"p1\">**</bpt>Store the zone in Active Directory (available only if the DNS Server is a writeable domain controller<ept id=\"p1\">**</ept> check box selected, and then click <bpt id=\"p2\">**</bpt>Next<ept id=\"p2\">**</ept>.","source":"Leave the **Store the zone in Active Directory (available only if the DNS Server is a writeable domain controller** check box selected, and then click **Next**."},{"pos":[15118,15231],"content":"Select <bpt id=\"p1\">**</bpt>To all DNS Servers running on Domain Controllers in this domain: Contoso.com<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Next<ept id=\"p2\">**</ept>.","source":"Select **To all DNS Servers running on Domain Controllers in this domain: Contoso.com**, and then click **Next**."},{"pos":[15235,15291],"content":"Select <bpt id=\"p1\">**</bpt>Forward Lookup Zone<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Next<ept id=\"p2\">**</ept>.","source":"Select **Forward Lookup Zone**, and then click **Next**."},{"content":"Enter the zone name for your setup, and then click <bpt id=\"p1\">**</bpt>Next<ept id=\"p1\">**</ept>.","pos":[15295,15355],"source":"Enter the zone name for your setup, and then click **Next**."},{"content":"For example, enter <bpt id=\"p1\">**</bpt>d365ffo.onprem.contoso.com<ept id=\"p1\">**</ept>.","pos":[15356,15406],"source":" For example, enter **d365ffo.onprem.contoso.com**."},{"pos":[15410,15475],"content":"Select <bpt id=\"p1\">**</bpt>Do not allow dynamic updates<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Next<ept id=\"p2\">**</ept>.","source":"Select **Do not allow dynamic updates**, and then click **Next**."},{"pos":[15482,15508],"content":"Set up an A record for AOS","linkify":"Set up an A record for AOS","nodes":[{"content":"Set up an A record for AOS","pos":[0,26]}]},{"content":"In the new DNS zone, create one A record that is named <bpt id=\"p1\">**</bpt>ax.d365ffo.onprem.contoso.com<ept id=\"p1\">**</ept> for <bpt id=\"p2\">**</bpt>each<ept id=\"p2\">**</ept> Service Fabric cluster node of the <bpt id=\"p3\">**</bpt>AOSNodeType<ept id=\"p3\">**</ept> type.","pos":[15510,15668],"source":"In the new DNS zone, create one A record that is named **ax.d365ffo.onprem.contoso.com** for **each** Service Fabric cluster node of the **AOSNodeType** type."},{"content":"Don't create A records for the other node types.","pos":[15669,15717]},{"pos":[15722,15776],"content":"Right-click the new zone, and then click <bpt id=\"p1\">**</bpt>New Host<ept id=\"p1\">**</ept>.","source":"Right-click the new zone, and then click **New Host**."},{"pos":[15780,15887],"content":"Enter the name and IP address of the Service Fabric node (e.g. 10.179.108.12), and then click <bpt id=\"p1\">**</bpt>Add Host<ept id=\"p1\">**</ept>.","source":"Enter the name and IP address of the Service Fabric node (e.g. 10.179.108.12), and then click **Add Host**."},{"pos":[15894,15933],"content":"Set up an A Record for the orchestrator","linkify":"Set up an A Record for the orchestrator","nodes":[{"content":"Set up an A Record for the orchestrator","pos":[0,39]}]},{"content":"In the new DNS zone, create an A record that is named <bpt id=\"p1\">**</bpt>sf.d365ffo.onprem.contoso.com<ept id=\"p1\">**</ept> for <bpt id=\"p2\">**</bpt>each<ept id=\"p2\">**</ept> Service Fabric cluster node of the <bpt id=\"p3\">**</bpt>OrchestratorType<ept id=\"p3\">**</ept> type.","pos":[15935,16097],"source":"In the new DNS zone, create an A record that is named **sf.d365ffo.onprem.contoso.com** for **each** Service Fabric cluster node of the **OrchestratorType** type."},{"content":"Don't create A records for the other node types.","pos":[16098,16146]},{"pos":[16151,16205],"content":"Right-click the new zone, and then click <bpt id=\"p1\">**</bpt>New Host<ept id=\"p1\">**</ept>.","source":"Right-click the new zone, and then click **New Host**."},{"pos":[16209,16316],"content":"Enter the name and IP address of the Service Fabric node (e.g. 10.179.108.15), and then click <bpt id=\"p1\">**</bpt>Add Host<ept id=\"p1\">**</ept>.","source":"Enter the name and IP address of the Service Fabric node (e.g. 10.179.108.15), and then click **Add Host**."},{"pos":[16323,16345],"content":"Join VMs to the domain","linkify":"Join VMs to the domain","nodes":[{"content":"Join VMs to the domain","pos":[0,22]}]},{"content":"Join each of the VMs to the domain by completing the steps in <bpt id=\"p1\">[</bpt>How to join Windows Server 2016 to an Active Directory domain<ept id=\"p1\">](http://www.tomsitpro.com/articles/join-windows-server-2016-to-ad-domain,2-1063.html)</ept>.","pos":[16347,16558],"source":"Join each of the VMs to the domain by completing the steps in [How to join Windows Server 2016 to an Active Directory domain](http://www.tomsitpro.com/articles/join-windows-server-2016-to-ad-domain,2-1063.html)."},{"content":"Alternatively, use the Windows PowerShell script.","pos":[16559,16608]},{"pos":[16813,16840],"content":"Disable User Access Control","linkify":"Disable User Access Control","nodes":[{"content":"Disable User Access Control","pos":[0,27]}]},{"pos":[16843,16936],"content":"Execute the below script to disable the User Access Control on <bpt id=\"p1\">**</bpt>every<ept id=\"p1\">**</ept> Service Fabric node.","source":"Execute the below script to disable the User Access Control on **every** Service Fabric node."},{"pos":[17424,17484],"content":"<bpt id=\"p1\">**</bpt>Reboot the node after the script completes successfully.<ept id=\"p1\">**</ept>","source":"**Reboot the node after the script completes successfully.**"},{"pos":[17491,17523],"content":"Add prerequisite software to VMs","linkify":"Add prerequisite software to VMs","nodes":[{"content":"Add prerequisite software to VMs","pos":[0,32]}]},{"content":"The following table lists the prerequisite software that must be applied to the machines of each node type.","pos":[17525,17632]},{"pos":[17636,17718],"content":"[!NOTE]\nYou will have to restart your computer after you install the components.","leadings":["","> "],"nodes":[{"content":"You will have to restart your computer after you install the components.","pos":[8,80]}]},{"content":"Node type","pos":[17722,17731]},{"content":"Component","pos":[17734,17743]},{"content":"Command","pos":[17746,17753]},{"content":"AOS","pos":[17794,17797]},{"content":"SNAC – ODBC driver","pos":[17806,17824]},{"pos":[17827,17957],"content":"See <bpt id=\"p1\">[</bpt>Microsoft ODBC Driver 13.1 for SQL Server - Windows + Linux<ept id=\"p1\">](https://www.microsoft.com/en-us/download/details.aspx?id=53339)</ept>.","source":"See [Microsoft ODBC Driver 13.1 for SQL Server - Windows + Linux](https://www.microsoft.com/en-us/download/details.aspx?id=53339)."},{"content":"AOS","pos":[17962,17965]},{"content":"The Microsoft .NET Framework version 2.0–3.5 (CLR 2.0)","pos":[17974,18028]},{"content":"AOS","pos":[18146,18149]},{"content":"The Microsoft .NET Framework version 4.0–4.6 (CLR 4.0)","pos":[18158,18212]},{"content":"AOS","pos":[18367,18370]},{"content":"Internet Information Services (IIS)","pos":[18379,18414]},{"content":"AOS","pos":[18684,18687]},{"content":"Microsoft SQL Server Management Studio 2016","pos":[18696,18739]},{"content":"AOS","pos":[18746,18749]},{"content":"Microsoft Visual C++ Redistributable Packages for Microsoft Visual Studio 2013","pos":[18758,18836]},{"pos":[18839,18964],"content":"See <bpt id=\"p1\">[</bpt>Microsoft Visual C++ Redistributable Packages for Visual Studio 2013<ept id=\"p1\">](https://support.microsoft.com/en-us/help/3179560)</ept>.","source":"See [Microsoft Visual C++ Redistributable Packages for Visual Studio 2013](https://support.microsoft.com/en-us/help/3179560)."},{"content":"AOS","pos":[18969,18972]},{"content":"Microsoft Access Database Engine 2010 Redistributable","pos":[18981,19034]},{"pos":[19037,19160],"content":"See <bpt id=\"p1\">[</bpt>Microsoft Access Database Engine 2010 Redistributable<ept id=\"p1\">](https://www.microsoft.com/en-us/download/details.aspx?id=13255)</ept>","source":"See [Microsoft Access Database Engine 2010 Redistributable](https://www.microsoft.com/en-us/download/details.aspx?id=13255)"},{"content":"BI","pos":[19165,19167]},{"content":"The .NET Framework version 2.0–3.5 (CLR 2.0)","pos":[19177,19221]},{"content":"BI","pos":[19339,19341]},{"content":"The .NET Framework version 4.0–4.6 (CLR 4.0)","pos":[19351,19395]},{"content":"BI","pos":[19550,19552]},{"content":"Microsoft SQL Server 2016 SP1","pos":[19562,19591]},{"content":"BI","pos":[19598,19600]},{"content":"Management Studio 2016","pos":[19610,19632]},{"content":"BI","pos":[19639,19641]},{"pos":[19651,19704],"content":"SQL Server Reporting Services 2016 in <bpt id=\"p1\">**</bpt>Native<ept id=\"p1\">**</ept> mode","source":"SQL Server Reporting Services 2016 in **Native** mode"},{"content":"MR","pos":[19711,19713]},{"content":"The .NET Framework version 2.0–3.5 (CLR 2.0)","pos":[19723,19767]},{"content":"MR","pos":[19885,19887]},{"content":"The .NET Framework version 4.0–4.6 (CLR 4.0)","pos":[19897,19941]},{"content":"MR","pos":[20096,20098]},{"content":"Visual C++ Redistributable Packages for Visual Studio 2013","pos":[20108,20166]},{"pos":[20169,20294],"content":"See <bpt id=\"p1\">[</bpt>Microsoft Visual C++ Redistributable Packages for Visual Studio 2013<ept id=\"p1\">](https://support.microsoft.com/en-us/help/3179560)</ept>.","source":"See [Microsoft Visual C++ Redistributable Packages for Visual Studio 2013](https://support.microsoft.com/en-us/help/3179560)."},{"pos":[20303,20334],"content":"Download setup scripts from LCS","linkify":"Download setup scripts from LCS","nodes":[{"content":"Download setup scripts from LCS","pos":[0,31]}]},{"content":"We have provided several scripts to help improve the setup experience.","pos":[20336,20406]},{"content":"Follow these steps to download the setup scripts from LCS.","pos":[20407,20465]},{"pos":[20470,20517],"content":"Sign in to LCS (<bpt id=\"p1\">&lt;</bpt>https://lcs.dynamics.com/v2<ept id=\"p1\">&gt;</ept>).","source":"Sign in to LCS (<https://lcs.dynamics.com/v2>)."},{"pos":[20521,20579],"content":"On the dashboard, click the <bpt id=\"p1\">**</bpt>Shared asset library<ept id=\"p1\">**</ept> tile.","source":"On the dashboard, click the **Shared asset library** tile."},{"pos":[20583,20635],"content":"Click the <bpt id=\"p1\">**</bpt>Deployment<ept id=\"p1\">**</ept> tab (or the <bpt id=\"p2\">**</bpt>Model<ept id=\"p2\">**</ept> tab).","source":"Click the **Deployment** tab (or the **Model** tab)."},{"pos":[20639,20732],"content":"In the grid, select the <bpt id=\"p1\">**</bpt>Dynamics 365 for Operations - On-premises Deployment scripts<ept id=\"p1\">**</ept> row.","source":"In the grid, select the **Dynamics 365 for Operations - On-premises Deployment scripts** row."},{"pos":[20736,20803],"content":"Click <bpt id=\"p1\">**</bpt>Versions<ept id=\"p1\">**</ept>, and download the latest version of the scripts.","source":"Click **Versions**, and download the latest version of the scripts."},{"pos":[20809,20836],"content":"Describe your configuration","linkify":"Describe your configuration","nodes":[{"content":"Describe your configuration","pos":[0,27]}]},{"content":"This section provides information about the scripts that you must run.","pos":[20838,20908]},{"content":"The scripts are discussed in the order that you must run them in.","pos":[20909,20974]},{"content":"To run the scripts, fill in the template file at $(downloadPath)<ph id=\"ph1\">\\\\</ph>ConfigTemplate.xml.","pos":[20975,21060],"source":" To run the scripts, fill in the template file at $(downloadPath)\\\\ConfigTemplate.xml."},{"content":"The ConfigTemplate.xml file describes the Service Fabric clusters, the certificates that are used to configure them, and the accounts that must be granted access to the relevant certificates.","pos":[21061,21252]},{"content":"In the example that is provided, the values are filled in for the example infrastructure that is described in this topic.","pos":[21253,21374]},{"content":"The template file will be used in the next section.","pos":[21375,21426]},{"pos":[21433,21477],"content":"Create the domain account for a service user","linkify":"Create the domain account for a service user","nodes":[{"content":"Create the domain account for a service user","pos":[0,44]}]},{"content":"Run the following command to create the domain user account, contoso<ph id=\"ph1\">\\\\</ph>AXServiceUser.","pos":[21479,21563],"source":"Run the following command to create the domain user account, contoso\\\\AXServiceUser."},{"pos":[21827,21839],"content":"Create gMSAs","linkify":"Create gMSAs","nodes":[{"content":"Create gMSAs","pos":[0,12]}]},{"pos":[21844,21938],"content":"Change the directory to <bpt id=\"p1\">**</bpt>$(DownloadPath)<ept id=\"p1\">**</ept>, and run the following Windows PowerShell command.","source":"Change the directory to **$(DownloadPath)**, and run the following Windows PowerShell command."},{"pos":[21946,22089],"content":"[!NOTE]\nThis script doesn't create the users. Instead, it prints the commands that must be manually run on the domain controller machine.","leadings":["","    > "],"nodes":[{"content":"This script doesn't create the users. Instead, it prints the commands that must be manually run on the domain controller machine.","pos":[8,137],"nodes":[{"content":"This script doesn't create the users.","pos":[0,37]},{"content":"Instead, it prints the commands that must be manually run on the domain controller machine.","pos":[38,129]}]}]},{"content":"Copy the output of the command into a Windows PowerShell window.","pos":[22242,22306]},{"content":"Make sure that the line breaks are removed, and run the lines on the Active Directory domain controller machine by using elevated privileges (right-click, and then click <bpt id=\"p1\">**</bpt>Run as Administrator<ept id=\"p1\">**</ept>).","pos":[22307,22503],"source":" Make sure that the line breaks are removed, and run the lines on the Active Directory domain controller machine by using elevated privileges (right-click, and then click **Run as Administrator**)."},{"content":"Run the following script on the Active Directory domain controller machine to validate that the accounts have been successfully created.","pos":[22507,22643]},{"content":"Make sure that you run the script after you replace the pattern that matches the naming convention of the service accounts.","pos":[22644,22767]},{"content":"Run the Export-AddGMSAsONVMScript.ps1 script on the client machine.","pos":[23015,23082]},{"content":"This script generates scripts that are run on each Service Fabric VM and adds them to a folder that corresponds to each VM name.","pos":[23083,23211]},{"pos":[23408,23416],"content":"Stop IIS","linkify":"Stop IIS","nodes":[{"content":"Stop IIS","pos":[0,8]}]},{"content":"Use Remote Desktop Protocol (RDP) to connect to each Service Fabric VM, and complete the manual steps in <bpt id=\"p1\">[</bpt>Start or Stop the Web Server (IIS 7)<ept id=\"p1\">](https://technet.microsoft.com/en-us/library/cc732317(v=ws.10).aspx)</ept>.","pos":[23418,23630],"source":"Use Remote Desktop Protocol (RDP) to connect to each Service Fabric VM, and complete the manual steps in [Start or Stop the Web Server (IIS 7)](https://technet.microsoft.com/en-us/library/cc732317(v=ws.10).aspx)."},{"content":"Alternatively, use the following Windows PowerShell script by using RDP to connect to each Service Fabric VM.","pos":[23631,23740]},{"pos":[24317,24426],"content":"<bpt id=\"p1\">_</bpt>IIS feature should be installed but disabled as there are some dependencies to the IIS dlls in the product.<ept id=\"p1\">_</ept>","source":"_IIS feature should be installed but disabled as there are some dependencies to the IIS dlls in the product._"},{"pos":[24432,24452],"content":"Install Certificates","linkify":"Install Certificates","nodes":[{"content":"Install Certificates","pos":[0,20]}]},{"content":"If you acquired the certificates that were listed earlier in this topic from a valid CA, fill in the .pfx file name and thumbprint for the certificates in the ConfigTemplate.xml file.","pos":[24457,24640]},{"content":"Set the <bpt id=\"p1\">**</bpt>generateSelfSignedCert<ept id=\"p1\">**</ept> attribute to <bpt id=\"p2\">**</bpt>False<ept id=\"p2\">**</ept> and the <bpt id=\"p3\">**</bpt>exportable<ept id=\"p3\">**</ept> attribute to <bpt id=\"p4\">**</bpt>False<ept id=\"p4\">**</ept>.","pos":[24641,24745],"source":" Set the **generateSelfSignedCert** attribute to **False** and the **exportable** attribute to **False**."},{"content":"Copy the .pfx files to the $(DownloadPath)<ph id=\"ph1\">\\\\</ph>InfrastructureScripts<ph id=\"ph2\">\\\\</ph>Certs folder.","pos":[24746,24826],"source":" Copy the .pfx files to the $(DownloadPath)\\\\InfrastructureScripts\\\\Certs folder."},{"content":"If you're using self-signed certificates (for testing purposes only), run the following script.","pos":[24830,24925]},{"content":"To create self-signed certificates, in the ConfigTemplate.xml file, make sure that <bpt id=\"p1\">**</bpt>generateSelfSignedCert<ept id=\"p1\">**</ept> is set to <bpt id=\"p2\">**</bpt>True<ept id=\"p2\">**</ept> and <bpt id=\"p3\">**</bpt>exportable<ept id=\"p3\">**</ept> is set to <bpt id=\"p4\">**</bpt>True<ept id=\"p4\">**</ept>.","pos":[24926,25093],"source":" To create self-signed certificates, in the ConfigTemplate.xml file, make sure that **generateSelfSignedCert** is set to **True** and **exportable** is set to **True**."},{"content":"The script will update the XML with the thumbprint for the certificates.","pos":[25094,25166]},{"content":"Export the new certificates with the private key (the .pfx file).","pos":[25416,25481]},{"content":"Use the following script to generate and run the export commands in Windows PowerShell.","pos":[25482,25569]},{"content":"The .pfx files will be put into the Certs folder.","pos":[25570,25619]},{"pos":[25894,26038],"content":"[!NOTE]\nThe certificates must have been installed and must be present in cert:\\\\CurrentUser\\\\My. The certificates must also be exportable.","leadings":["","    > "],"nodes":[{"content":"The certificates must have been installed and must be present in cert:\\\\CurrentUser\\\\My. The certificates must also be exportable.","pos":[8,138],"nodes":[{"content":"The certificates must have been installed and must be present in cert:<ph id=\"ph1\">\\\\</ph>CurrentUser<ph id=\"ph2\">\\\\</ph>My.","pos":[0,88],"source":"The certificates must have been installed and must be present in cert:\\\\CurrentUser\\\\My."},{"content":"The certificates must also be exportable.","pos":[89,130]}]}]},{"content":"If you're using self-signed certificates, skip to the next section.","pos":[26044,26111]},{"content":"You don't have to complete this procedure.","pos":[26112,26154]},{"content":"After you export or copy the .pfx files into the $(DownloadPath)<ph id=\"ph1\">\\\\</ph>InfrastructureScripts<ph id=\"ph2\">\\\\</ph>Certs folder, run the following commands to generate scripts that will be put in the folders that correspond to the VMs.","pos":[26159,26368],"source":"After you export or copy the .pfx files into the $(DownloadPath)\\\\InfrastructureScripts\\\\Certs folder, run the following commands to generate scripts that will be put in the folders that correspond to the VMs."},{"content":"Copy the scripts in each folder to the VMs that correspond to the folder name.","pos":[26790,26868]},{"content":"On each VM, run the following scripts in the order that they appear in.","pos":[26872,26943]},{"pos":[27167,27209],"content":"Set up a standalone Service Fabric cluster","linkify":"Set up a standalone Service Fabric cluster","nodes":[{"content":"Set up a standalone Service Fabric cluster","pos":[0,42]}]},{"content":"Run the following command to generate the ClusterConfig.json file.","pos":[27214,27280]},{"pos":[27364,27911],"content":"For more information, see, <bpt id=\"p1\">[</bpt>Step 1B: Create a multi-machine cluster<ept id=\"p1\">](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-for-windows-server#create-the-cluster)</ept>, <bpt id=\"p2\">[</bpt>Secure a standalone cluster on Windows using X.509 certificates<ept id=\"p2\">](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-windows-cluster-x509-security)</ept>, and <bpt id=\"p3\">[</bpt>Create a standalone cluster running on Windows Server<ept id=\"p3\">](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-for-windows-server#create-the-cluster)</ept>.","source":"For more information, see, [Step 1B: Create a multi-machine cluster](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-for-windows-server#create-the-cluster), [Secure a standalone cluster on Windows using X.509 certificates](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-windows-cluster-x509-security), and [Create a standalone cluster running on Windows Server](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-for-windows-server#create-the-cluster)."},{"content":"Download the <bpt id=\"p1\">[</bpt>Service Fabric standalone installation package<ept id=\"p1\">](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-for-windows-server#download-the-service-fabric-standalone-package)</ept> onto one of your Service Fabric nodes.","pos":[27916,28169],"source":"Download the [Service Fabric standalone installation package](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-for-windows-server#download-the-service-fabric-standalone-package) onto one of your Service Fabric nodes."},{"content":"After the zip file is downloaded, unblock it by right-clicking the zip file and then clicking <bpt id=\"p1\">**</bpt>Properties<ept id=\"p1\">**</ept>.","pos":[28170,28279],"source":" After the zip file is downloaded, unblock it by right-clicking the zip file and then clicking **Properties**."},{"content":"In the dialog box, select the <bpt id=\"p1\">**</bpt>Unblock<ept id=\"p1\">**</ept> check box in the lower right.","pos":[28280,28351],"source":" In the dialog box, select the **Unblock** check box in the lower right."},{"content":"Copy the zip file to one of the nodes in the Service Fabric cluster, and unzip it.","pos":[28355,28437]},{"content":"Run the following commands to create an inbound firewall rule on ports 443 and 445 in all nodes.","pos":[28441,28537]},{"content":"Run the following commands to create an inbound firewall rule on port 80 for the SSRS node only.","pos":[28809,28905]},{"content":"Copy your ClusterConfig.json file to your unzipped install location of standalone Service Fabric.","pos":[29143,29240]},{"content":"Navigate to the unzipped install location in Windows PowerShell by using elevated privileges, and run the following command to test ClusterConfig.","pos":[29244,29390]},{"content":"If the test is successful, run the following command to deploy the cluster.","pos":[29484,29559]},{"content":"After the cluster is created, open the Service Fabric explorer on any client machine to validate the installation:","pos":[29662,29776]},{"content":"Install the Service Fabric client certificate in CurrentUser<ph id=\"ph1\">\\\\</ph>My if it isn't already installed.","pos":[29785,29880],"source":"Install the Service Fabric client certificate in CurrentUser\\\\My if it isn't already installed."},{"pos":[29888,30010],"content":"Go to <bpt id=\"p1\">**</bpt>IE settings<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\&gt;</ph> <bpt id=\"p2\">**</bpt>Compatibility Mode<ept id=\"p2\">**</ept>, and clear the <bpt id=\"p3\">**</bpt>Display Intranet sites in compatibility mode<ept id=\"p3\">**</ept> check box.","source":"Go to **IE settings** \\> **Compatibility Mode**, and clear the **Display Intranet sites in compatibility mode** check box."},{"content":"Go to <ph id=\"ph1\">`https://sf.d365ffo.onprem.contoso.com:19080`</ph>, where sf.d365ffo.onprem.contoso.com is the host name of the Service Fabric cluster that is specified in the zone.","pos":[30018,30184],"source":"Go to `https://sf.d365ffo.onprem.contoso.com:19080`, where sf.d365ffo.onprem.contoso.com is the host name of the Service Fabric cluster that is specified in the zone."},{"content":"If DNS name resolution isn't configured, use the IP address of the machine.","pos":[30185,30260]},{"content":"Select the client certificate.","pos":[30268,30298]},{"content":"The <bpt id=\"p1\">**</bpt>Service Fabric explorer<ept id=\"p1\">**</ept> page appears.","pos":[30299,30344],"source":" The **Service Fabric explorer** page appears."},{"pos":[30350,30391],"content":"Configure LCS connectivity for the tenant","linkify":"Configure LCS connectivity for the tenant","nodes":[{"content":"Configure LCS connectivity for the tenant","pos":[0,41]}]},{"content":"Deployment and servicing of Finance and Operations are orchestrated through LCS by using an on-premises local agent.","pos":[30393,30509]},{"content":"To establish connectivity from LCS to the Finance and Operations tenant, you must configure a certificate that enables the local agent to act on behalf on your Azure AD tenant (for example, Contoso.Onmicrosoft.com).","pos":[30510,30725]},{"content":"Use the on-premises agent certificate that you acquired from a CA or the self-signed certificate that you generated by using scripts.","pos":[30727,30860]},{"content":"Only user accounts that have the Global Administrator directory role can add certificates to authorize LCS.","pos":[30862,30969]},{"content":"By default, the person who signs up for Microsoft Office 365 for your organization will be the global administrator for the directory.","pos":[30970,31104]},{"pos":[31108,31260],"content":"[!NOTE]\nYou must configure the certificate exactly one time per tenant. All on-premises environments can use the same certificate to connect with LCS.","leadings":["","> "],"nodes":[{"content":"You must configure the certificate exactly one time per tenant. All on-premises environments can use the same certificate to connect with LCS.","pos":[8,150],"nodes":[{"content":"You must configure the certificate exactly one time per tenant.","pos":[0,63]},{"content":"All on-premises environments can use the same certificate to connect with LCS.","pos":[64,142]}]}]},{"content":"Download and install the latest version of Azure PowerShell on a client machine.","pos":[31265,31345]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>Install and configure Azure PowerShell<ept id=\"p1\">](https://docs.microsoft.com/en-us/powershell/azure/install-azurerm-ps?view=azurermps-4.1.0&amp;viewFallbackFrom=azurermps-4.0.0)</ept>.","pos":[31346,31537],"source":" For more information, see [Install and configure Azure PowerShell](https://docs.microsoft.com/en-us/powershell/azure/install-azurerm-ps?view=azurermps-4.1.0&viewFallbackFrom=azurermps-4.0.0)."},{"pos":[31541,31672],"content":"Sign in to the <bpt id=\"p1\">[</bpt>customer's Azure portal<ept id=\"p1\">](https://portal.azure.com)</ept> to verify that you have the Global Administrator directory role.","source":"Sign in to the [customer's Azure portal](https://portal.azure.com) to verify that you have the Global Administrator directory role."},{"content":"Run the following script from $(DownloadPath)<ph id=\"ph1\">\\\\</ph>InfrastructureScripts.","pos":[31676,31745],"source":"Run the following script from $(DownloadPath)\\\\InfrastructureScripts."},{"pos":[31866,31885],"content":"Set up file storage","linkify":"Set up file storage","nodes":[{"content":"Set up file storage","pos":[0,19]}]},{"content":"You must set up two highly available SMB 3.0 file shares.","pos":[31887,31944]},{"content":"For information about how to enable SMB 3.0, see<bpt id=\"p1\">[</bpt>SMB Security Enhancements<ept id=\"p1\">](https://technet.microsoft.com/en-us/library/dn551363(v=ws.11).aspx#BKMK_disablesmb1)</ept>.","pos":[31945,32106],"source":" For information about how to enable SMB 3.0, see[SMB Security Enhancements](https://technet.microsoft.com/en-us/library/dn551363(v=ws.11).aspx#BKMK_disablesmb1)."},{"content":"Secure dialect negotiation can't detect or prevent downgrades from SMB 2.0 or 3.0 to SMB 1.0.","pos":[32107,32200],"source":"\nSecure dialect negotiation can't detect or prevent downgrades from SMB 2.0 or 3.0 to SMB 1.0."},{"content":"Because of this, and to take advantage of the full capabilities of SMB encryption, we strongly recommend that you disable the SMB 1.0 server","pos":[32201,32341]},{"pos":[32345,32723],"content":"[!NOTE]\nTo help guarantee that your data is protected while it's at rest in your environment, BitLocker Drive Encryption must be enabled on every machine. For information about how to enable BitLocker, see [BitLocker: How to deploy on Windows Server 2012 and later](https://docs.microsoft.com/en-us/windows/device-security/bitlocker/bitlocker-how-to-deploy-on-windows-server).","leadings":["","> "],"nodes":[{"content":"To help guarantee that your data is protected while it's at rest in your environment, BitLocker Drive Encryption must be enabled on every machine. For information about how to enable BitLocker, see [BitLocker: How to deploy on Windows Server 2012 and later](https://docs.microsoft.com/en-us/windows/device-security/bitlocker/bitlocker-how-to-deploy-on-windows-server).","pos":[8,376],"nodes":[{"content":"To help guarantee that your data is protected while it's at rest in your environment, BitLocker Drive Encryption must be enabled on every machine.","pos":[0,146]},{"content":"For information about how to enable BitLocker, see <bpt id=\"p1\">[</bpt>BitLocker: How to deploy on Windows Server 2012 and later<ept id=\"p1\">](https://docs.microsoft.com/en-us/windows/device-security/bitlocker/bitlocker-how-to-deploy-on-windows-server)</ept>.","pos":[147,368],"source":" For information about how to enable BitLocker, see [BitLocker: How to deploy on Windows Server 2012 and later](https://docs.microsoft.com/en-us/windows/device-security/bitlocker/bitlocker-how-to-deploy-on-windows-server)."}]}]},{"content":"A file share that stores user documents that are uploaded to AOS (for example, <ph id=\"ph1\">\\\\</ph><ph id=\"ph2\">\\\\</ph>DAX7SQLAOFILE1<ph id=\"ph3\">\\\\</ph>aos-storage).","pos":[32727,32839],"source":"A file share that stores user documents that are uploaded to AOS (for example, \\\\\\\\DAX7SQLAOFILE1\\\\aos-storage)."},{"content":"A file share that stores the latest build and configuration files to orchestrate the deployment (for example, <ph id=\"ph1\">\\\\</ph><ph id=\"ph2\">\\\\</ph>DAX7SQLAOFILE1<ph id=\"ph3\">\\\\</ph>agent))","pos":[32842,32979],"source":"A file share that stores the latest build and configuration files to orchestrate the deployment (for example, \\\\\\\\DAX7SQLAOFILE1\\\\agent))"},{"pos":[32987,33134],"content":"[!NOTE]\nKeep this file share path as short as possible to avoid exceeding the maximum path length on the files that will be put in the share.","leadings":["","    > "],"nodes":[{"content":"Keep this file share path as short as possible to avoid exceeding the maximum path length on the files that will be put in the share.","pos":[8,141]}]},{"content":"On the file share machine, run the following command.","pos":[33139,33192]},{"pos":[33308,33361],"content":"Set up the \\\\\\\\DAX7SQLAOFILE1\\\\aos-storage file share","linkify":"Set up the \\\\\\\\DAX7SQLAOFILE1\\\\aos-storage file share","nodes":[{"content":"Set up the <ph id=\"ph1\">\\\\</ph><ph id=\"ph2\">\\\\</ph>DAX7SQLAOFILE1<ph id=\"ph3\">\\\\</ph>aos-storage file share","pos":[0,53],"source":"Set up the \\\\\\\\DAX7SQLAOFILE1\\\\aos-storage file share"}]},{"pos":[33366,33436],"content":"In Server Manager, select <bpt id=\"p1\">**</bpt>File and Storage Services<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\&gt;</ph> <bpt id=\"p2\">**</bpt>Shares<ept id=\"p2\">**</ept>.","source":"In Server Manager, select **File and Storage Services** \\> **Shares**."},{"pos":[33440,33521],"content":"Click <bpt id=\"p1\">**</bpt>Tasks<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\&gt;</ph> <bpt id=\"p2\">**</bpt>New Share<ept id=\"p2\">**</ept> to create a new share with name <bpt id=\"p3\">**</bpt>aos-storage<ept id=\"p3\">**</ept>.","source":"Click **Tasks** \\> **New Share** to create a new share with name **aos-storage**."},{"pos":[33525,33633],"content":"Grant <bpt id=\"p1\">**</bpt>Modify<ept id=\"p1\">**</ept> permissions for each machine in the Service Fabric cluster except <bpt id=\"p2\">**</bpt>OrchestratorNodeType<ept id=\"p2\">**</ept>.","source":"Grant **Modify** permissions for each machine in the Service Fabric cluster except **OrchestratorNodeType**."},{"pos":[33637,33758],"content":"Grant <bpt id=\"p1\">**</bpt>Modify<ept id=\"p1\">**</ept> permissions for the user AOS domain user (contoso<ph id=\"ph1\">\\\\</ph>AXServiceUser) and the gMSA user (contoso<ph id=\"ph2\">\\\\</ph>svc-AXSF).","source":"Grant **Modify** permissions for the user AOS domain user (contoso\\\\AXServiceUser) and the gMSA user (contoso\\\\svc-AXSF)."},{"pos":[33765,33812],"content":"Set up the \\\\\\\\DAX7SQLAOFILE1\\\\agent file share","linkify":"Set up the \\\\\\\\DAX7SQLAOFILE1\\\\agent file share","nodes":[{"content":"Set up the <ph id=\"ph1\">\\\\</ph><ph id=\"ph2\">\\\\</ph>DAX7SQLAOFILE1<ph id=\"ph3\">\\\\</ph>agent file share","pos":[0,47],"source":"Set up the \\\\\\\\DAX7SQLAOFILE1\\\\agent file share"}]},{"pos":[33817,33895],"content":"Go back to Server Manager, select <bpt id=\"p1\">**</bpt>File and Storage Services<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\&gt;</ph> <bpt id=\"p2\">**</bpt>Shares<ept id=\"p2\">**</ept>.","source":"Go back to Server Manager, select **File and Storage Services** \\> **Shares**."},{"pos":[33899,33974],"content":"Click <bpt id=\"p1\">**</bpt>Tasks<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\&gt;</ph> <bpt id=\"p2\">**</bpt>New Share<ept id=\"p2\">**</ept> to create a new share with name <bpt id=\"p3\">**</bpt>agent<ept id=\"p3\">**</ept>.","source":"Click **Tasks** \\> **New Share** to create a new share with name **agent**."},{"pos":[33978,34088],"content":"Grant <bpt id=\"p1\">**</bpt>Full-Control<ept id=\"p1\">**</ept> permissions to the gMSA user for the local deployment agent (contoso<ph id=\"ph1\">\\\\</ph>svc-LocalAgent$).","source":"Grant **Full-Control** permissions to the gMSA user for the local deployment agent (contoso\\\\svc-LocalAgent$)."},{"pos":[34094,34111],"content":"Set up SQL Server","linkify":"Set up SQL Server","nodes":[{"content":"Set up SQL Server","pos":[0,17]}]},{"content":"Install SQL Server 2016 SP1 with high availability, either as SQL clusters that include a Storage Area Network (SAN) or in an Always-On configuration.","pos":[34116,34266]},{"content":"Verify that the <bpt id=\"p1\">**</bpt>Database Engine, Reporting Services, Full Text Search<ept id=\"p1\">**</ept>, and <bpt id=\"p2\">**</bpt>Management Tools<ept id=\"p2\">**</ept> are already installed.","pos":[34268,34390],"source":"  Verify that the **Database Engine, Reporting Services, Full Text Search**, and **Management Tools** are already installed."},{"pos":[34393,34936],"content":"[!NOTE]\nPlease ensure that the SQL Always On is setup according to [Select Initial Data Synchronization Page (Always On Availability Group Wizards)](https://docs.microsoft.com/en-us/sql/database-engine/availability-groups/windows/select-initial-data-synchronization-page-always-on-availability-group-wizards) and follow [To Prepare Secondary Databases Manually](https://docs.microsoft.com/en-us/sql/database-engine/availability-groups/windows/select-initial-data-synchronization-page-always-on-availability-group-wizards#PrepareSecondaryDbs)","leadings":["","> "],"nodes":[{"content":"Please ensure that the SQL Always On is setup according to <bpt id=\"p1\">[</bpt>Select Initial Data Synchronization Page (Always On Availability Group Wizards)<ept id=\"p1\">](https://docs.microsoft.com/en-us/sql/database-engine/availability-groups/windows/select-initial-data-synchronization-page-always-on-availability-group-wizards)</ept> and follow <bpt id=\"p2\">[</bpt>To Prepare Secondary Databases Manually<ept id=\"p2\">](https://docs.microsoft.com/en-us/sql/database-engine/availability-groups/windows/select-initial-data-synchronization-page-always-on-availability-group-wizards#PrepareSecondaryDbs)</ept>","pos":[8,541],"source":"Please ensure that the SQL Always On is setup according to [Select Initial Data Synchronization Page (Always On Availability Group Wizards)](https://docs.microsoft.com/en-us/sql/database-engine/availability-groups/windows/select-initial-data-synchronization-page-always-on-availability-group-wizards) and follow [To Prepare Secondary Databases Manually](https://docs.microsoft.com/en-us/sql/database-engine/availability-groups/windows/select-initial-data-synchronization-page-always-on-availability-group-wizards#PrepareSecondaryDbs)"}]},{"content":"Run the SQL Service as a domain user.","pos":[34940,34977]},{"content":"Get an SSL certificate from a CA to configure Finance and Operations.","pos":[34981,35050]},{"content":"For testing purposes, you can create and use a self-signed certificate.","pos":[35051,35122]},{"pos":[35124,35178],"content":"<bpt id=\"p1\">**</bpt>Self-signed certificate for Clustered SQL instance<ept id=\"p1\">**</ept>","source":"**Self-signed certificate for Clustered SQL instance**"},{"pos":[35414,35468],"content":"<bpt id=\"p1\">**</bpt>Self-signed certificate for Always-On SQL instance<ept id=\"p1\">**</ept>","source":"**Self-signed certificate for Always-On SQL instance**"},{"pos":[35965,36286],"content":"Using the certificate, complete the steps in <bpt id=\"p1\">[</bpt>How to enable SSL encryption for an instance of SQL Server by using Microsoft Management Console<ept id=\"p1\">](https://support.microsoft.com/en-us/help/316898/how-to-enable-ssl-encryption-for-an-instance-of-sql-server-by-using-microsoft-management-console)</ept> to configure SSL on SQL Server.","source":"Using the certificate, complete the steps in [How to enable SSL encryption for an instance of SQL Server by using Microsoft Management Console](https://support.microsoft.com/en-us/help/316898/how-to-enable-ssl-encryption-for-an-instance-of-sql-server-by-using-microsoft-management-console) to configure SSL on SQL Server."},{"content":"For each node of the cluster, follow these steps.","pos":[36290,36339]},{"content":"Make sure that you make the changes on the non-active node and fail over to it after changes are made.","pos":[36340,36442]},{"content":"Import the certificate into LocalMachine<ph id=\"ph1\">\\\\</ph>My.","pos":[36451,36496],"source":"Import the certificate into LocalMachine\\\\My."},{"content":"Grant certificate permissions to the service account that is used to run SQL service.","pos":[36504,36589]},{"content":"In Microsoft Management Console (MMC), right-click the certificate (certlm.msc), and then click <bpt id=\"p1\">**</bpt>Tasks<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\&gt;</ph> <bpt id=\"p2\">**</bpt>Manage Private Keys<ept id=\"p2\">**</ept>.","pos":[36590,36723],"source":" In Microsoft Management Console (MMC), right-click the certificate (certlm.msc), and then click **Tasks** \\> **Manage Private Keys**."},{"pos":[36731,36885],"content":"Add the certificate thumbprint to HKEY<ph id=\"ph1\">\\_</ph>LOCAL<ph id=\"ph2\">\\_</ph>MACHINE<ph id=\"ph3\">\\\\</ph>SOFTWARE<ph id=\"ph4\">\\\\</ph>Microsoft<ph id=\"ph5\">\\\\</ph>Microsoft SQL Server<ph id=\"ph6\">\\\\</ph><bpt id=\"p1\">*</bpt>MSSQL.x<ept id=\"p1\">*</ept><ph id=\"ph7\">\\\\</ph>MSSQLServer<ph id=\"ph8\">\\\\</ph>SuperSocketNetLib<ph id=\"ph9\">\\\\</ph>Certificate.","source":"Add the certificate thumbprint to HKEY\\_LOCAL\\_MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Microsoft SQL Server\\\\*MSSQL.x*\\\\MSSQLServer\\\\SuperSocketNetLib\\\\Certificate."},{"pos":[36893,36975],"content":"In Microsoft SQL Server Configuration Manager, set <bpt id=\"p1\">**</bpt>ForceEncryption<ept id=\"p1\">**</ept> to <bpt id=\"p2\">**</bpt>Yes<ept id=\"p2\">**</ept>.","source":"In Microsoft SQL Server Configuration Manager, set **ForceEncryption** to **Yes**."},{"content":"Export the public key of the certificate (the .cer file), and install it in the trusted root of each Service Fabric node.","pos":[36980,37101]},{"pos":[37107,37146],"content":"Configure the OrchestratorData database","linkify":"Configure the OrchestratorData database","nodes":[{"content":"Configure the OrchestratorData database","pos":[0,39]}]},{"content":"Create an empty database, and name it <bpt id=\"p1\">**</bpt>OrchestratorData<ept id=\"p1\">**</ept>.","pos":[37152,37211],"source":"Create an empty database, and name it **OrchestratorData**."},{"content":"This database is used by the on-premises local agent to orchestrate deployments.","pos":[37212,37292]},{"pos":[37297,37384],"content":"Grant the local agent gMSA (svc-LocalAgent$) <bpt id=\"p1\">**</bpt>db<ph id=\"ph1\">\\_</ph>owner<ept id=\"p1\">**</ept> permissions on the database:","source":"Grant the local agent gMSA (svc-LocalAgent$) **db\\_owner** permissions on the database:"},{"pos":[37393,37511],"content":"In the tree, expand the server name, expand <bpt id=\"p1\">**</bpt>Security<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\&gt;</ph> <bpt id=\"p2\">**</bpt>Logins<ept id=\"p2\">**</ept>, and then right-click, and click <bpt id=\"p3\">**</bpt>New Login<ept id=\"p3\">**</ept>.","source":"In the tree, expand the server name, expand **Security** \\> **Logins**, and then right-click, and click **New Login**."},{"content":"New Login command","pos":[37523,37540]},{"content":"Look up the <bpt id=\"p1\">**</bpt>svc-LocalAgent$<ept id=\"p1\">**</ept> service account.","pos":[37584,37632],"source":"Look up the **svc-LocalAgent$** service account."},{"content":"Click <bpt id=\"p1\">**</bpt>Locations<ept id=\"p1\">**</ept>, and select <bpt id=\"p2\">**</bpt>Entire Directory<ept id=\"p2\">**</ept>, and then click <bpt id=\"p3\">**</bpt>Object Types<ept id=\"p3\">**</ept>, and select <bpt id=\"p4\">**</bpt>Service Account<ept id=\"p4\">**</ept>.","pos":[37633,37751],"source":" Click **Locations**, and select **Entire Directory**, and then click **Object Types**, and select **Service Account**."},{"content":"Select User, Service Account, or Group dialog box","pos":[37763,37812]},{"pos":[37887,37927],"content":"Set <bpt id=\"p1\">**</bpt>Assign ServerRole<ept id=\"p1\">**</ept> to <bpt id=\"p2\">**</bpt>Public<ept id=\"p2\">**</ept>.","source":"Set **Assign ServerRole** to **Public**."},{"pos":[37935,38018],"content":"Assign the <bpt id=\"p1\">**</bpt>db<ph id=\"ph1\">\\_</ph>owner<ept id=\"p1\">**</ept> database role permission to the OrchestratorData database.","source":"Assign the **db\\_owner** database role permission to the OrchestratorData database."},{"pos":[38024,38069],"content":"Configure the Finance and Operations database","linkify":"Configure the Finance and Operations database","nodes":[{"content":"Configure the Finance and Operations database","pos":[0,45]}]},{"content":"In LCS, download and then restore the AxBootstrapDB<ph id=\"ph1\">\\_</ph>DemoData.bak database.","pos":[38074,38149],"source":"In LCS, download and then restore the AxBootstrapDB\\_DemoData.bak database."},{"pos":[38153,38186],"content":"Rename the database <bpt id=\"p1\">**</bpt>AXDBRAIN<ept id=\"p1\">**</ept>.","source":"Rename the database **AXDBRAIN**."},{"content":"Run the following queries on the restored database.","pos":[38190,38241]},{"content":"Update the database files:","pos":[38409,38435]},{"pos":[38444,38500],"content":"Right-click the database, and then click <bpt id=\"p1\">**</bpt>Properties<ept id=\"p1\">**</ept>.","source":"Right-click the database, and then click **Properties**."},{"pos":[38508,38563],"content":"Click <bpt id=\"p1\">**</bpt>Files<ept id=\"p1\">**</ept> to change the database file properties.","source":"Click **Files** to change the database file properties."},{"pos":[38571,38645],"content":"In the <bpt id=\"p1\">**</bpt>Initial Size (MB)<ept id=\"p1\">**</ept> field, enter a value that is more than 5,120.","source":"In the **Initial Size (MB)** field, enter a value that is more than 5,120."},{"content":"Database Properties dialog box","pos":[38657,38687]},{"pos":[38749,38838],"content":"For <bpt id=\"p1\">**</bpt>AXDBBuild<ph id=\"ph1\">\\_</ph>Data<ept id=\"p1\">**</ept>, set the <bpt id=\"p2\">**</bpt>Autogrowth/Maximize<ept id=\"p2\">**</ept> field to <bpt id=\"p3\">**</bpt>200<ept id=\"p3\">**</ept> megabytes (MB).","source":"For **AXDBBuild\\_Data**, set the **Autogrowth/Maximize** field to **200** megabytes (MB)."},{"pos":[38846,38922],"content":"For <bpt id=\"p1\">**</bpt>AXDBBuild<ph id=\"ph1\">\\_</ph>Log<ept id=\"p1\">**</ept>, set the <bpt id=\"p2\">**</bpt>Autogrowth/Maximize<ept id=\"p2\">**</ept> field to <bpt id=\"p3\">**</bpt>500<ept id=\"p3\">**</ept> MB.","source":"For **AXDBBuild\\_Log**, set the **Autogrowth/Maximize** field to **500** MB."},{"content":"Change Autogrowth dialog box","pos":[38934,38962]},{"content":"Create a new user that has SQL authentication enabled (axdbadmin).","pos":[39018,39084]},{"content":"Use the information in the following table to map the users and database roles.","pos":[39088,39167]},{"content":"User","pos":[39175,39179]},{"content":"Type","pos":[39194,39198]},{"content":"Database role","pos":[39204,39217]},{"content":"svc-AXSF$","pos":[39277,39286]},{"content":"gMSA","pos":[39296,39300]},{"content":"db<ph id=\"ph1\">\\_</ph>owner","pos":[39306,39315],"source":"db\\_owner"},{"content":"svc-LocalAgent$","pos":[39328,39343]},{"content":"gMSA","pos":[39347,39351]},{"content":"db<ph id=\"ph1\">\\_</ph>owner","pos":[39357,39366],"source":"db\\_owner"},{"content":"svc-FRPS$","pos":[39379,39388]},{"content":"gMSA","pos":[39398,39402]},{"content":"db<ph id=\"ph1\">\\_</ph>owner","pos":[39408,39417],"source":"db\\_owner"},{"content":"svc-FRAS$","pos":[39430,39439]},{"content":"gMSA","pos":[39449,39453]},{"content":"db<ph id=\"ph1\">\\_</ph>owner","pos":[39459,39468],"source":"db\\_owner"},{"content":"axdbadmin","pos":[39481,39490]},{"content":"SqlUser","pos":[39500,39507]},{"content":"db<ph id=\"ph1\">\\_</ph>owner","pos":[39510,39519],"source":"db\\_owner"},{"content":"Give the svc-AXSF$ user and the axdbadmin SQL user access to the following roles in the tempdb database:","pos":[39530,39634]},{"content":"db<ph id=\"ph1\">\\_</ph>datareader","pos":[39642,39656],"source":"db\\_datareader"},{"content":"db<ph id=\"ph1\">\\_</ph>datawriter","pos":[39663,39677],"source":"db\\_datawriter"},{"content":"db<ph id=\"ph1\">\\_</ph>ddladmin","pos":[39684,39696],"source":"db\\_ddladmin"},{"content":"In Management Studio, run the following Transact SQL (T-SQL) commands:","pos":[39701,39771]},{"pos":[39891,39933],"content":"Configure the Financial Reporting database","linkify":"Configure the Financial Reporting database","nodes":[{"content":"Configure the Financial Reporting database","pos":[0,42]}]},{"pos":[39939,40000],"content":"Create an empty database, and name it <bpt id=\"p1\">**</bpt>FinancialReporting<ept id=\"p1\">**</ept>.","source":"Create an empty database, and name it **FinancialReporting**."},{"content":"Use the information in the following table to map the users and database roles.","pos":[40005,40084]},{"content":"User","pos":[40092,40096]},{"content":"Type","pos":[40111,40115]},{"content":"Database role","pos":[40118,40131]},{"content":"svc-LocalAgent$","pos":[40188,40203]},{"content":"gMSA","pos":[40207,40211]},{"content":"db<ph id=\"ph1\">\\_</ph>owner","pos":[40214,40223],"source":"db\\_owner"},{"content":"svc-FRPS$","pos":[40236,40245]},{"content":"gMSA","pos":[40255,40259]},{"content":"db<ph id=\"ph1\">\\_</ph>owner","pos":[40262,40271],"source":"db\\_owner"},{"content":"svc-FRAS$","pos":[40284,40293]},{"content":"gMSA","pos":[40303,40307]},{"content":"db<ph id=\"ph1\">\\_</ph>owner","pos":[40310,40319],"source":"db\\_owner"},{"pos":[40331,40350],"content":"Encrypt credentials","linkify":"Encrypt credentials","nodes":[{"content":"Encrypt credentials","pos":[0,19]}]},{"content":"On any client machine, install the encipherment certificate in the LocalMachine<ph id=\"ph1\">\\\\</ph>My certificate store.","pos":[40355,40457],"source":"On any client machine, install the encipherment certificate in the LocalMachine\\\\My certificate store."},{"content":"Grant the current user read access to the private key of this certificate.","pos":[40461,40535]},{"content":"Create the Credentials.json file as shown here.","pos":[40539,40586]},{"pos":[40849,40956],"content":"<bpt id=\"p1\">**</bpt>AccountPassword<ept id=\"p1\">**</ept> is the encrypted domain user password for the AOS domain user (contoso<ph id=\"ph1\">\\\\</ph>axserviceuser).","source":"**AccountPassword** is the encrypted domain user password for the AOS domain user (contoso\\\\axserviceuser)."},{"pos":[40963,41130],"content":"<bpt id=\"p1\">**</bpt>SqlUser<ept id=\"p1\">**</ept> is the encrypted SQL user (axdbadmin) that has access to the Finance and Operations database (AXDBRAIN), and <bpt id=\"p2\">**</bpt>SqlPassword<ept id=\"p2\">**</ept> is the encrypted SQL password.","source":"**SqlUser** is the encrypted SQL user (axdbadmin) that has access to the Finance and Operations database (AXDBRAIN), and **SqlPassword** is the encrypted SQL password."},{"content":"Copy the .json file to the SMB file share, <ph id=\"ph1\">\\\\</ph><ph id=\"ph2\">\\\\</ph>AX7SQLAOFILE1<ph id=\"ph3\">\\\\</ph>agent<ph id=\"ph4\">\\\\</ph>Credentials<ph id=\"ph5\">\\\\</ph>Credentials.json.","pos":[41135,41234],"source":"Copy the .json file to the SMB file share, \\\\\\\\AX7SQLAOFILE1\\\\agent\\\\Credentials\\\\Credentials.json."},{"content":"Update the Credentials.json file with encrypted values.","pos":[41238,41293]},{"pos":[41558,41658],"content":"In Credentials.json, replace <bpt id=\"p1\">**</bpt><ph id=\"ph1\">\\&lt;</ph>encryptedDomainUserPassword<ph id=\"ph2\">\\&gt;</ph><ept id=\"p1\">**</ept> with the encrypted domain password.","source":"In Credentials.json, replace **\\<encryptedDomainUserPassword\\>** with the encrypted domain password."},{"pos":[41666,41750],"content":"Replace <bpt id=\"p1\">**</bpt><ph id=\"ph1\">\\&lt;</ph>encryptedSqlUser<ph id=\"ph2\">\\&gt;</ph><ept id=\"p1\">**</ept> with the encrypted Finance and Operations SQL user.","source":"Replace **\\<encryptedSqlUser\\>** with the encrypted Finance and Operations SQL user."},{"pos":[41758,41840],"content":"Replace <bpt id=\"p1\">**</bpt><ph id=\"ph1\">\\&lt;</ph>encryptedSqlPassword<ph id=\"ph2\">\\&gt;</ph><ept id=\"p1\">**</ept> with the Finance and Operations SQL password.","source":"Replace **\\<encryptedSqlPassword\\>** with the Finance and Operations SQL password."},{"pos":[41850,41861],"content":"Set up SSRS","linkify":"Set up SSRS","nodes":[{"content":"Set up SSRS","pos":[0,11]}]},{"content":"Before you begin, make sure that the prerequisites that are listed at the beginning of this topic are installed.","pos":[41867,41979]},{"pos":[41984,42120],"content":"Follow the steps to <bpt id=\"p1\">[</bpt>Configure SQL Server Reporting Services for an on-premises deployment<ept id=\"p1\">](../analytics/configure-ssrs-on-premises.md)</ept>.","source":"Follow the steps to [Configure SQL Server Reporting Services for an on-premises deployment](../analytics/configure-ssrs-on-premises.md)."},{"pos":[42126,42141],"content":"Configure AD FS","linkify":"Configure AD FS","nodes":[{"content":"Configure AD FS","pos":[0,15]}]},{"content":"Before you can complete this procedure, AD FS must be deployed on Windows Server 2016.","pos":[42143,42229]},{"content":"For information about how to deploy AD FS, see <bpt id=\"p1\">[</bpt>Deployment Guide Windows Server 2016 and 2012 R2 AD FS Deployment Guide<ept id=\"p1\">](https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/deployment/windows-server-2012-r2-ad-fs-deployment-guide)</ept>.","pos":[42230,42472],"source":" For information about how to deploy AD FS, see [Deployment Guide Windows Server 2016 and 2012 R2 AD FS Deployment Guide](https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/deployment/windows-server-2012-r2-ad-fs-deployment-guide)."},{"content":"Finance and Operations requires additional configuration beyond the default out-of-box configuration of AD FS.","pos":[42474,42584]},{"content":"For the following steps, Windows PowerShell runs on a machine that has the AD FS role service installed.","pos":[42585,42689]},{"content":"The user account must have enough permissions to administer AD FS.","pos":[42690,42756]},{"content":"For example, the user must have a domain administrator account.","pos":[42757,42820]},{"content":"Configure the AD FS identifier so that it matches the AD FS token issuer.","pos":[42825,42898]},{"content":"You should disable Windows Integrated Authentication (WIA) for intranet authentication connections unless you've configured AD FS for mixed environments.","pos":[43026,43179]},{"content":"For more information about how to configure WIA so that it can be used with AD FS, see <bpt id=\"p1\">[</bpt>Configure browsers to use Windows Integrated Authentication (WIA) with AD FS<ept id=\"p1\">](https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/operations/configure-ad-fs-browser-wia)</ept>.","pos":[43180,43449],"source":" For more information about how to configure WIA so that it can be used with AD FS, see [Configure browsers to use Windows Integrated Authentication (WIA) with AD FS](https://docs.microsoft.com/en-us/windows-server/identity/ad-fs/operations/configure-ad-fs-browser-wia)."},{"content":"For sign-in, the user's email address must be an acceptable authentication input.","pos":[43599,43680]},{"content":"In order for AD FS to trust Finance and Operations for the exchange of authentication, various application entries must be registered in AD FS under an AD FS application group.","pos":[43979,44155]},{"content":"To speed up setup process and help reduce errors, you can use the following script for registration.","pos":[44156,44256]},{"content":"Copy the Publish-ADFSApplicationGroup.ps1 script and D365FO-OP directory to a machine that has the AD FS role service installed.","pos":[44257,44385]},{"content":"Then run the script by using a user account, such as an administrator account, that has enough permissions to administer AD FS.","pos":[44386,44513]},{"content":"For more information about how to use the script, see the documentation that is listed in the script.","pos":[44514,44615]},{"content":"Make a note of the client IDs that are specified in the output, because you will be asked for this information in LCS in a later step.","pos":[44616,44750]},{"content":"The AD FS management console should resemble the following illustration.","pos":[44899,44971]},{"content":"To open Server Manager, click <bpt id=\"p1\">**</bpt>Tools<ept id=\"p1\">**</ept> <ph id=\"ph1\">\\&gt;</ph> <bpt id=\"p2\">**</bpt>AD FS Management<ept id=\"p2\">**</ept>, and then, at the bottom of the tree view on the left, click <bpt id=\"p3\">**</bpt>Application Groups<ept id=\"p3\">**</ept>.","pos":[44972,45120],"source":" To open Server Manager, click **Tools** \\> **AD FS Management**, and then, at the bottom of the tree view on the left, click **Application Groups**."},{"content":"Double-click the application group to view more details.","pos":[45121,45177]},{"content":"Application group properties","pos":[45181,45209]},{"content":"Finally, for a sanity check, make sure that you can access the AD FS OpenID Configuration URL on a Service Fabric node of the <bpt id=\"p1\">**</bpt>AOSNodeType<ept id=\"p1\">**</ept> type by going to <ph id=\"ph1\">`https://&lt;adfs-dns-name&gt;/adfs/.well-known/openid-configuration`</ph> in a web browser.","pos":[45262,45502],"source":"Finally, for a sanity check, make sure that you can access the AD FS OpenID Configuration URL on a Service Fabric node of the **AOSNodeType** type by going to `https://<adfs-dns-name>/adfs/.well-known/openid-configuration` in a web browser."},{"content":"If you receive a message that states that the site isn't secure, you haven't added your AD FS SSL certificate to the Trusted Root Certification Authorities store.","pos":[45503,45665]},{"content":"This step is described in the AD FS deployment guide.","pos":[45666,45719]},{"content":"If you successfully access the URL, a JavaScript Object Notation (JSON) file is returned that contains your AD FS configuration, and you will see that your AD FS URL is trusted.","pos":[45720,45897]},{"content":"With this the setup of infrastructure is complete.","pos":[45899,45949]},{"content":"The following sections describe how to navigate to <bpt id=\"p1\">[</bpt>LCS<ept id=\"p1\">](https://lcs.dynamics.com)</ept> to set up your connector and deploy your Dynamics 365 for Finance and Operations environment.","pos":[45950,46126],"source":" The following sections describe how to navigate to [LCS](https://lcs.dynamics.com) to set up your connector and deploy your Dynamics 365 for Finance and Operations environment."},{"pos":[46131,46186],"content":"Configure connector and install on-premises local agent","linkify":"Configure connector and install on-premises local agent","nodes":[{"content":"Configure connector and install on-premises local agent","pos":[0,55]}]},{"pos":[46191,46283],"content":"Sign in to <bpt id=\"p1\">[</bpt>LCS<ept id=\"p1\">](https://lcs.dynamics.com/)</ept> and open the on-premises implementation project.","source":"Sign in to [LCS](https://lcs.dynamics.com/) and open the on-premises implementation project."},{"pos":[46287,46337],"content":"On the hamburger menu, click <bpt id=\"p1\">**</bpt>Project settings<ept id=\"p1\">**</ept>.","source":"On the hamburger menu, click **Project settings**."},{"content":"Project settings command","pos":[46345,46369]},{"pos":[46415,46448],"content":"Click <bpt id=\"p1\">**</bpt>On-premises connectors<ept id=\"p1\">**</ept>.","source":"Click **On-premises connectors**."},{"pos":[46452,46492],"content":"Click <bpt id=\"p1\">**</bpt>Add<ept id=\"p1\">**</ept> to create a new connector.","source":"Click **Add** to create a new connector."},{"pos":[46496,46567],"content":"On the <bpt id=\"p1\">**</bpt>Setup host infrastructure<ept id=\"p1\">**</ept> tab, download the agent installer.","source":"On the **Setup host infrastructure** tab, download the agent installer."},{"content":"Download agent installer button on the Setup host infrastructure tab","pos":[46575,46643]},{"content":"Verify that the zip file is unblocked.","pos":[46696,46734]},{"content":"Right-click the file, click <bpt id=\"p1\">**</bpt>Properties<ept id=\"p1\">**</ept>, and then select <bpt id=\"p2\">**</bpt>Unblock<ept id=\"p2\">**</ept>.","pos":[46735,46807],"source":" Right-click the file, click **Properties**, and then select **Unblock**."},{"pos":[46811,46905],"content":"Unzip the agent installer on one of the Service fabric nodes of the <bpt id=\"p1\">**</bpt>OrchestratorType<ept id=\"p1\">**</ept> type.","source":"Unzip the agent installer on one of the Service fabric nodes of the **OrchestratorType** type."},{"pos":[46909,46974],"content":"On the <bpt id=\"p1\">**</bpt>Configure agent<ept id=\"p1\">**</ept> tab, enter the configuration settings.","source":"On the **Configure agent** tab, enter the configuration settings."},{"pos":[46978,47103],"content":"Save the configuration, and then click <bpt id=\"p1\">**</bpt>Download configurations<ept id=\"p1\">**</ept> to download the localagent-config.json configuration file.","source":"Save the configuration, and then click **Download configurations** to download the localagent-config.json configuration file."},{"content":"Download configurations button on the Configure agent tab","pos":[47111,47168]},{"content":"Copy the localagent-config.json file to the machine where the agent installer package is located.","pos":[47222,47319]},{"content":"In a Command Prompt window, run the following command by navigating to the folder that contains the agent installer.","pos":[47324,47440]},{"pos":[47517,47631],"content":"[!NOTE]\nThe user who runs this command must have **db\\_owner** permissions on the OrchestratorData database.","leadings":["","    > "],"nodes":[{"content":"The user who runs this command must have <bpt id=\"p1\">**</bpt>db<ph id=\"ph1\">\\_</ph>owner<ept id=\"p1\">**</ept> permissions on the OrchestratorData database.","pos":[8,108],"source":"The user who runs this command must have **db\\_owner** permissions on the OrchestratorData database."}]},{"content":"Once the local agent is installed successfully navigate back to your on-premises connector in LCS.","pos":[47641,47739]},{"content":"On the <bpt id=\"p1\">**</bpt>Validate setup<ept id=\"p1\">**</ept> tab click on <bpt id=\"p2\">**</bpt>Message agent<ept id=\"p2\">**</ept> button.","pos":[47744,47808],"source":"On the **Validate setup** tab click on **Message agent** button."},{"content":"This will test for LCS connectivity to your local agent.","pos":[47809,47865]},{"content":"When connection is established successfully the page will look like the graphic below.","pos":[47866,47952]},{"content":"Validate agent","pos":[47961,47975]},{"pos":[48008,48085],"content":"Deploy your Dynamics 365 for Finance and Operations (on-premises) environment","linkify":"Deploy your Dynamics 365 for Finance and Operations (on-premises) environment","nodes":[{"content":"Deploy your Dynamics 365 for Finance and Operations (on-premises) environment","pos":[0,77]}]},{"pos":[48090,48196],"content":"Navigate to your on-premises project in LCS, go to <bpt id=\"p1\">**</bpt>Environment<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>Sandbox<ept id=\"p2\">**</ept> and click on <bpt id=\"p3\">**</bpt>Configure<ept id=\"p3\">**</ept>","source":"Navigate to your on-premises project in LCS, go to **Environment**, **Sandbox** and click on **Configure**"},{"pos":[48200,48292],"content":"Select your <bpt id=\"p1\">**</bpt>Environment topology<ept id=\"p1\">**</ept> and go through the wizard to intitiate your deployment.","source":"Select your **Environment topology** and go through the wizard to intitiate your deployment."},{"content":"The local agent will pick up the deployment request, kick off the deployment and communicate back to LCS when ready.","pos":[48296,48412]}]}