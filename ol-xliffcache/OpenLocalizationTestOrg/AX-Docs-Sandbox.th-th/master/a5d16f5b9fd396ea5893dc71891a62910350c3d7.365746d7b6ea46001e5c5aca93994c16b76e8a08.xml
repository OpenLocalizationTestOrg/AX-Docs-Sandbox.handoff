{"nodes":[{"pos":[32,60],"content":"Workflow system architecture","needQuote":true,"needEscape":true,"nodes":[{"content":"Workflow system architecture","pos":[0,28]}]},{"pos":[74,178],"content":"This article describes the architecture of the workflow system in Microsoft Dynamics 365 for Operations.","needQuote":true,"needEscape":true,"nodes":[{"content":"This article describes the architecture of the workflow system in Microsoft Dynamics 365 for Operations.","pos":[0,104]}]},{"pos":[690,718],"content":"Workflow system architecture","linkify":"Workflow system architecture","nodes":[{"content":"Workflow system architecture","pos":[0,28]}]},{"content":"This article describes the architecture of the workflow system in Microsoft Dynamics 365 for Operations.","pos":[720,824]},{"content":"The workflow infrastructure consists of two components that are hosted on Application Object Server (AOS): the X++ workflow runtime and the managed workflow runtime.","pos":[826,991]},{"content":"The X++ workflow runtime consists of the following components:","pos":[992,1054]},{"content":"Workflow runtime application programming interface (API)","pos":[1060,1116]},{"content":"A messaging batch job","pos":[1121,1142]},{"content":"A message queue","pos":[1147,1162]},{"content":"Either the messaging batch job or the workflow runtime API can invoke the application code, if it's required.","pos":[1164,1273]},{"content":"The X++ workflow runtime is compiled into the Common Intermediate Language (CIL) of the Microsoft .NET Framework.","pos":[1274,1387]},{"content":"The managed workflow runtime consists of the Windows Workflow Foundation and Dynamics 365 for Operations extensions.","pos":[1388,1504]},{"content":"Logically, the workflow infrastructure is an extension of Dynamics 365 for Operations and is transparent to users.","pos":[1505,1619]},{"content":"Physically, both the X++ workflow and the managed workflow runtimes are hosted on AOS.","pos":[1620,1706]},{"content":"The workflow infrastructure uses batch processing on AOS and .NET Interop to integrate both subsystems, and to pass messages from one subsystem to the other.","pos":[1707,1864]},{"content":"The X++ code that is run in the batch processor is compiled to .NET CIL.","pos":[1865,1937]},{"content":"The batch processing runs in the .NET common language runtime (CLR).","pos":[1938,2006]},{"content":"The following figure shows the high-level architecture of the workflow infrastructure.","pos":[2007,2093]},{"content":"<bpt id=\"p1\">[</bpt><ph id=\"ph1\">![</ph>workflow<ph id=\"ph2\">\\_</ph>architecturediagram2016<ept id=\"p1\">](./media/workflow_architecturediagram2016.png)](./media/workflow_architecturediagram2016.png)</ept> Users can use the workflow pages and controls in Dynamics 365 for Operations to participate in business processes.","pos":[2094,2339],"source":"[![workflow\\_architecturediagram2016](./media/workflow_architecturediagram2016.png)](./media/workflow_architecturediagram2016.png) Users can use the workflow pages and controls in Dynamics 365 for Operations to participate in business processes."},{"content":"Developers can create workflows for objects that they have added to Dynamics 365 for Operations.","pos":[2340,2436]},{"content":"The following table describes the workflow steps that occur when a user submits an expense report to the workflow system for approval.","pos":[2437,2571]},{"content":"Step","pos":[2575,2579]},{"content":"Runtime","pos":[2582,2589]},{"content":"Activity","pos":[2609,2617]},{"content":"1","pos":[4179,4180]},{"content":"X++ workflow runtime","pos":[4186,4206]},{"content":"A user submits an expense report by clicking the <bpt id=\"p1\">**</bpt>Submit<ept id=\"p1\">**</ept> button on one of the workflow controls.","pos":[4213,4312],"source":"A user submits an expense report by clicking the **Submit** button on one of the workflow controls."},{"content":"This action causes X++ code to activate a workflow instance by calling the workflow runtime API.","pos":[4313,4409]},{"content":"The workflow runtime API posts a message to the message queue.","pos":[4410,4472]},{"content":"The messaging batch job reads the message and sends a workflow activation request to the managed workflow runtime.","pos":[4473,4587]},{"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept> The messaging batch job processes the message queue at one-minute intervals.","pos":[4588,4674],"source":"**Note:** The messaging batch job processes the message queue at one-minute intervals."},{"content":"2","pos":[4981,4982]},{"content":"Managed workflow runtime","pos":[4988,5012]},{"content":".NET Interop from X++ receives the message and starts a new workflow instance via Windows Workflow Foundation.","pos":[5015,5125]},{"content":"This workflow instance performs a callback to the X++ workflow runtime API via .NET Interop to X++ CIL and posts a message that the workflow has started.","pos":[5126,5279]},{"content":"After the message is posted, the managed workflow runtime saves the idle workflow instance to the Dynamics 365 for Operations database.","pos":[5280,5415]},{"content":"The runtime then removes the workflow instance from memory.","pos":[5416,5475]},{"content":"When the managed workflow runtime receives another message from the X++ workflow runtime for this workflow instance, it restores the workflow instance to memory and resumes it.","pos":[5476,5652]},{"content":"Each workflow instance is unique.","pos":[5653,5686]},{"content":"If two users submit their expense reports for approval, two workflow instances are started.","pos":[5687,5778]},{"content":"3","pos":[5783,5784]},{"content":"X++ workflow runtime","pos":[5790,5810]},{"content":"The messaging batch job reads the <bpt id=\"p1\">**</bpt>workflow started<ept id=\"p1\">**</ept> message from the message queue and invokes the application event handler to process a <bpt id=\"p2\">**</bpt>workflow started<ept id=\"p2\">**</ept> event.","pos":[5817,5985],"source":"The messaging batch job reads the **workflow started** message from the message queue and invokes the application event handler to process a **workflow started** event."},{"content":"The batch job then posts an acknowledgment message that the event was processed.","pos":[5986,6066]},{"content":"4","pos":[6585,6586]},{"content":"Both","pos":[6592,6596]},{"content":"This same messaging pattern is repeated, as required, throughout the lifecycle of the workflow instance.","pos":[6619,6723]},{"content":"The workflow architecture helps provide a reliable and durable messaging system, and also helps guarantee that the state of the workflow is always synchronized with the state of the application.","pos":[7386,7580]},{"content":"If an unexpected hardware or software failure occurs, the workflow instance state is returned to its last known saved point, and the message stays in the queue.","pos":[7581,7741]},{"content":"Therefore, from an architecture perspective, the recovery model is to fix the problem and resume the workflow.","pos":[7742,7852]}],"content":"---\n# required metadata\n\ntitle: Workflow system architecture\ndescription: This article describes the architecture of the workflow system in Microsoft Dynamics 365 for Operations.\nauthor: sericks007\nmanager: AnnBe\nms.date: 04/04/2017\nms.topic: article\nms.prod: \nms.service: Dynamics365Operations\nms.technology: \n\n# optional metadata\n\n# ms.search.form: \n# ROBOTS: \naudience: Developer, IT Pro\n# ms.devlang: \n# ms.reviewer: 71\nms.search.scope: AX 7.0.0, Operations, Core\n# ms.tgt_pltfrm: \nms.custom: 56351\nms.assetid: 107a3f9f-aa1d-4087-9b35-196d8b82b0fb\nms.search.region: Global\n# ms.search.industry: \nms.author: tjvass\nms.search.validFrom: 2016-02-28\nms.dyn365.ops.version: AX 7.0.0\n\n---\n\n# Workflow system architecture\n\nThis article describes the architecture of the workflow system in Microsoft Dynamics 365 for Operations.\n\nThe workflow infrastructure consists of two components that are hosted on Application Object Server (AOS): the X++ workflow runtime and the managed workflow runtime. The X++ workflow runtime consists of the following components:\n\n-   Workflow runtime application programming interface (API)\n-   A messaging batch job\n-   A message queue\n\nEither the messaging batch job or the workflow runtime API can invoke the application code, if it's required. The X++ workflow runtime is compiled into the Common Intermediate Language (CIL) of the Microsoft .NET Framework. The managed workflow runtime consists of the Windows Workflow Foundation and Dynamics 365 for Operations extensions. Logically, the workflow infrastructure is an extension of Dynamics 365 for Operations and is transparent to users. Physically, both the X++ workflow and the managed workflow runtimes are hosted on AOS. The workflow infrastructure uses batch processing on AOS and .NET Interop to integrate both subsystems, and to pass messages from one subsystem to the other. The X++ code that is run in the batch processor is compiled to .NET CIL. The batch processing runs in the .NET common language runtime (CLR). The following figure shows the high-level architecture of the workflow infrastructure. [![workflow\\_architecturediagram2016](./media/workflow_architecturediagram2016.png)](./media/workflow_architecturediagram2016.png) Users can use the workflow pages and controls in Dynamics 365 for Operations to participate in business processes. Developers can create workflows for objects that they have added to Dynamics 365 for Operations. The following table describes the workflow steps that occur when a user submits an expense report to the workflow system for approval.\n\n| Step | Runtime                  | Activity                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |\n|------|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| 1    | X++ workflow runtime     | A user submits an expense report by clicking the **Submit** button on one of the workflow controls. This action causes X++ code to activate a workflow instance by calling the workflow runtime API. The workflow runtime API posts a message to the message queue. The messaging batch job reads the message and sends a workflow activation request to the managed workflow runtime. **Note:** The messaging batch job processes the message queue at one-minute intervals.                                                                                                                                                                                                                                                                                                               |\n| 2    | Managed workflow runtime | .NET Interop from X++ receives the message and starts a new workflow instance via Windows Workflow Foundation. This workflow instance performs a callback to the X++ workflow runtime API via .NET Interop to X++ CIL and posts a message that the workflow has started. After the message is posted, the managed workflow runtime saves the idle workflow instance to the Dynamics 365 for Operations database. The runtime then removes the workflow instance from memory. When the managed workflow runtime receives another message from the X++ workflow runtime for this workflow instance, it restores the workflow instance to memory and resumes it. Each workflow instance is unique. If two users submit their expense reports for approval, two workflow instances are started. |\n| 3    | X++ workflow runtime     | The messaging batch job reads the **workflow started** message from the message queue and invokes the application event handler to process a **workflow started** event. The batch job then posts an acknowledgment message that the event was processed.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |\n| 4    | Both                     | This same messaging pattern is repeated, as required, throughout the lifecycle of the workflow instance.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |\n\nThe workflow architecture helps provide a reliable and durable messaging system, and also helps guarantee that the state of the workflow is always synchronized with the state of the application. If an unexpected hardware or software failure occurs, the workflow instance state is returned to its last known saved point, and the message stays in the queue. Therefore, from an architecture perspective, the recovery model is to fix the problem and resume the workflow.\n\n"}