{"nodes":[{"pos":[6,23],"content":"required metadata","linkify":"required metadata","nodes":[{"content":"required metadata","pos":[0,17]}]},{"content":"title: Writing business logic in C# and X++ source code | Microsoft Docs description: The primary goal of this tutorial is to illustrate the interoperability between C# and X++ in Microsoft Dynamics AX.","pos":[25,227],"source":"title: Writing business logic in C# and X++ source code | Microsoft Docs\ndescription: The primary goal of this tutorial is to illustrate the interoperability between C# and X++ in Microsoft Dynamics AX."},{"content":"In this tutorial, you’ll write business logic in C# source code and in X++ source code.","pos":[228,315],"source":"\nIn this tutorial, you’ll write business logic in C# source code and in X++ source code."},{"content":"author: annbe manager: AnnBe ms.date: 2015-12-13 01:58:59 ms.topic: article ms.prod: ms.service: Dynamics365Operations ms.technology:","pos":[316,451],"source":" \nauthor: annbe\nmanager: AnnBe\nms.date: 2015-12-13 01:58:59\nms.topic: article\nms.prod: \nms.service: Dynamics365Operations\nms.technology:"},{"pos":[456,473],"content":"optional metadata","linkify":"optional metadata","nodes":[{"content":"optional metadata","pos":[0,17]}]},{"pos":[477,486],"content":"keywords:","linkify":"keywords:","nodes":[{"content":"keywords:","pos":[0,9]}]},{"pos":[490,497],"content":"ROBOTS:","linkify":"ROBOTS:","nodes":[{"content":"ROBOTS:","pos":[0,7]}]},{"content":"audience: Developer","pos":[499,518]},{"pos":[521,532],"content":"ms.devlang:","linkify":"ms.devlang:","nodes":[{"content":"ms.devlang:","pos":[0,11]}]},{"pos":[536,548],"content":"ms.reviewer:","linkify":"ms.reviewer:","nodes":[{"content":"ms.reviewer:","pos":[0,12]}]},{"content":"ms.suite: Released- Dynamics AX 7.0.0","pos":[550,587]},{"pos":[590,604],"content":"ms.tgt_pltfrm:","linkify":"ms.tgt_pltfrm:","nodes":[{"content":"ms.tgt_pltfrm:","pos":[0,14]}]},{"pos":[606,671],"content":"ms.custom: 26821 ms.assetid: 33b3bc61-8805-48d0-94ea-275df83f6ba8","source":"ms.custom: 26821\nms.assetid: 33b3bc61-8805-48d0-94ea-275df83f6ba8"},{"pos":[674,684],"content":"ms.region:","linkify":"ms.region:","nodes":[{"content":"ms.region:","pos":[0,10]}]},{"pos":[688,700],"content":"ms.industry:","linkify":"ms.industry:","nodes":[{"content":"ms.industry:","pos":[0,12]}]},{"content":"ms.author: pvillads","pos":[702,721]},{"pos":[730,778],"content":"Writing business logic in C# and X++ source code","linkify":"Writing business logic in C# and X++ source code","nodes":[{"content":"Writing business logic in C# and X++ source code","pos":[0,48]}]},{"content":"In this tutorial, you’ll write business logic in C<ph id=\"ph1\">\\#</ph> source code and in X++ source code.","pos":[780,868],"source":"In this tutorial, you’ll write business logic in C\\# source code and in X++ source code."},{"content":"You'll get experience with the following:","pos":[869,910]},{"content":"New tools in Visual Studio.","pos":[916,943]},{"content":"The handling of events in C<ph id=\"ph1\">\\#</ph>.","pos":[948,978],"source":"The handling of events in C\\#."},{"content":"The use of Language Integrated Query (LINQ) in C<ph id=\"ph1\">\\#</ph> to fetch data.","pos":[983,1048],"source":"The use of Language Integrated Query (LINQ) in C\\# to fetch data."},{"pos":[1053,1065],"content":"Prerequisite","linkify":"Prerequisite","nodes":[{"content":"Prerequisite","pos":[0,12]}]},{"content":"This tutorial requires that you access the Dynamics AX environment using Remote Desktop, and be provisioned as an administrator on the Dynamics AX instance.","pos":[1066,1222]},{"content":"<bpt id=\"p1\">**</bpt>Note<ept id=\"p1\">**</ept>: Debugging support for the C<ph id=\"ph1\">\\#</ph> project does not work if the <bpt id=\"p2\">**</bpt>Load symbols only for items in the solution<ept id=\"p2\">**</ept> check box is selected.","pos":[1223,1362],"source":"**Note**: Debugging support for the C\\# project does not work if the **Load symbols only for items in the solution** check box is selected."},{"content":"Since this option is selected by default, it must be changed prior to running the lab.","pos":[1363,1449]},{"content":"In Visual Studio, click <bpt id=\"p1\">**</bpt>Dynamics AX<ept id=\"p1\">**</ept> <ph id=\"ph1\">&amp;gt;</ph> <bpt id=\"p2\">**</bpt>Options<ept id=\"p2\">**</ept>, and clear the <bpt id=\"p3\">**</bpt>Load symbols only for items in the solution<ept id=\"p3\">**</ept> check box.","pos":[1450,1580],"source":" In Visual Studio, click **Dynamics AX** &gt; **Options**, and clear the **Load symbols only for items in the solution** check box."},{"pos":[1585,1593],"content":"Scenario","linkify":"Scenario","nodes":[{"content":"Scenario","pos":[0,8]}]},{"content":"Too many cars have been rented to drivers who have a history of unsafe driving habits.","pos":[1594,1680]},{"content":"The Fleet Management rental company needs to check driving records from external sources.","pos":[1681,1770]},{"content":"Upper management has decided to subscribe to a service that is hosted by the Department of Transportation (DOT), which is the legal entity that manages drivers’ licenses and associated information.","pos":[1771,1968]},{"content":"This service retrieves the number of citations for the given unique license number.","pos":[1969,2052]},{"content":"It’s not easy to call external services directly from X++ source code.","pos":[2053,2123]},{"content":"Visual Studio has tools for generating the “code-behind” (in C<ph id=\"ph1\">\\#</ph>) that calls the services, and these tools make the development effort easy.","pos":[2124,2264],"source":" Visual Studio has tools for generating the “code-behind” (in C\\#) that calls the services, and these tools make the development effort easy."},{"content":"The obvious choice would be to leverage Visual Studio to write the code.","pos":[2265,2337]},{"content":"However, in this tutorial your code won’t actually call an external service, because the logistics are beyond the scope of the simple lab environment.","pos":[2338,2488]},{"content":"Instead, we provide a mock implementation of a service call.","pos":[2489,2549]},{"content":"The goal of this tutorial is to teach an understanding of the current state of C<ph id=\"ph1\">\\#</ph> and of interoperability with X++.","pos":[2550,2666],"source":" The goal of this tutorial is to teach an understanding of the current state of C\\# and of interoperability with X++."},{"pos":[2671,2697],"content":"Create a C\\# class library","linkify":"Create a C\\# class library","nodes":[{"content":"Create a C<ph id=\"ph1\">\\#</ph> class library","pos":[0,26],"source":"Create a C\\# class library"}]},{"content":"Dynamics AX enables you to create a reference from a Dynamics AX project to the C<ph id=\"ph1\">\\#</ph> class library, or to any other type of C<ph id=\"ph2\">\\#</ph> project that generates an assembly.","pos":[2698,2860],"source":"Dynamics AX enables you to create a reference from a Dynamics AX project to the C\\# class library, or to any other type of C\\# project that generates an assembly."},{"content":"Such references affect the build order.","pos":[2861,2900]},{"content":"The C<ph id=\"ph1\">\\#</ph> project is built before the Dynamics AX project that references and depends on it.","pos":[2901,2991],"source":" The C\\# project is built before the Dynamics AX project that references and depends on it."},{"content":"The Dynamics AX infrastructure understands the references, and will make sure that the C<ph id=\"ph1\">\\#</ph> assemblies are deployed correctly to the cloud before execution.","pos":[2992,3147],"source":" The Dynamics AX infrastructure understands the references, and will make sure that the C\\# assemblies are deployed correctly to the cloud before execution."},{"content":"Follow these steps to create a C<ph id=\"ph1\">\\#</ph> class library in the Fleet Management solution:","pos":[3148,3230],"source":" Follow these steps to create a C\\# class library in the Fleet Management solution:"},{"pos":[3236,3300],"content":"In Visual Studio, click <bpt id=\"p1\">**</bpt>File<ept id=\"p1\">**</ept> <ph id=\"ph1\">&amp;gt;</ph> <bpt id=\"p2\">**</bpt>Open project/solution<ept id=\"p2\">**</ept>.","source":"In Visual Studio, click **File** &gt; **Open project/solution**."},{"pos":[3305,3470],"content":"In the <bpt id=\"p1\">**</bpt>Open Project<ept id=\"p1\">**</ept> dialog box, in the <bpt id=\"p2\">**</bpt>File name<ept id=\"p2\">**</ept> text box, type the following path, and then press <bpt id=\"p3\">**</bpt>Enter<ept id=\"p3\">**</ept><ph id=\"ph1\"> - </ph><bpt id=\"p4\">*</bpt>C:<ph id=\"ph2\">\\\\</ph>users<ph id=\"ph3\">\\\\</ph>public<ph id=\"ph4\">\\\\</ph>desktop<ph id=\"ph5\">\\\\</ph>FleetManagement<ept id=\"p4\">*</ept>.","source":"In the **Open Project** dialog box, in the **File name** text box, type the following path, and then press **Enter** - *C:\\\\users\\\\public\\\\desktop\\\\FleetManagement*."},{"content":"Select the file named FleetManagement.sln, and then click <bpt id=\"p1\">**</bpt>Open<ept id=\"p1\">**</ept>.","pos":[3475,3542],"source":"Select the file named FleetManagement.sln, and then click **Open**."},{"content":"If the solution file is not on your computer, the steps to create it are listed in <bpt id=\"p1\">[</bpt>Tutorial: Create a Fleet Management solution file out of the Fleet Management models in the AOT<ept id=\"p1\">](https://community.dynamics.com/ax/b/newdynamicsax/archive/2016/05/19/tutorial-create-a-fleet-management-solution-file-out-of-the-fleet-management-models-in-the-aot)</ept>.<bpt id=\"p2\">[</bpt><ph id=\"ph1\">![</ph>OpenProject<ph id=\"ph2\">\\_</ph>LinqC<ept id=\"p2\">](media/OpenProject_LinqC2.png)](media/OpenProject_LinqC2.png)</ept>","pos":[3543,3972],"source":" If the solution file is not on your computer, the steps to create it are listed in [Tutorial: Create a Fleet Management solution file out of the Fleet Management models in the AOT](https://community.dynamics.com/ax/b/newdynamicsax/archive/2016/05/19/tutorial-create-a-fleet-management-solution-file-out-of-the-fleet-management-models-in-the-aot).[![OpenProject\\_LinqC](media/OpenProject_LinqC2.png)](media/OpenProject_LinqC2.png)"},{"content":"Right-click the <bpt id=\"p1\">**</bpt>FleetManagement<ept id=\"p1\">**</ept> solution, and then click <bpt id=\"p2\">**</bpt>Add<ept id=\"p2\">**</ept> <ph id=\"ph1\">&amp;gt;</ph> <bpt id=\"p3\">**</bpt>New Project<ept id=\"p3\">**</ept>.","pos":[3977,4067],"source":"Right-click the **FleetManagement** solution, and then click **Add** &gt; **New Project**."},{"content":"The <bpt id=\"p1\">**</bpt>Add New Project<ept id=\"p1\">**</ept> dialog is displayed.","pos":[4068,4112],"source":" The **Add New Project** dialog is displayed."},{"pos":[4117,4210],"content":"In the left pane, click <bpt id=\"p1\">**</bpt>Visual C<ph id=\"ph1\">\\#</ph><ept id=\"p1\">**</ept>, and then in the middle pane, click <bpt id=\"p2\">**</bpt>Class Library<ept id=\"p2\">**</ept>.","source":"In the left pane, click **Visual C\\#**, and then in the middle pane, click **Class Library**."},{"pos":[4215,4297],"content":"At the bottom in the <bpt id=\"p1\">**</bpt>Name<ept id=\"p1\">**</ept> text box, type the name <bpt id=\"p2\">**</bpt>DriversLicenseEvaluator<ept id=\"p2\">**</ept>.","source":"At the bottom in the **Name** text box, type the name **DriversLicenseEvaluator**."},{"pos":[4302,4413],"content":"In the <bpt id=\"p1\">**</bpt>Location<ept id=\"p1\">**</ept> text box, type the following directory path: <bpt id=\"p2\">*</bpt>C:<ph id=\"ph1\">\\\\</ph>users<ph id=\"ph2\">\\\\</ph>public<ph id=\"ph3\">\\\\</ph>desktop<ph id=\"ph4\">\\\\</ph>FleetManagement<ept id=\"p2\">*</ept>.","source":"In the **Location** text box, type the following directory path: *C:\\\\users\\\\public\\\\desktop\\\\FleetManagement*."},{"content":"Verify that your project is set to “.NET Framework 4.5” in the drop-down list at the top.","pos":[4418,4507]},{"content":"Click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept> to create the project.","pos":[4512,4547],"source":"Click **OK** to create the project."},{"content":"<bpt id=\"p1\">[</bpt><ph id=\"ph1\">![</ph>AddNewProject<ph id=\"ph2\">\\_</ph>LinqC<ept id=\"p1\">](media/AddNewProject_LinqC2.png)](media/AddNewProject_LinqC2.png)</ept>","pos":[4548,4637],"source":"[![AddNewProject\\_LinqC](media/AddNewProject_LinqC2.png)](media/AddNewProject_LinqC2.png)"},{"pos":[4642,4786],"content":"In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, under the DriversLicenseEvaluator project, right-click the file name Class1.cs and rename it DriversLicenseChecker.cs.","source":"In **Solution Explorer**, under the DriversLicenseEvaluator project, right-click the file name Class1.cs and rename it DriversLicenseChecker.cs."},{"content":"Click <bpt id=\"p1\">**</bpt>Yes<ept id=\"p1\">**</ept>, when prompted to rename all references to the class.","pos":[4791,4858],"source":"Click **Yes**, when prompted to rename all references to the class."},{"content":"<bpt id=\"p1\">[</bpt><ph id=\"ph1\">![</ph>RenameClass<ph id=\"ph2\">\\_</ph>LinqC<ept id=\"p1\">](media/RenameClass_LinqC1.png)](media/RenameClass_LinqC1.png)</ept>","pos":[4859,4942],"source":"[![RenameClass\\_LinqC](media/RenameClass_LinqC1.png)](media/RenameClass_LinqC1.png)"},{"pos":[4947,4991],"content":"Write a C\\# method named CheckDriversLicense","linkify":"Write a C\\# method named CheckDriversLicense","nodes":[{"content":"Write a C<ph id=\"ph1\">\\#</ph> method named CheckDriversLicense","pos":[0,44],"source":"Write a C\\# method named CheckDriversLicense"}]},{"content":"In this section, you add C<ph id=\"ph1\">\\#</ph> code for a method named CheckDriversLicense.","pos":[4992,5065],"source":"In this section, you add C\\# code for a method named CheckDriversLicense."},{"content":"The method must validate the driver’s license.","pos":[5066,5112]},{"content":"To do this, the method must retrieve the driver’s license number, which is stored in the customer table.","pos":[5113,5217]},{"content":"The method is given the RecId value for the customer record that contains the information required by the method.","pos":[5218,5331]},{"content":"Your C<ph id=\"ph1\">\\#</ph> code uses the Dynamics AX LINQ provider to read from the customer table.","pos":[5332,5413],"source":" Your C\\# code uses the Dynamics AX LINQ provider to read from the customer table."},{"content":"For LINQ to work, you must first add references pointing to the LINQ assemblies.","pos":[5414,5494]},{"content":"You add these references to the C<ph id=\"ph1\">\\#</ph> project named DriversLicenseEvaluator.","pos":[5495,5569],"source":" You add these references to the C\\# project named DriversLicenseEvaluator."},{"pos":[5575,5711],"content":"In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, expand the DriversLicenseEvaluator project node, right-click <bpt id=\"p2\">**</bpt>References<ept id=\"p2\">**</ept>, and then click <bpt id=\"p3\">**</bpt>Add Reference<ept id=\"p3\">**</ept>.","source":"In **Solution Explorer**, expand the DriversLicenseEvaluator project node, right-click **References**, and then click **Add Reference**."},{"pos":[5716,5785],"content":"Click <bpt id=\"p1\">**</bpt>Browse<ept id=\"p1\">**</ept> and then enter the following path: C:<ph id=\"ph1\">\\\\</ph>Packages<ph id=\"ph2\">\\\\</ph>bin","source":"Click **Browse** and then enter the following path: C:\\\\Packages\\\\bin"},{"pos":[5794,5877],"content":"<bpt id=\"p1\">*</bpt>In some environments, the location of the packages folder is not on the c: drive.<ept id=\"p1\">*</ept>","source":"*In some environments, the location of the packages folder is not on the c: drive.*"},{"content":"In the <bpt id=\"p1\">**</bpt>File name<ept id=\"p1\">**</ept> field, type the pattern <ph id=\"ph1\">\\*</ph>LINQ<ph id=\"ph2\">\\*</ph>.dll and then press <bpt id=\"p2\">**</bpt>Enter<ept id=\"p2\">**</ept>.","pos":[5883,5966],"source":"In the **File name** field, type the pattern \\*LINQ\\*.dll and then press **Enter**."},{"content":"You'll see a list of assemblies with the name LINQ in them.","pos":[5967,6026]},{"content":"From that list, select the following files, and then click <bpt id=\"p1\">**</bpt>Add<ept id=\"p1\">**</ept>:","pos":[6027,6094],"source":" From that list, select the following files, and then click **Add**:"},{"content":"Microsoft.Dynamics.AX.Framework.Linq.Data.dll","pos":[6103,6148]},{"content":"Microsoft.Dynamics.AX.Framework.Linq.Data.Interface.dll","pos":[6157,6212]},{"content":"Microsoft.Dynamics.AX.Frameowrk.Linq.Data.Msil.dll","pos":[6221,6271]},{"pos":[6277,6375],"content":"<bpt id=\"p1\">[</bpt><ph id=\"ph1\">![</ph>SelectReferences<ph id=\"ph2\">\\_</ph>LinqC<ept id=\"p1\">](media/SelectReferences_LinqC1.png)](media/SelectReferences_LinqC1.png)</ept>","source":"[![SelectReferences\\_LinqC](media/SelectReferences_LinqC1.png)](media/SelectReferences_LinqC1.png)"},{"content":"You must also add the support assemblies that contain the Common type that you'll use in the code below.","pos":[6380,6484]},{"content":"Click <bpt id=\"p1\">**</bpt>Browse<ept id=\"p1\">**</ept> again, and then type the following file name into the field:","pos":[6485,6562],"source":" Click **Browse** again, and then type the following file name into the field:"},{"content":"Microsoft.Dynamics.AX.Xpp.Support.dll","pos":[6571,6608]},{"content":"Microsoft.Dynamics.AX.Data.Core.dll","pos":[6617,6652]},{"content":"Click<bpt id=\"p1\">**</bpt>Add<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>.","pos":[6658,6694],"source":"Click**Add**, and then click **OK**."},{"content":"The assemblies now appear under the references node in the project.","pos":[6695,6762]},{"pos":[6767,6874],"content":"Repeat the <bpt id=\"p1\">**</bpt>Add Reference<ept id=\"p1\">**</ept> process, except this time, add the following DLL file from the indicated path:","source":"Repeat the **Add Reference** process, except this time, add the following DLL file from the indicated path:"},{"content":"Dynamics.Ax.FleetManagement.dll, in C:<ph id=\"ph1\">\\\\</ph>Packages<ph id=\"ph2\">\\\\</ph>FleetManagement<ph id=\"ph3\">\\\\</ph>bin","pos":[6883,6953],"source":"Dynamics.Ax.FleetManagement.dll, in C:\\\\Packages\\\\FleetManagement\\\\bin"},{"pos":[6959,7092],"content":"In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, select the reference Dynamics.Ax.FleetManagement.dll reference and set the property <bpt id=\"p2\">**</bpt>Copy Local = False<ept id=\"p2\">**</ept>.","source":"In **Solution Explorer**, select the reference Dynamics.Ax.FleetManagement.dll reference and set the property **Copy Local = False**."},{"pos":[7097,7194],"content":"In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, right-click <bpt id=\"p2\">**</bpt>DriversLicenseChecker.cs<ept id=\"p2\">**</ept>, and then click <bpt id=\"p3\">**</bpt>View Code<ept id=\"p3\">**</ept>.","source":"In **Solution Explorer**, right-click **DriversLicenseChecker.cs**, and then click **View Code**."},{"content":"Add the following three using statements to the <bpt id=\"p1\">**</bpt>DriversLicenseEvaluator<ept id=\"p1\">**</ept> namespace, to reduce the verbosity of code that references external classes.","pos":[7199,7351],"source":"Add the following three using statements to the **DriversLicenseEvaluator** namespace, to reduce the verbosity of code that references external classes."},{"content":"using Dynamics.AX.Application; using Microsoft.Dynamics.AX.Framework.Linq.Data; using Microsoft.Dynamics.AX.Xpp; Your C<ph id=\"ph1\">\\#</ph> code should now look something like the following example.","pos":[7352,7532],"source":" using Dynamics.AX.Application; using Microsoft.Dynamics.AX.Framework.Linq.Data; using Microsoft.Dynamics.AX.Xpp; Your C\\# code should now look something like the following example."},{"content":"Replace the class CheckDriversLicense with the following code.","pos":[7971,8033]},{"content":"<bpt id=\"p1\">**</bpt>Tip<ept id=\"p1\">**</ept>: If you prefer, you can paste in the code from the DriversLicenseChecker.cs file in the C:<ph id=\"ph1\">\\\\</ph>FMLab directory.","pos":[8034,8150],"source":"**Tip**: If you prefer, you can paste in the code from the DriversLicenseChecker.cs file in the C:\\\\FMLab directory."},{"pos":[9703,9727],"content":"Understand the LINQ code","linkify":"Understand the LINQ code","nodes":[{"content":"Understand the LINQ code","pos":[0,24]}]},{"content":"Before proceeding with more C<ph id=\"ph1\">\\#</ph> code, verify that you understand the LINQ code you just added.","pos":[9729,9823],"source":"Before proceeding with more C\\# code, verify that you understand the LINQ code you just added."},{"content":"More details about LINQ are provided in the <bpt id=\"p1\">[</bpt>Technical Concepts Guide<ept id=\"p1\">](http://ax.help.dynamics.com/en/wiki/technical-concepts-guide/)</ept>, so only the basics are described below.","pos":[9824,9998],"source":" More details about LINQ are provided in the [Technical Concepts Guide](http://ax.help.dynamics.com/en/wiki/technical-concepts-guide/), so only the basics are described below."},{"content":"First, a <bpt id=\"p1\">*</bpt>provider<ept id=\"p1\">*</ept> is created.","pos":[10004,10035],"source":"First, a *provider* is created."},{"content":"It provides access to all the Microsoft Dynamics AX tables.","pos":[10036,10095]},{"content":"Next, a <bpt id=\"p1\">*</bpt>collection<ept id=\"p1\">*</ept> of all customers is created.","pos":[10100,10149],"source":"Next, a *collection* of all customers is created."},{"content":"The customer of interest is retrieved from this collection.","pos":[10150,10209]},{"pos":[10214,10313],"content":"Then, a <bpt id=\"p1\">*</bpt>query<ept id=\"p1\">*</ept> is created with a where clause that designates the requested customer by <bpt id=\"p2\">**</bpt>RecId<ept id=\"p2\">**</ept>.","source":"Then, a *query* is created with a where clause that designates the requested customer by **RecId**."},{"content":"The call to the FirstOrDefault method forces execution of the query.","pos":[10318,10386]},{"content":"The method assigns the single matching customer to the customer variable.","pos":[10391,10464]},{"content":"(Null is assigned if the RecId value matches no customer.)","pos":[10465,10523]},{"content":"Finally, the customer data is tested to see if the associated driver's license is valid.","pos":[10528,10616]},{"content":"(Does the license contain \"89\"?)","pos":[10617,10649]},{"pos":[10654,10693],"content":"Handle the event when a record is added","linkify":"Handle the event when a record is added","nodes":[{"content":"Handle the event when a record is added","pos":[0,39]}]},{"content":"The following subsections provide the following:","pos":[10694,10742]},{"content":"Explain the upcoming code items and their inter-relationships.","pos":[10748,10810]},{"content":"Show the code for an event handler.","pos":[10815,10850]},{"content":"Associate the handler with the event occurrences.","pos":[10855,10904]},{"pos":[10910,10930],"content":"Preparatory overview","linkify":"Preparatory overview","nodes":[{"content":"Preparatory overview","pos":[0,20]}]},{"content":"When an attempt is made to add a record to a table, the OnValidateWrite event is raised by Dynamics AX before the record is written to the database.","pos":[10932,11080]},{"content":"You want your CheckDriversLicense method to be called each time on the OnValidtaedWrite event is raised for the FMREntal table.","pos":[11081,11208]},{"content":"To do this, you now need to write a C<ph id=\"ph1\">\\#</ph> method that is invoked by the event, and which calls your checkDriversLicense method.","pos":[11209,11334],"source":" To do this, you now need to write a C\\# method that is invoked by the event, and which calls your checkDriversLicense method."},{"content":"In other words, you need to write an event handler that calls your CheckDriversLicense method.","pos":[11335,11429]},{"content":"The event handler method receives a parameter of the type, DataEventArgs.","pos":[11430,11503]},{"content":"The event handler can set a value in the DataEventArgs structure to accept or reject the record.","pos":[11504,11600]},{"content":"After you write your event handler method, you connect it to the event by assigning, or additing it, to the OnValidatedWrite delegate that is a member of the FMRental table.","pos":[11601,11774]},{"content":"You write this assignment in the init method of the data source of the FMRental form.","pos":[11775,11860]},{"content":"This assignment to a delegate might seem odd.","pos":[11861,11906]},{"content":"After all, we're modifying existing code (FMRental) to add handlers, which contradicts the main value proposition of loose coupling that eventing is supposed to offer.","pos":[11907,12074]},{"content":"This assignment step is temporary.","pos":[12075,12109]},{"content":"We'll eventually have the same story in C<ph id=\"ph1\">\\#</ph> as we do in X++, where an attribute is applied to the C<ph id=\"ph2\">\\#</ph> event handler as the mechanism that ties the delegate to the handler.","pos":[12110,12281],"source":" We'll eventually have the same story in C\\# as we do in X++, where an attribute is applied to the C\\# event handler as the mechanism that ties the delegate to the handler."},{"content":"<bpt id=\"p1\">**</bpt>Note<ept id=\"p1\">**</ept>: The data source init method is called when the form is opened.","pos":[12282,12354],"source":"**Note**: The data source init method is called when the form is opened."},{"content":"Technically, the init method is inherited from the FormDataSource class.","pos":[12355,12427]},{"pos":[12433,12462],"content":"Write an event handler method","linkify":"Write an event handler method","nodes":[{"content":"Write an event handler method","pos":[0,29]}]},{"content":"In C<ph id=\"ph1\">\\#</ph>, write the following event handler method and add it to the DriversLicenseChecker class.","pos":[12464,12559],"source":"In C\\#, write the following event handler method and add it to the DriversLicenseChecker class."},{"pos":[13121,13226],"content":"Build the DriversLicenseEvaluator project by right-clicking the project node and then clicking <bpt id=\"p1\">**</bpt>Build<ept id=\"p1\">**</ept>.","source":"Build the DriversLicenseEvaluator project by right-clicking the project node and then clicking **Build**."},{"pos":[13232,13295],"content":"Add a reference pointing to the DriversLIcenseEvaluator project","linkify":"Add a reference pointing to the DriversLIcenseEvaluator project","nodes":[{"content":"Add a reference pointing to the DriversLIcenseEvaluator project","pos":[0,63]}]},{"pos":[13297,13460],"content":"Create a reference from the X++ project named <bpt id=\"p1\">**</bpt>FleetManagement Migrated<ept id=\"p1\">**</ept> to the C<ph id=\"ph1\">\\#</ph> project named <bpt id=\"p2\">**</bpt>DriversLicenseEvaluator<ept id=\"p2\">**</ept>, by completing the following steps.","source":"Create a reference from the X++ project named **FleetManagement Migrated** to the C\\# project named **DriversLicenseEvaluator**, by completing the following steps."},{"content":"Right-click the FleetManagement Migrated project, click <bpt id=\"p1\">**</bpt>Add<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Reference<ept id=\"p2\">**</ept>.","pos":[13466,13560],"source":"Right-click the FleetManagement Migrated project, click **Add**, and then click **Reference**."},{"content":"Select the row for the DriversLicenseEvaluator project in the <bpt id=\"p1\">**</bpt>Projects<ept id=\"p1\">**</ept> references tab, and then click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>.","pos":[13561,13674],"source":" Select the row for the DriversLicenseEvaluator project in the **Projects** references tab, and then click **OK**."},{"content":"<bpt id=\"p1\">[</bpt><ph id=\"ph1\">![</ph>AddReference<ph id=\"ph2\">\\_</ph>LinqC<ept id=\"p1\">](media/AddReference_LinqC1.png)](media/AddReference_LinqC1.png)</ept>","pos":[13675,13761],"source":"[![AddReference\\_LinqC](media/AddReference_LinqC1.png)](media/AddReference_LinqC1.png)"},{"pos":[13766,13917],"content":"Under the FleetManagement Migrated project, expand the <bpt id=\"p1\">**</bpt>References<ept id=\"p1\">**</ept> node, and there you see new reference to the <bpt id=\"p2\">**</bpt>DriversLicenseEvaluator<ept id=\"p2\">**</ept> project.","source":"Under the FleetManagement Migrated project, expand the **References** node, and there you see new reference to the **DriversLicenseEvaluator** project."},{"pos":[13928,14071],"content":"<bpt id=\"p1\">[</bpt><ph id=\"ph1\">![</ph>SolutionExplorerReferences<ph id=\"ph2\">\\_</ph>LinqC<ept id=\"p1\">](media/SolutionExplorerReferences_LinqC2.png)](media/SolutionExplorerReferences_LinqC2.png)</ept> Build sequence","linkify":"[![SolutionExplorerReferences\\_LinqC](media/SolutionExplorerReferences_LinqC2.png)](media/SolutionExplorerReferences_LinqC2.png) Build sequence","source":"[![SolutionExplorerReferences\\_LinqC](media/SolutionExplorerReferences_LinqC2.png)](media/SolutionExplorerReferences_LinqC2.png) Build sequence"},{"content":"Your C<ph id=\"ph1\">\\#</ph> DriversLicenseEvaluator project will be built before the FleetManagement Migrated project is built.","pos":[14077,14185],"source":"Your C\\# DriversLicenseEvaluator project will be built before the FleetManagement Migrated project is built."},{"content":"This is because the added reference makes the Fleet project dependent on your project.","pos":[14186,14272]},{"content":"The build sequence is easy to see if you right-click the FleetManagement solution, click <bpt id=\"p1\">**</bpt>Project Build Order<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Dependencies<ept id=\"p2\">**</ept>.","pos":[14273,14419],"source":" The build sequence is easy to see if you right-click the FleetManagement solution, click **Project Build Order**, and then click **Dependencies**."},{"pos":[15275,15385],"content":"<bpt id=\"p1\">[</bpt><ph id=\"ph1\">![</ph>ProjectDependencies1<ph id=\"ph2\">\\_</ph>LinqC<ept id=\"p1\">](media/ProjectDependencies1_LinqC2.png)](media/ProjectDependencies1_LinqC2.png)</ept>","source":"[![ProjectDependencies1\\_LinqC](media/ProjectDependencies1_LinqC2.png)](media/ProjectDependencies1_LinqC2.png)"},{"pos":[15388,15498],"content":"<bpt id=\"p1\">[</bpt><ph id=\"ph1\">![</ph>ProjectDependencies2<ph id=\"ph2\">\\_</ph>LinqC<ept id=\"p1\">](media/ProjectDependencies2_LinqC1.png)](media/ProjectDependencies2_LinqC1.png)</ept>","source":"[![ProjectDependencies2\\_LinqC](media/ProjectDependencies2_LinqC1.png)](media/ProjectDependencies2_LinqC1.png)"},{"pos":[15506,15542],"content":"Add your event handler to a delegate","linkify":"Add your event handler to a delegate","nodes":[{"content":"Add your event handler to a delegate","pos":[0,36]}]},{"pos":[15548,15660],"content":"In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, navigate to <bpt id=\"p2\">**</bpt>FleetManagement Migrated <ph id=\"ph1\">&amp;gt;</ph> User Interface <ph id=\"ph2\">&amp;gt;</ph> Forms <ph id=\"ph3\">&amp;gt;</ph> FMRental<ept id=\"p2\">**</ept>.","source":"In **Solution Explorer**, navigate to **FleetManagement Migrated &gt; User Interface &gt; Forms &gt; FMRental**."},{"content":"Double-click the <bpt id=\"p1\">**</bpt>FMRental<ept id=\"p1\">**</ept> form.","pos":[15665,15700],"source":"Double-click the **FMRental** form."},{"content":"The Visual Studio designer opens to the form.","pos":[15701,15746]},{"pos":[15751,15826],"content":"Expand the <bpt id=\"p1\">**</bpt>Data Sources<ept id=\"p1\">**</ept> node to show the data sources used in the form.","source":"Expand the **Data Sources** node to show the data sources used in the form."},{"pos":[15831,15945],"content":"Expand the <bpt id=\"p1\">**</bpt>FMRental<ept id=\"p1\">**</ept> data source, and then the <bpt id=\"p2\">**</bpt>Methods<ept id=\"p2\">**</ept> node to list the methods defined on the data source.","source":"Expand the **FMRental** data source, and then the **Methods** node to list the methods defined on the data source."},{"content":"Right-click <bpt id=\"p1\">**</bpt>Methods<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Override <ph id=\"ph1\">&amp;gt;</ph> init<ept id=\"p2\">**</ept>.","pos":[15950,16013],"source":"Right-click **Methods**, and then click **Override &gt; init**."},{"content":"The list displays all of the methods on the data source that haven't yet been overridden.","pos":[16014,16103]},{"content":"When you select <bpt id=\"p1\">**</bpt>init<ept id=\"p1\">**</ept>, this opens the file <bpt id=\"p2\">**</bpt>FMRental.xpp<ept id=\"p2\">**</ept> in the X++ code editor with the cursor near the template for the init method.","pos":[16104,16244],"source":" When you select **init**, this opens the file **FMRental.xpp** in the X++ code editor with the cursor near the template for the init method."},{"pos":[16249,16345],"content":"At the end of the <bpt id=\"p1\">**</bpt>init<ept id=\"p1\">**</ept> method body, use the += operator to add one assignment to a delegate.","source":"At the end of the **init** method body, use the += operator to add one assignment to a delegate."},{"content":"Click to save, and then build the entire solution.","pos":[16489,16539]},{"pos":[16544,16554],"content":"Final test","linkify":"Final test","nodes":[{"content":"Final test","pos":[0,10]}]},{"content":"In this section, you set breakpoints and run the Fleet application under the Visual Studio debugger.","pos":[16555,16655]},{"content":"This enables you to prove the following:","pos":[16656,16696]},{"content":"Your LINQ query runs when the OnValidateWrite event is raised.","pos":[16702,16764]},{"content":"Your LINQ query successfully retrieves the data for one customer.","pos":[16769,16834]},{"pos":[16840,16856],"content":"Prepare the test","linkify":"Prepare the test","nodes":[{"content":"Prepare the test","pos":[0,16]}]},{"pos":[16862,16960],"content":"In <bpt id=\"p1\">**</bpt>Solution Explorer<ept id=\"p1\">**</ept>, navigate to <bpt id=\"p2\">**</bpt>FleetManagement Migrated <ph id=\"ph1\">&amp;gt;</ph> User Interface <ph id=\"ph2\">&amp;gt;</ph> Forms.<ept id=\"p2\">**</ept>","source":"In **Solution Explorer**, navigate to **FleetManagement Migrated &gt; User Interface &gt; Forms.**"},{"pos":[16965,17032],"content":"Right-click <bpt id=\"p1\">**</bpt>FMRental<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Set as Startup Object<ept id=\"p2\">**</ept>.","source":"Right-click **FMRental**, and then click **Set as Startup Object**."},{"content":"In the code editor for DriversLicenseChecker.cs, find the OnValidateWriteHandler method.","pos":[17037,17125]},{"content":"Find the following line of code.","pos":[17126,17158]},{"content":"Set a breakpoint on that line of code.","pos":[17229,17267]},{"content":"You do this by clicking in the left margin at that line.","pos":[17268,17324]},{"content":"A red dot displays when the breakpoint is set.","pos":[17325,17371]},{"content":"In the CheckDriversLicense method, set another breakpoint at the following line.","pos":[17376,17456]},{"pos":[17521,17533],"content":"Run the test","linkify":"Run the test","nodes":[{"content":"Run the test","pos":[0,12]}]},{"content":"For this test, we'll be debugging the C<ph id=\"ph1\">\\#</ph> code that we've written.","pos":[17535,17601],"source":"For this test, we'll be debugging the C\\# code that we've written."},{"content":"To do this, we need to inform Visual Studio to load the symbols for the assembly that contains the C<ph id=\"ph1\">\\#</ph> code.","pos":[17602,17710],"source":" To do this, we need to inform Visual Studio to load the symbols for the assembly that contains the C\\# code."},{"content":"Go to <bpt id=\"p1\">**</bpt>Dynamics AX <ph id=\"ph1\">&amp;gt;</ph> Options <ph id=\"ph2\">&amp;gt;</ph> Debugging<ept id=\"p1\">**</ept> and verify that the <bpt id=\"p2\">**</bpt>Load symbols only for items in the solution<ept id=\"p2\">**</ept> check box is not selected.","pos":[17711,17855],"source":" Go to **Dynamics AX &gt; Options &gt; Debugging** and verify that the **Load symbols only for items in the solution** check box is not selected."},{"content":"<bpt id=\"p1\">[</bpt><ph id=\"ph1\">![</ph>Options<ph id=\"ph2\">\\_</ph>LinqC<ept id=\"p1\">](media/Options_LinqC2.png)](media/Options_LinqC2.png)</ept> <bpt id=\"p2\">**</bpt>Tip<ept id=\"p2\">**</ept>: If you're unable to get to the breakpoint in the C<ph id=\"ph3\">\\#</ph> code, you may want to open the <bpt id=\"p3\">**</bpt>Modules<ept id=\"p3\">**</ept> window (<bpt id=\"p4\">**</bpt>Debug <ph id=\"ph4\">&amp;gt;</ph> Windows <ph id=\"ph5\">&amp;gt;</ph> Modules<ept id=\"p4\">**</ept>), find the C<ph id=\"ph6\">\\#</ph> module and load it explicitly.","pos":[17856,18122],"source":"[![Options\\_LinqC](media/Options_LinqC2.png)](media/Options_LinqC2.png) **Tip**: If you're unable to get to the breakpoint in the C\\# code, you may want to open the **Modules** window (**Debug &gt; Windows &gt; Modules**), find the C\\# module and load it explicitly."},{"content":"Click <bpt id=\"p1\">**</bpt>Debug <ph id=\"ph1\">&amp;gt;</ph> Start Debugging<ept id=\"p1\">**</ept>.","pos":[18128,18165],"source":"Click **Debug &gt; Start Debugging**."},{"content":"This starts the Fleet application, and a browser window with the <bpt id=\"p1\">**</bpt>FMRental<ept id=\"p1\">**</ept> form is displayed.","pos":[18166,18262],"source":" This starts the Fleet application, and a browser window with the **FMRental** form is displayed."},{"pos":[18267,18318],"content":"Click on any <bpt id=\"p1\">**</bpt>Vehicle rental ID<ept id=\"p1\">**</ept> to view details.","source":"Click on any **Vehicle rental ID** to view details."},{"content":"Click the <bpt id=\"p1\">**</bpt>Edit<ept id=\"p1\">**</ept> icon near the top left of the form.","pos":[18323,18377],"source":"Click the **Edit** icon near the top left of the form."},{"content":"The icon looks like a pencil.","pos":[18378,18407]},{"pos":[18412,18506],"content":"In the <bpt id=\"p1\">**</bpt>To<ept id=\"p1\">**</ept> field of the <bpt id=\"p2\">**</bpt>Rental<ept id=\"p2\">**</ept> section, increase the date by one day.![FMRentalDetails]","source":"In the **To** field of the **Rental** section, increase the date by one day.![FMRentalDetails]"},{"content":"Click the <bpt id=\"p1\">**</bpt>Save<ept id=\"p1\">**</ept> button.","pos":[18511,18537],"source":"Click the **Save** button."},{"content":"This causes the focus to shift to Visual Studio at your highlighted breakpoint.","pos":[18538,18617]},{"content":"This line shows that the OnValidatedWrite event was raised, and that your handler method was called.","pos":[18618,18718]},{"content":"Press <bpt id=\"p1\">**</bpt>F5<ept id=\"p1\">**</ept> to continue the run.","pos":[18723,18756],"source":"Press **F5** to continue the run."},{"content":"Instantly, your other breakpoint becomes highlighted.","pos":[18757,18810]},{"content":"Find the variable customer a few lines above your breakpoint.","pos":[18815,18876]},{"content":"Right-click the customer variable, and then click <bpt id=\"p1\">**</bpt>QuickWatch<ept id=\"p1\">**</ept>.","pos":[18881,18946],"source":"Right-click the customer variable, and then click **QuickWatch**."},{"content":"Any long integer value proves that your LINQ query worked.","pos":[18947,19005]},{"content":"<bpt id=\"p1\">[</bpt><ph id=\"ph1\">![</ph>QuickWatch<ph id=\"ph2\">\\_</ph>LinqC<ept id=\"p1\">](media/QuickWatch_LinqC2.png)](media/QuickWatch_LinqC2.png)</ept>","pos":[19006,19086],"source":"[![QuickWatch\\_LinqC](media/QuickWatch_LinqC2.png)](media/QuickWatch_LinqC2.png)"},{"pos":[19091,19139],"content":"Press <bpt id=\"p1\">**</bpt>F5<ept id=\"p1\">**</ept> to complete the <bpt id=\"p2\">**</bpt>Save<ept id=\"p2\">**</ept> operation.","source":"Press **F5** to complete the **Save** operation."}],"content":"---\n# required metadata\n\ntitle: Writing business logic in C# and X++ source code | Microsoft Docs\ndescription: The primary goal of this tutorial is to illustrate the interoperability between C# and X++ in Microsoft Dynamics AX.\nIn this tutorial, you’ll write business logic in C# source code and in X++ source code. \nauthor: annbe\nmanager: AnnBe\nms.date: 2015-12-13 01:58:59\nms.topic: article\nms.prod: \nms.service: Dynamics365Operations\nms.technology: \n\n# optional metadata\n\n# keywords: \n# ROBOTS: \naudience: Developer\n# ms.devlang: \n# ms.reviewer: \nms.suite: Released- Dynamics AX 7.0.0\n# ms.tgt_pltfrm: \nms.custom: 26821\nms.assetid: 33b3bc61-8805-48d0-94ea-275df83f6ba8\n# ms.region: \n# ms.industry: \nms.author: pvillads\n\n---\n\n# Writing business logic in C# and X++ source code\n\nIn this tutorial, you’ll write business logic in C\\# source code and in X++ source code. You'll get experience with the following:\n\n-   New tools in Visual Studio.\n-   The handling of events in C\\#.\n-   The use of Language Integrated Query (LINQ) in C\\# to fetch data.\n\n## Prerequisite\nThis tutorial requires that you access the Dynamics AX environment using Remote Desktop, and be provisioned as an administrator on the Dynamics AX instance. **Note**: Debugging support for the C\\# project does not work if the **Load symbols only for items in the solution** check box is selected. Since this option is selected by default, it must be changed prior to running the lab. In Visual Studio, click **Dynamics AX** &gt; **Options**, and clear the **Load symbols only for items in the solution** check box.\n\n## Scenario\nToo many cars have been rented to drivers who have a history of unsafe driving habits. The Fleet Management rental company needs to check driving records from external sources. Upper management has decided to subscribe to a service that is hosted by the Department of Transportation (DOT), which is the legal entity that manages drivers’ licenses and associated information. This service retrieves the number of citations for the given unique license number. It’s not easy to call external services directly from X++ source code. Visual Studio has tools for generating the “code-behind” (in C\\#) that calls the services, and these tools make the development effort easy. The obvious choice would be to leverage Visual Studio to write the code. However, in this tutorial your code won’t actually call an external service, because the logistics are beyond the scope of the simple lab environment. Instead, we provide a mock implementation of a service call. The goal of this tutorial is to teach an understanding of the current state of C\\# and of interoperability with X++.\n\n## Create a C\\# class library\nDynamics AX enables you to create a reference from a Dynamics AX project to the C\\# class library, or to any other type of C\\# project that generates an assembly. Such references affect the build order. The C\\# project is built before the Dynamics AX project that references and depends on it. The Dynamics AX infrastructure understands the references, and will make sure that the C\\# assemblies are deployed correctly to the cloud before execution. Follow these steps to create a C\\# class library in the Fleet Management solution:\n\n1.  In Visual Studio, click **File** &gt; **Open project/solution**.\n2.  In the **Open Project** dialog box, in the **File name** text box, type the following path, and then press **Enter** - *C:\\\\users\\\\public\\\\desktop\\\\FleetManagement*.\n3.  Select the file named FleetManagement.sln, and then click **Open**. If the solution file is not on your computer, the steps to create it are listed in [Tutorial: Create a Fleet Management solution file out of the Fleet Management models in the AOT](https://community.dynamics.com/ax/b/newdynamicsax/archive/2016/05/19/tutorial-create-a-fleet-management-solution-file-out-of-the-fleet-management-models-in-the-aot).[![OpenProject\\_LinqC](media/OpenProject_LinqC2.png)](media/OpenProject_LinqC2.png)\n4.  Right-click the **FleetManagement** solution, and then click **Add** &gt; **New Project**. The **Add New Project** dialog is displayed.\n5.  In the left pane, click **Visual C\\#**, and then in the middle pane, click **Class Library**.\n6.  At the bottom in the **Name** text box, type the name **DriversLicenseEvaluator**.\n7.  In the **Location** text box, type the following directory path: *C:\\\\users\\\\public\\\\desktop\\\\FleetManagement*.\n8.  Verify that your project is set to “.NET Framework 4.5” in the drop-down list at the top.\n9.  Click **OK** to create the project. [![AddNewProject\\_LinqC](media/AddNewProject_LinqC2.png)](media/AddNewProject_LinqC2.png)\n10. In **Solution Explorer**, under the DriversLicenseEvaluator project, right-click the file name Class1.cs and rename it DriversLicenseChecker.cs.\n11. Click **Yes**, when prompted to rename all references to the class. [![RenameClass\\_LinqC](media/RenameClass_LinqC1.png)](media/RenameClass_LinqC1.png)\n\n## Write a C\\# method named CheckDriversLicense\nIn this section, you add C\\# code for a method named CheckDriversLicense. The method must validate the driver’s license. To do this, the method must retrieve the driver’s license number, which is stored in the customer table. The method is given the RecId value for the customer record that contains the information required by the method. Your C\\# code uses the Dynamics AX LINQ provider to read from the customer table. For LINQ to work, you must first add references pointing to the LINQ assemblies. You add these references to the C\\# project named DriversLicenseEvaluator.\n\n1.  In **Solution Explorer**, expand the DriversLicenseEvaluator project node, right-click **References**, and then click **Add Reference**.\n2.  Click **Browse** and then enter the following path: C:\\\\Packages\\\\bin\n    -   *In some environments, the location of the packages folder is not on the c: drive.*\n\n3.  In the **File name** field, type the pattern \\*LINQ\\*.dll and then press **Enter**. You'll see a list of assemblies with the name LINQ in them. From that list, select the following files, and then click **Add**:\n    -   Microsoft.Dynamics.AX.Framework.Linq.Data.dll\n    -   Microsoft.Dynamics.AX.Framework.Linq.Data.Interface.dll\n    -   Microsoft.Dynamics.AX.Frameowrk.Linq.Data.Msil.dll\n\n    [![SelectReferences\\_LinqC](media/SelectReferences_LinqC1.png)](media/SelectReferences_LinqC1.png)\n4.  You must also add the support assemblies that contain the Common type that you'll use in the code below. Click **Browse** again, and then type the following file name into the field:\n    -   Microsoft.Dynamics.AX.Xpp.Support.dll\n    -   Microsoft.Dynamics.AX.Data.Core.dll\n\n5.  Click**Add**, and then click **OK**. The assemblies now appear under the references node in the project.\n6.  Repeat the **Add Reference** process, except this time, add the following DLL file from the indicated path:\n    -   Dynamics.Ax.FleetManagement.dll, in C:\\\\Packages\\\\FleetManagement\\\\bin\n\n7.  In **Solution Explorer**, select the reference Dynamics.Ax.FleetManagement.dll reference and set the property **Copy Local = False**.\n8.  In **Solution Explorer**, right-click **DriversLicenseChecker.cs**, and then click **View Code**.\n9.  Add the following three using statements to the **DriversLicenseEvaluator** namespace, to reduce the verbosity of code that references external classes. using Dynamics.AX.Application; using Microsoft.Dynamics.AX.Framework.Linq.Data; using Microsoft.Dynamics.AX.Xpp; Your C\\# code should now look something like the following example.\n\n        using System;\n        using System.Collections.Generic;\n        using System.Linq;\n        using System.Text;\n        using System.Threading.Tasks;\n\n        namespace DriversLicenseEvaluator\n        {\n          using Dynamics.AX.Application;\n          using Microsoft.Dynamics.AX.Framework.Linq.Data;\n          using Microsoft.Dynamics.Ax.Xpp;\n\n          public class DriversLicenseChecker\n          {\n          }\n        }\n\n10. Replace the class CheckDriversLicense with the following code. **Tip**: If you prefer, you can paste in the code from the DriversLicenseChecker.cs file in the C:\\\\FMLab directory.\n\n          public class DriversLicenseChecker\n          {\n            public static bool CheckDriversLicense(long customerId)\n            {\n              // Use LINQ to get back to the information about the license number\n              FMCustomer customer;\n              QueryProvider provider = new AXQueryProvider(null);\n              var customers = new QueryCollection<FMCustomer>(provider);\n\n              // Build the query (but do not execute it)\n              var query = from c in customers \n                    where c.RecId == customerId \n                    select c;\n\n              // Execute the query:\n              customer = query.FirstOrDefault();\n              if (customer == null)\n              {\n                throw new ArgumentException\n                  (\"The customerId does not designate a customer\");\n              }\n\n              if (string.IsNullOrEmpty(customer.DriverLicense))\n              {\n                // No driver's license was recorded. Veto the rental.\n                return false;\n              }\n\n              // Call the DOT web service to validate the license number.\n              // This is not practical for this lab, because all the service providers\n              // charge for this service. Instead, just assume that any license number\n              // that contains the sequence \"89\" is valid.\n              // In the demo data, this is true for Adrian Lannin,\n              // but not for Phil Spencer.\n              return customer.DriverLicense.Contains(\"89\");\n            }\n          }\n\n### Understand the LINQ code\n\nBefore proceeding with more C\\# code, verify that you understand the LINQ code you just added. More details about LINQ are provided in the [Technical Concepts Guide](http://ax.help.dynamics.com/en/wiki/technical-concepts-guide/), so only the basics are described below.\n\n-   First, a *provider* is created. It provides access to all the Microsoft Dynamics AX tables.\n-   Next, a *collection* of all customers is created. The customer of interest is retrieved from this collection.\n-   Then, a *query* is created with a where clause that designates the requested customer by **RecId**.\n-   The call to the FirstOrDefault method forces execution of the query.\n-   The method assigns the single matching customer to the customer variable. (Null is assigned if the RecId value matches no customer.)\n-   Finally, the customer data is tested to see if the associated driver's license is valid. (Does the license contain \"89\"?)\n\n## Handle the event when a record is added\nThe following subsections provide the following:\n\n-   Explain the upcoming code items and their inter-relationships.\n-   Show the code for an event handler.\n-   Associate the handler with the event occurrences.\n\n### Preparatory overview\n\nWhen an attempt is made to add a record to a table, the OnValidateWrite event is raised by Dynamics AX before the record is written to the database. You want your CheckDriversLicense method to be called each time on the OnValidtaedWrite event is raised for the FMREntal table. To do this, you now need to write a C\\# method that is invoked by the event, and which calls your checkDriversLicense method. In other words, you need to write an event handler that calls your CheckDriversLicense method. The event handler method receives a parameter of the type, DataEventArgs. The event handler can set a value in the DataEventArgs structure to accept or reject the record. After you write your event handler method, you connect it to the event by assigning, or additing it, to the OnValidatedWrite delegate that is a member of the FMRental table. You write this assignment in the init method of the data source of the FMRental form. This assignment to a delegate might seem odd. After all, we're modifying existing code (FMRental) to add handlers, which contradicts the main value proposition of loose coupling that eventing is supposed to offer. This assignment step is temporary. We'll eventually have the same story in C\\# as we do in X++, where an attribute is applied to the C\\# event handler as the mechanism that ties the delegate to the handler. **Note**: The data source init method is called when the form is opened. Technically, the init method is inherited from the FormDataSource class.\n\n### Write an event handler method\n\nIn C\\#, write the following event handler method and add it to the DriversLicenseChecker class.\n\n      public static void OnValidatedWriteHandler(Common table, DataEventArgs args)\n      {\n        var validateEventArgs = args as ValidateEventArgs;\n\n        // Do not check if already rejected.\n        if (validateEventArgs.parmValidateResult())\n        {\n          var rentalTable = table as FMRental;\n          if (rentalTable == null)\n          {\n            throw new ArgumentNullException(\"table\");\n          }\n\n          var result = CheckDriversLicense(rentalTable.Customer);\n          validateEventArgs.parmValidateResult(result);\n        }\n      }\n\nBuild the DriversLicenseEvaluator project by right-clicking the project node and then clicking **Build**.\n\n### Add a reference pointing to the DriversLIcenseEvaluator project\n\nCreate a reference from the X++ project named **FleetManagement Migrated** to the C\\# project named **DriversLicenseEvaluator**, by completing the following steps.\n\n1.  Right-click the FleetManagement Migrated project, click **Add**, and then click **Reference**. Select the row for the DriversLicenseEvaluator project in the **Projects** references tab, and then click **OK**. [![AddReference\\_LinqC](media/AddReference_LinqC1.png)](media/AddReference_LinqC1.png)\n2.  Under the FleetManagement Migrated project, expand the **References** node, and there you see new reference to the **DriversLicenseEvaluator** project.\n\n    #### [![SolutionExplorerReferences\\_LinqC](media/SolutionExplorerReferences_LinqC2.png)](media/SolutionExplorerReferences_LinqC2.png) Build sequence\n\n    Your C\\# DriversLicenseEvaluator project will be built before the FleetManagement Migrated project is built. This is because the added reference makes the Fleet project dependent on your project. The build sequence is easy to see if you right-click the FleetManagement solution, click **Project Build Order**, and then click **Dependencies**.\n\n    |                                                                                                                                                                                                                |                                                                                                                                                                                                                |\n    |----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n    | [![ProjectDependencies1\\_LinqC](media/ProjectDependencies1_LinqC2.png)](media/ProjectDependencies1_LinqC2.png) | [![ProjectDependencies2\\_LinqC](media/ProjectDependencies2_LinqC1.png)](media/ProjectDependencies2_LinqC1.png) |\n\n### Add your event handler to a delegate\n\n1.  In **Solution Explorer**, navigate to **FleetManagement Migrated &gt; User Interface &gt; Forms &gt; FMRental**.\n2.  Double-click the **FMRental** form. The Visual Studio designer opens to the form.\n3.  Expand the **Data Sources** node to show the data sources used in the form.\n4.  Expand the **FMRental** data source, and then the **Methods** node to list the methods defined on the data source.\n5.  Right-click **Methods**, and then click **Override &gt; init**. The list displays all of the methods on the data source that haven't yet been overridden. When you select **init**, this opens the file **FMRental.xpp** in the X++ code editor with the cursor near the template for the init method.\n6.  At the end of the **init** method body, use the += operator to add one assignment to a delegate.\n\n          FMRental.onValidatedWrite += eventhandler\n           (DriversLicenseEvaluator.DriversLicenseChecker::OnValidatedWriteHandler);\n\n7.  Click to save, and then build the entire solution.\n\n## Final test\nIn this section, you set breakpoints and run the Fleet application under the Visual Studio debugger. This enables you to prove the following:\n\n-   Your LINQ query runs when the OnValidateWrite event is raised.\n-   Your LINQ query successfully retrieves the data for one customer.\n\n### Prepare the test\n\n1.  In **Solution Explorer**, navigate to **FleetManagement Migrated &gt; User Interface &gt; Forms.**\n2.  Right-click **FMRental**, and then click **Set as Startup Object**.\n3.  In the code editor for DriversLicenseChecker.cs, find the OnValidateWriteHandler method. Find the following line of code.\n\n        var result = CheckDriversLicense(rentalTable.Customer);\n\n4.  Set a breakpoint on that line of code. You do this by clicking in the left margin at that line. A red dot displays when the breakpoint is set.\n5.  In the CheckDriversLicense method, set another breakpoint at the following line.\n\n        if (string.IsNullOrEmpty(customer.DriverLicense))\n\n### Run the test\n\nFor this test, we'll be debugging the C\\# code that we've written. To do this, we need to inform Visual Studio to load the symbols for the assembly that contains the C\\# code. Go to **Dynamics AX &gt; Options &gt; Debugging** and verify that the **Load symbols only for items in the solution** check box is not selected. [![Options\\_LinqC](media/Options_LinqC2.png)](media/Options_LinqC2.png) **Tip**: If you're unable to get to the breakpoint in the C\\# code, you may want to open the **Modules** window (**Debug &gt; Windows &gt; Modules**), find the C\\# module and load it explicitly.\n\n1.  Click **Debug &gt; Start Debugging**. This starts the Fleet application, and a browser window with the **FMRental** form is displayed.\n2.  Click on any **Vehicle rental ID** to view details.\n3.  Click the **Edit** icon near the top left of the form. The icon looks like a pencil.\n4.  In the **To** field of the **Rental** section, increase the date by one day.![FMRentalDetails]\n5.  Click the **Save** button. This causes the focus to shift to Visual Studio at your highlighted breakpoint. This line shows that the OnValidatedWrite event was raised, and that your handler method was called.\n6.  Press **F5** to continue the run. Instantly, your other breakpoint becomes highlighted.\n7.  Find the variable customer a few lines above your breakpoint.\n8.  Right-click the customer variable, and then click **QuickWatch**. Any long integer value proves that your LINQ query worked. [![QuickWatch\\_LinqC](media/QuickWatch_LinqC2.png)](media/QuickWatch_LinqC2.png)\n9.  Press **F5** to complete the **Save** operation.\n\n\n"}