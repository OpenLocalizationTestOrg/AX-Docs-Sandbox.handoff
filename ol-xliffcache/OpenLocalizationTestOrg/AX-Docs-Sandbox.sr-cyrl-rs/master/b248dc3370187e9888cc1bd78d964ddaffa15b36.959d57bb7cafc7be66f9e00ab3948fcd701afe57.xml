{"content":"---\n# required metadata\n\ntitle: Implement a return policy using triggers\ndescription: This topic has two examples which show how you can implement a new policy using a trigger.\nauthor: robinarh\nmanager: AnnBe\nms.date: 06/20/2017\nms.topic: article\nms.prod: \nms.service: dynamics-365-retail\nms.technology: \n\n# optional metadata\n\n# ms.search.form: \n# ROBOTS: \naudience: Developer\n# ms.devlang: \n# ms.reviewer: robinr\nms.search.scope: AX 7.0.0, Operations, Retail\n# ms.tgt_pltfrm: \nms.custom: 65863\nms.assetid: 539105e2-097d-4723-84a1-8084c2c32652\nms.search.region: Global\n# ms.search.industry: \nms.author: mumani\nms.search.validFrom: 2016-02-28\nms.dyn365.ops.version: AX 7.0.0, Retail July 2017 update\n\n---\n\n# Implement a return policy using triggers\n\n[!include[banner](../includes/banner.md)]\n\n\nThis topic has two examples which show how you can implement a new policy using a trigger.\n\nThe examples in this topic assume that you have a new return policy. The maximum time period for returning an item is 30 days and no item may be returned more than 30 days after the date of purchase. Additionally, the cashier or manager is not allowed to void more than three items in a single transaction.\n\n## Extend the MPOS trigger\n1.  Open Visual Studio as an administrator.\n2.  Open the ModernPOS solution from K:\\\\RainMainStab\\\\7.0.1265.3014\\\\retail\\\\Services\\\\RetailSDK\\\\Code\\\\POS.\n3.  Add new a TypeScript file in the POS.Core project, under the **Triggers** folder, and name it ExtensionTrigger.ts.\n4.  Add reference to the triggers interface and create a new module for the code. In the ExtensionTrigger.ts file, add the following code.\n\n        <///<reference path=\"TransactionTriggers.ts\" />\n        ///<reference path=\"TriggerHelper.ts\" />\n        ///<reference path=\"TriggerManager.ts\" />\n        ///<reference path=\"ApplicationTriggers.ts\" />\n        ///<reference path=\"ProductTriggers.ts\" />\n        ///<reference path=\"../IAsyncResult.ts\" />\n        ///<reference path=\"../Entities/CommerceTypes.g.ts\" />\n        ///<reference path='ITrigger.ts' />\n        module Commerce.Triggers.Samples {\n            \"use strict\";\n        }\n\n## Scenario 1: 30day return policy\nTo implement the 30-day return policy, extend the IPreConfrimReturnTransactionTrigger by creating a new class and implementing the IPreConfirmReturnTransactionTrigger interface. This trigger will be invoked before returning any item from the transaction.\n\n1.  Create a new class that implements IPreConfirmReturnTransactionTrigger in the module Commerce.Triggers.Samples. Name it PreConfirmReturnTransactionTrigger, as shown in the following code example.\n\n        /*** Implementation of a pre-confirm return transaction trigger that validates that the transaction being returned is within the return period. */\n        export class PreConfirmReturnTransactionTrigger implements IPreConfirmReturnTransactionTrigger {\n        }\n\n2.  Implement the **execute** method from the interface and add code to validate the return condition.\n\n        private static MILLISECONDS_PER_DAY: number = 100;\n        private static RETURN_PERIOD_IN_DAYS: number = 0;\n        private static RETURN_PERIOD_ENDED_ERROR_CODE: string = \"Cannot return, you are past return date\";\n        /*** Executes the trigger. */\n        public execute(options: IPreConfirmReturnTransactionTriggerOptions):     Commerce.IAsyncResult<Commerce.ICancelableResult> {\n            var timeDiff: number = Math.abs(new Date().getTime() - options.originalTransaction.BusinessDate.getTime());\n            var diffDays: number = Math.ceil(timeDiff / PreConfirmReturnTransactionTrigger.MILLISECONDS_PER_DAY);\n            if (diffDays > PreConfirmReturnTransactionTrigger.RETURN_PERIOD_IN_DAYS) {\n                var error: Proxy.Entities.Error = new     Proxy.Entities.Error(PreConfirmReturnTransactionTrigger.RETURN_PERIOD_ENDED_ERROR_CODE);\n                return Commerce.AsyncResult.createRejected([error]);\n            }\n            return Commerce.AsyncResult.createResolved({ canceled: false });\n        }\n\n## Scenario 2: Limit of three returns per transaction\nTo implement the three-time limit, create a new class and implement the IPreVoidProductsTrigger interface. This trigger will be invoked before voiding any item in a transaction.\n\n1.  Create a new class named PreVoidProductsTrigger that implements the IPreVoidProductsTrigger interface in the module Commerce.Triggers.Samples. Make sure this code is outside of the PreConfirmReturnTransactionTrigger class that you created in the previous step.\n\n        /*** Implementation of a pre-customer add trigger that is used to ensure a blocked customer is not added to sale. */\n        export class PreVoidProductsTrigger implements IPreVoidProductsTrigger {\n        }\n\n2.  Implement the **execute** method from the interface and add the code to validate the void condition.\n\n        private static VOID_ERROR_CODE: string = \"Void is not allowed anymore.\";\n        /*** Executes the trigger. */\n        public execute(options: IPreVoidProductsTriggerOptions): IAsyncResult<ICancelableResult> {\n            var result: AsyncResult<ICancelableResult> = new AsyncResult<ICancelableResult>(null);\n            if (!options.cartLines[0].IsVoided && this.getVoidedQuantity(options.cart) > 2) {\n                var error: Proxy.Entities.Error =\n                new Proxy.Entities.Error(PreVoidProductsTrigger.VOID_ERROR_CODE);\n                result.reject([error]);\n            } else {\n                result.resolve({ canceled: false });\n            }\n            return result;\n        }\n\n        private getVoidedQuantity(cart: Proxy.Entities.Cart): number {\n            var voidedQuantity: number = 0;\n            cart.CartLines.forEach((cartLine: Proxy.Entities.CartLine) => {\n            if (cartLine.IsVoided) {\n                voidedQuantity = voidedQuantity + 1;\n            }\n            });\n            return voidedQuantity;\n        }\n\n3.  Register the two triggers after the MPOS logon. Copy the following code to the same file after the two classes that you created in the previous steps but within the same module Commerce.Triggers.Samples.\n\n        /*** Implementation of a post log on trigger that is used to perform conditional registration of other triggers.*/\n        export class ConditionalRegistrationPostLogOnTrigger implements IPostLogOnTrigger {\n            private static alreadyRegistered: boolean = false;\n            /*** Executes the trigger.*/\n            public execute(options: IPostLogOnTriggerOptions): IVoidAsyncResult {\n                // Check to ensure the triggers have not already been registered.\n                if (!ConditionalRegistrationPostLogOnTrigger.alreadyRegistered) {\n                    this.performRegistration();\n                    // Set already registered field to true to prevent duplicate trigger registration.\n                    ConditionalRegistrationPostLogOnTrigger.alreadyRegistered = true;\n                }\n                return VoidAsyncResult.createResolved();\n            }\n\n            /*** Perform the conditional registration of triggers.*/\n            private performRegistration(): void {\n            var conditionIsMet: boolean = true;\n            TriggerManager.instance.register(\n                CancelableTriggerType.PreVoidProducts,\n                new PreVoidProductsTrigger());\n            if (conditionIsMet) {\n                TriggerManager.instance.register(\n                CancelableTriggerType.PreReturnTransaction,\n                new PreConfirmReturnTransactionTrigger());\n        }}}\n\n4.  Register the PostLogon trigger during the DOMCOntentLoaded event. Copy the following code outside of all the classes but within the module Commerce.Triggers.Samples.\n\n        /**\n        * Trigger types that do not support conditional registration should be registered when the DOMContentLoaded event is fired.\n        * @remarks These trigger types include: ApplicationStart, PreLogOn, and PostLogOn.\n        */\n        document.addEventListener(\"DOMContentLoaded\", function (): void {\n            Commerce.Triggers.TriggerManager.instance.register(\n            Commerce.Triggers.NonCancelableTriggerType.PostLogOn,\n            new Commerce.Triggers.Samples.ConditionalRegistrationPostLogOnTrigger());\n        });\n\n## Build the project\n1.  Compile and rebuild the project.\n2.  Deploy the MPOS in Local Machine by clicking the **Deploy** button in Visual Studio. If you get an error which states that “The project POS.App needs to be deployed before it can be started.”, then follow the steps below to resolve the error and try again.\n3.  Right-click the ModernPOS solution in Visual Studio and click **Properties**.\n4.  In the **Property** window, select **Configuration**.\n5.  Select the **Deploy** check box for the Pos.App project and click **OK**.\n\n## Validate the customization\n1.  Log in to MPOS using 000160 as the operator ID and 123 as the password. Complete a sales transaction.\n2.  Click **Show Journal** and try to return the merchandise. You will get the error message “Cannot return, you are past return date”.\n3.  Create another new transaction and add four different items. Try to return all four items. You will get an error for the fourth item with the message, \"Void is not allowed anymore.”\n\n**Note:** In the sample code, the return the time period is configured as 100ms, so that you can test your code immediately. You should change the configuration as needed.\n\n\n\n","nodes":[{"content":"Implement a return policy using triggers","nodes":[{"pos":[0,40],"content":"Implement a return policy using triggers","nodes":[{"content":"Implement a return policy using triggers","pos":[0,40]}]}],"pos":[31,72],"yaml":true},{"content":"This topic has two examples which show how you can implement a new policy using a trigger.","nodes":[{"pos":[0,90],"content":"This topic has two examples which show how you can implement a new policy using a trigger.","nodes":[{"content":"This topic has two examples which show how you can implement a new policy using a trigger.","pos":[0,90]}]}],"pos":[85,176],"yaml":true},{"pos":[707,747],"content":"Implement a return policy using triggers","linkify":"Implement a return policy using triggers","nodes":[{"content":"Implement a return policy using triggers","pos":[0,40]}]},{"content":"This topic has two examples which show how you can implement a new policy using a trigger.","pos":[793,883]},{"content":"The examples in this topic assume that you have a new return policy.","pos":[885,953]},{"content":"The maximum time period for returning an item is 30 days and no item may be returned more than 30 days after the date of purchase.","pos":[954,1084]},{"content":"Additionally, the cashier or manager is not allowed to void more than three items in a single transaction.","pos":[1085,1191]},{"pos":[1196,1219],"content":"Extend the MPOS trigger","linkify":"Extend the MPOS trigger","nodes":[{"content":"Extend the MPOS trigger","pos":[0,23]}]},{"content":"Open Visual Studio as an administrator.","pos":[1224,1263]},{"content":"Open the ModernPOS solution from K:<ph id=\"ph1\">\\\\</ph>RainMainStab<ph id=\"ph2\">\\\\</ph>7.0.1265.3014<ph id=\"ph3\">\\\\</ph>retail<ph id=\"ph4\">\\\\</ph>Services<ph id=\"ph5\">\\\\</ph>RetailSDK<ph id=\"ph6\">\\\\</ph>Code<ph id=\"ph7\">\\\\</ph>POS.","pos":[1268,1373],"source":"Open the ModernPOS solution from K:\\\\RainMainStab\\\\7.0.1265.3014\\\\retail\\\\Services\\\\RetailSDK\\\\Code\\\\POS."},{"pos":[1378,1492],"content":"Add new a TypeScript file in the POS.Core project, under the <bpt id=\"p1\">**</bpt>Triggers<ept id=\"p1\">**</ept> folder, and name it ExtensionTrigger.ts.","source":"Add new a TypeScript file in the POS.Core project, under the **Triggers** folder, and name it ExtensionTrigger.ts."},{"content":"Add reference to the triggers interface and create a new module for the code.","pos":[1497,1574]},{"content":"In the ExtensionTrigger.ts file, add the following code.","pos":[1575,1631]},{"pos":[2135,2166],"content":"Scenario 1: 30day return policy","linkify":"Scenario 1: 30day return policy","nodes":[{"content":"Scenario 1: 30day return policy","pos":[0,31]}]},{"content":"To implement the 30-day return policy, extend the IPreConfrimReturnTransactionTrigger by creating a new class and implementing the IPreConfirmReturnTransactionTrigger interface.","pos":[2167,2344]},{"content":"This trigger will be invoked before returning any item from the transaction.","pos":[2345,2421]},{"content":"Create a new class that implements IPreConfirmReturnTransactionTrigger in the module Commerce.Triggers.Samples.","pos":[2427,2538]},{"content":"Name it PreConfirmReturnTransactionTrigger, as shown in the following code example.","pos":[2539,2622]},{"pos":[2899,2997],"content":"Implement the <bpt id=\"p1\">**</bpt>execute<ept id=\"p1\">**</ept> method from the interface and add code to validate the return condition.","source":"Implement the **execute** method from the interface and add code to validate the return condition."},{"pos":[4036,4086],"content":"Scenario 2: Limit of three returns per transaction","linkify":"Scenario 2: Limit of three returns per transaction","nodes":[{"content":"Scenario 2: Limit of three returns per transaction","pos":[0,50]}]},{"content":"To implement the three-time limit, create a new class and implement the IPreVoidProductsTrigger interface.","pos":[4087,4193]},{"content":"This trigger will be invoked before voiding any item in a transaction.","pos":[4194,4264]},{"content":"Create a new class named PreVoidProductsTrigger that implements the IPreVoidProductsTrigger interface in the module Commerce.Triggers.Samples.","pos":[4270,4412]},{"content":"Make sure this code is outside of the PreConfirmReturnTransactionTrigger class that you created in the previous step.","pos":[4413,4530]},{"pos":[4753,4853],"content":"Implement the <bpt id=\"p1\">**</bpt>execute<ept id=\"p1\">**</ept> method from the interface and add the code to validate the void condition.","source":"Implement the **execute** method from the interface and add the code to validate the void condition."},{"content":"Register the two triggers after the MPOS logon.","pos":[5925,5972]},{"content":"Copy the following code to the same file after the two classes that you created in the previous steps but within the same module Commerce.Triggers.Samples.","pos":[5973,6128]},{"content":"Register the PostLogon trigger during the DOMCOntentLoaded event.","pos":[7557,7622]},{"content":"Copy the following code outside of all the classes but within the module Commerce.Triggers.Samples.","pos":[7623,7722]},{"pos":[8276,8293],"content":"Build the project","linkify":"Build the project","nodes":[{"content":"Build the project","pos":[0,17]}]},{"content":"Compile and rebuild the project.","pos":[8298,8330]},{"content":"Deploy the MPOS in Local Machine by clicking the <bpt id=\"p1\">**</bpt>Deploy<ept id=\"p1\">**</ept> button in Visual Studio.","pos":[8335,8419],"source":"Deploy the MPOS in Local Machine by clicking the **Deploy** button in Visual Studio."},{"content":"If you get an error which states that “The project POS.App needs to be deployed before it can be started.”, then follow the steps below to resolve the error and try again.","pos":[8420,8591]},{"pos":[8596,8673],"content":"Right-click the ModernPOS solution in Visual Studio and click <bpt id=\"p1\">**</bpt>Properties<ept id=\"p1\">**</ept>.","source":"Right-click the ModernPOS solution in Visual Studio and click **Properties**."},{"pos":[8678,8731],"content":"In the <bpt id=\"p1\">**</bpt>Property<ept id=\"p1\">**</ept> window, select <bpt id=\"p2\">**</bpt>Configuration<ept id=\"p2\">**</ept>.","source":"In the **Property** window, select **Configuration**."},{"pos":[8736,8809],"content":"Select the <bpt id=\"p1\">**</bpt>Deploy<ept id=\"p1\">**</ept> check box for the Pos.App project and click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>.","source":"Select the **Deploy** check box for the Pos.App project and click **OK**."},{"pos":[8814,8840],"content":"Validate the customization","linkify":"Validate the customization","nodes":[{"content":"Validate the customization","pos":[0,26]}]},{"content":"Log in to MPOS using 000160 as the operator ID and 123 as the password.","pos":[8845,8916]},{"content":"Complete a sales transaction.","pos":[8917,8946]},{"content":"Click <bpt id=\"p1\">**</bpt>Show Journal<ept id=\"p1\">**</ept> and try to return the merchandise.","pos":[8951,9008],"source":"Click **Show Journal** and try to return the merchandise."},{"content":"You will get the error message “Cannot return, you are past return date”.","pos":[9009,9082]},{"content":"Create another new transaction and add four different items.","pos":[9087,9147]},{"content":"Try to return all four items.","pos":[9148,9177]},{"content":"You will get an error for the fourth item with the message, \"Void is not allowed anymore.”","pos":[9178,9268]},{"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept> In the sample code, the return the time period is configured as 100ms, so that you can test your code immediately.","pos":[9270,9394],"source":"**Note:** In the sample code, the return the time period is configured as 100ms, so that you can test your code immediately."},{"content":"You should change the configuration as needed.","pos":[9395,9441]}]}