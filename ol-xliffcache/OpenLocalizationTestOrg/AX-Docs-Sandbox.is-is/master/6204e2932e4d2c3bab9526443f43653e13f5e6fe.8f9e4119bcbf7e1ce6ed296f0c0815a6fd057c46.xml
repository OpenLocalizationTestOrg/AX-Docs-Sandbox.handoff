{"nodes":[{"pos":[32,78],"content":"Modern POS and Cloud POS trigger extensibility","needQuote":true,"needEscape":true,"nodes":[{"content":"Modern POS and Cloud POS trigger extensibility","pos":[0,46]}]},{"pos":[92,180],"content":"This article explains the client-side trigger functionality in Modern POS and Cloud POS.","needQuote":true,"needEscape":true,"nodes":[{"content":"This article explains the client-side trigger functionality in Modern POS and Cloud POS.","pos":[0,88]}]},{"pos":[681,727],"content":"Modern POS and Cloud POS trigger extensibility","linkify":"Modern POS and Cloud POS trigger extensibility","nodes":[{"content":"Modern POS and Cloud POS trigger extensibility","pos":[0,46]}]},{"content":"This article explains the client-side trigger functionality in Modern POS and Cloud POS.","pos":[729,817]},{"pos":[819,835],"content":"Trigger overview","linkify":"Trigger overview","nodes":[{"content":"Trigger overview","pos":[0,16]}]},{"content":"Triggers are events that are raised by Microsoft Dynamics 365 for Operations for Retail POS.","pos":[854,946]},{"content":"Triggers let you insert custom code before or after operations.","pos":[947,1010]},{"content":"There are two kinds of triggers: pre-triggers and post-triggers.","pos":[1011,1075]},{"content":"Pre-triggers","pos":[1079,1091]},{"content":"Post-triggers","pos":[1337,1350]},{"content":"Pre-triggers can be used to insert custom code before an operation is run.","pos":[2125,2199]},{"content":"For example, if a customer uses a coupon for a purchase, you can use a pre-trigger to insert custom code to validate that the coupon hasn't expired and hasn't previously been used.","pos":[2200,2380]},{"content":"Post-triggers can be used to insert custom code that responds to a completed operation.","pos":[2383,2470]},{"content":"For example, you can write code that runs after the <bpt id=\"p1\">**</bpt>CustomerAdd<ept id=\"p1\">**</ept> operation and prompts the cashier to wish the customer a happy birthday if it's the customer’s birthday.","pos":[2471,2643],"source":" For example, you can write code that runs after the **CustomerAdd** operation and prompts the cashier to wish the customer a happy birthday if it's the customer’s birthday."},{"pos":[2651,2664],"content":"Trigger types","linkify":"Trigger types","nodes":[{"content":"Trigger types","pos":[0,13]}]},{"content":"In Modern POS and Cloud POS, triggers are either cancelable or non-cancelable.","pos":[2666,2744]},{"content":"Cancelable","pos":[2748,2758]},{"content":"Non-cancelable","pos":[3158,3172]},{"content":"Trigger implementations that extend <bpt id=\"p1\">**</bpt>ICancelableTriggerCancelable<ept id=\"p1\">**</ept> triggers can succeed, fail, or be canceled.","pos":[4270,4382],"source":"Trigger implementations that extend **ICancelableTriggerCancelable** triggers can succeed, fail, or be canceled."},{"content":"Execution of the workflow is canceled without displaying an error.","pos":[4383,4449]},{"content":"An example is a trigger to confirm that the user wants to use his or her loyalty points for tender.","pos":[4450,4549]},{"content":"If the user selects <bpt id=\"p1\">**</bpt>No<ept id=\"p1\">**</ept>, the workflow to enter loyalty information is canceled without showing an error message to the user.","pos":[4550,4677],"source":" If the user selects **No**, the workflow to enter loyalty information is canceled without showing an error message to the user."},{"content":"Trigger implementations that extend <bpt id=\"p1\">**</bpt>ITriggerNon-cancelable<ept id=\"p1\">**</ept> triggers can either succeed or fail.","pos":[4680,4779],"source":"Trigger implementations that extend **ITriggerNon-cancelable** triggers can either succeed or fail."},{"content":"If the trigger succeeds, the workflow continues.","pos":[4780,4828]},{"content":"If the trigger fails, a message appears in the UI.","pos":[4829,4879]},{"content":"An example is a trigger to support Swedish localization requirements by guiding the cashier to create separate transactions for sales and returns.","pos":[4880,5026]},{"pos":[5034,5044],"content":"Guidelines","linkify":"Guidelines","nodes":[{"content":"Guidelines","pos":[0,10]}]},{"content":"<bpt id=\"p1\">**</bpt>Trigger registration<ept id=\"p1\">**</ept> – All triggers should be registered by using the <bpt id=\"p2\">**</bpt>TriggerManager::register<ept id=\"p2\">**</ept> method.","pos":[5050,5160],"source":"**Trigger registration** – All triggers should be registered by using the **TriggerManager::register** method."},{"content":"The <bpt id=\"p1\">**</bpt>ApplicationStart<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>PreLogOn<ept id=\"p2\">**</ept>, and <bpt id=\"p3\">**</bpt>PostLogOn<ept id=\"p3\">**</ept> triggers must be registered inside a function that is called when the <bpt id=\"p4\">**</bpt>DOMContentLoaded<ept id=\"p4\">**</ept> event is raised.","pos":[5161,5326],"source":" The **ApplicationStart**, **PreLogOn**, and **PostLogOn** triggers must be registered inside a function that is called when the **DOMContentLoaded** event is raised."},{"content":"Other triggers can be registered in the same manner, but they can also be registered conditionally.","pos":[5327,5426]},{"content":"<bpt id=\"p1\">**</bpt>Conditional registration<ept id=\"p1\">**</ept> – If the decision about whether to register a trigger is based on information in the channel, the trigger can be registered conditionally.","pos":[5435,5602],"source":"**Conditional registration** – If the decision about whether to register a trigger is based on information in the channel, the trigger can be registered conditionally."},{"content":"Conditional registration should be performed inside a <bpt id=\"p1\">**</bpt>PostLogOn<ept id=\"p1\">**</ept> trigger.","pos":[5603,5679],"source":" Conditional registration should be performed inside a **PostLogOn** trigger."},{"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept> It's important that the conditional registration be performed only during the first sign-in after the app has been loaded.","pos":[5680,5812],"source":"**Note:** It's important that the conditional registration be performed only during the first sign-in after the app has been loaded."},{"content":"For an example implementation, see the sample code later in this article.","pos":[5813,5886]},{"content":"<bpt id=\"p1\">**</bpt>Trigger implementation<ept id=\"p1\">**</ept> – Each trigger event that is listed in the \"Supported trigger events\" section has a trigger interface that is associated with it.","pos":[5891,6047],"source":"**Trigger implementation** – Each trigger event that is listed in the \"Supported trigger events\" section has a trigger interface that is associated with it."},{"content":"These trigger interfaces define the contract between the application and the trigger implementations.","pos":[6048,6149]},{"content":"Each trigger should implement the predefined interface that is associated with the trigger event type that it's registered for.","pos":[6150,6277]},{"pos":[6283,6310],"content":"Triggers execution workflow","linkify":"Triggers execution workflow","nodes":[{"content":"Triggers execution workflow","pos":[0,27]}]},{"pos":[6312,6452],"content":"The following diagram shows the execution workflow for both pre-triggers and post-triggers for the <bpt id=\"p1\">**</bpt>ItemSaleOperation<ept id=\"p1\">**</ept> workflow/operation.","source":"The following diagram shows the execution workflow for both pre-triggers and post-triggers for the **ItemSaleOperation** workflow/operation."},{"pos":[6455,6554],"content":"<bpt id=\"p1\">[</bpt><ph id=\"ph1\">![</ph>Trigger Execution Flow<ept id=\"p1\">](./media/trigger-execution-flow.png)](./media/trigger-execution-flow.png)</ept>","source":"[![Trigger Execution Flow](./media/trigger-execution-flow.png)](./media/trigger-execution-flow.png)"},{"pos":[6560,6584],"content":"Supported trigger events","linkify":"Supported trigger events","nodes":[{"content":"Supported trigger events","pos":[0,24]}]},{"content":"Together with pre-operation and post-operation triggers that are triggered for every operation, the following triggers are supported out of the box:","pos":[6586,6734]},{"content":"Application triggers","pos":[6740,6760]},{"content":"Cancelable","pos":[6769,6779]},{"pos":[6792,6842],"content":"<bpt id=\"p1\">**</bpt>PreLogOn<ept id=\"p1\">**</ept> – Called before sign-in to Modern POS","source":"**PreLogOn** – Called before sign-in to Modern POS"},{"content":"operatorId","pos":[6859,6869]},{"content":"Non-cancelable","pos":[6878,6892]},{"pos":[6905,6967],"content":"<bpt id=\"p1\">**</bpt>ApplicationStart<ept id=\"p1\">**</ept> – Called when the application is launched","source":"**ApplicationStart** – Called when the application is launched"},{"pos":[6980,7045],"content":"<bpt id=\"p1\">**</bpt>ApplicationSuspend<ept id=\"p1\">**</ept> – Called when the application is suspended","source":"**ApplicationSuspend** – Called when the application is suspended"},{"pos":[7058,7123],"content":"<bpt id=\"p1\">**</bpt>PostLogOff<ept id=\"p1\">**</ept> – Called after the sign-out operation is completed","source":"**PostLogOff** – Called after the sign-out operation is completed"},{"pos":[7136,7199],"content":"<bpt id=\"p1\">**</bpt>PostLogOn<ept id=\"p1\">**</ept> – Called after the sign-in operation is completed","source":"**PostLogOn** – Called after the sign-in operation is completed"},{"content":"Cash management triggers","pos":[7204,7228]},{"content":"Cancelable","pos":[7237,7247]},{"pos":[7260,7340],"content":"<bpt id=\"p1\">**</bpt>PreTenderDeclaration<ept id=\"p1\">**</ept> – Called before the tender declaration operation is run","source":"**PreTenderDeclaration** – Called before the tender declaration operation is run"},{"content":"Non-cancelable","pos":[7349,7363]},{"pos":[7376,7462],"content":"<bpt id=\"p1\">**</bpt>PostTenderDeclaration<ept id=\"p1\">**</ept> – Called as the last step in the tender declaration workflow","source":"**PostTenderDeclaration** – Called as the last step in the tender declaration workflow"},{"content":"Customer triggers","pos":[7467,7484]},{"content":"Cancelable","pos":[7493,7503]},{"pos":[7516,7576],"content":"<bpt id=\"p1\">**</bpt>PreCustomerAdd<ept id=\"p1\">**</ept> – Called before a new customer is created","source":"**PreCustomerAdd** – Called before a new customer is created"},{"pos":[7589,7678],"content":"<bpt id=\"p1\">**</bpt>PreCustomerClear<ept id=\"p1\">**</ept> – Called before the customer is cleared from the current transaction","source":"**PreCustomerClear** – Called before the customer is cleared from the current transaction"},{"pos":[7691,7752],"content":"<bpt id=\"p1\">**</bpt>PreCustomerSearch<ept id=\"p1\">**</ept> – Called before a search for a customer","source":"**PreCustomerSearch** – Called before a search for a customer"},{"pos":[7765,7838],"content":"<bpt id=\"p1\">**</bpt>PreCustomerSet<ept id=\"p1\">**</ept> – Called before the customer is set on the transaction","source":"**PreCustomerSet** – Called before the customer is set on the transaction"},{"content":"Non-cancelable","pos":[7847,7861]},{"pos":[7874,7934],"content":"<bpt id=\"p1\">**</bpt>PostCustomerAdd<ept id=\"p1\">**</ept> – Called after a new customer is created","source":"**PostCustomerAdd** – Called after a new customer is created"},{"pos":[7947,8028],"content":"<bpt id=\"p1\">**</bpt>PostCustomerClear<ept id=\"p1\">**</ept> – Called after the customer is cleared from the transaction","source":"**PostCustomerClear** – Called after the customer is cleared from the transaction"},{"pos":[8041,8102],"content":"<bpt id=\"p1\">**</bpt>PostCustomerSearch<ept id=\"p1\">**</ept> – Called after a search for a customer","source":"**PostCustomerSearch** – Called after a search for a customer"},{"content":"Discount triggers","pos":[8107,8124]},{"content":"Cancelable","pos":[8133,8143]},{"pos":[8156,8295],"content":"<bpt id=\"p1\">**</bpt>PreLineDiscountAmount<ept id=\"p1\">**</ept> – Called during the line discount amount operation, after validation determines whether a discount can be applied","source":"**PreLineDiscountAmount** – Called during the line discount amount operation, after validation determines whether a discount can be applied"},{"pos":[8308,8449],"content":"<bpt id=\"p1\">**</bpt>PreLineDiscountPercent<ept id=\"p1\">**</ept> – Called during the line discount percent operation, after validation determines whether a discount can be applied","source":"**PreLineDiscountPercent** – Called during the line discount percent operation, after validation determines whether a discount can be applied"},{"pos":[8462,8603],"content":"<bpt id=\"p1\">**</bpt>PreTotalDiscountAmount<ept id=\"p1\">**</ept> – Called during the total discount amount operation, after validation determines whether a discount can be applied","source":"**PreTotalDiscountAmount** – Called during the total discount amount operation, after validation determines whether a discount can be applied"},{"pos":[8616,8759],"content":"<bpt id=\"p1\">**</bpt>PreTotalDiscountPercent<ept id=\"p1\">**</ept> – Called during the total discount percent operation, after validation determines whether a discount can be applied","source":"**PreTotalDiscountPercent** – Called during the total discount percent operation, after validation determines whether a discount can be applied"},{"content":"Non-cancelable","pos":[8768,8782]},{"pos":[8795,8884],"content":"<bpt id=\"p1\">**</bpt>PostLineDiscountAmount<ept id=\"p1\">**</ept> - Called as the last step in the line discount amount workflow","source":"**PostLineDiscountAmount** - Called as the last step in the line discount amount workflow"},{"pos":[8897,8988],"content":"<bpt id=\"p1\">**</bpt>PostLineDiscountPercent<ept id=\"p1\">**</ept> – Called as the last step in the line discount percent workflow","source":"**PostLineDiscountPercent** – Called as the last step in the line discount percent workflow"},{"pos":[9001,9092],"content":"<bpt id=\"p1\">**</bpt>PostTotalDiscountAmount<ept id=\"p1\">**</ept> – Called as the last step in the total discount amount workflow","source":"**PostTotalDiscountAmount** – Called as the last step in the total discount amount workflow"},{"pos":[9105,9198],"content":"<bpt id=\"p1\">**</bpt>PostTotalDiscountPercent<ept id=\"p1\">**</ept> – Called as the last step in the total discount percent workflow","source":"**PostTotalDiscountPercent** – Called as the last step in the total discount percent workflow"},{"content":"Operation triggers","pos":[9203,9221]},{"content":"Cancelable","pos":[9230,9240]},{"pos":[9253,9356],"content":"<bpt id=\"p1\">**</bpt>PreOperation<ept id=\"p1\">**</ept> – Called before every operation is run, before the prehandler and operation validators","source":"**PreOperation** – Called before every operation is run, before the prehandler and operation validators"},{"content":"Non-cancelable","pos":[9365,9379]},{"pos":[9392,9490],"content":"<bpt id=\"p1\">**</bpt>OperationFailure<ept id=\"p1\">**</ept> – Called when an operation fails, and can be used to perform recovery actions","source":"**OperationFailure** – Called when an operation fails, and can be used to perform recovery actions"},{"pos":[9503,9573],"content":"<bpt id=\"p1\">**</bpt>PostOperation<ept id=\"p1\">**</ept> – Called when an operation is completed successfully","source":"**PostOperation** – Called when an operation is completed successfully"},{"content":"Payment triggers","pos":[9578,9594]},{"content":"Cancelable","pos":[9603,9613]},{"pos":[9626,9704],"content":"<bpt id=\"p1\">**</bpt>PreAddTenderLine<ept id=\"p1\">**</ept> – Called before a tender line is added to the transaction","source":"**PreAddTenderLine** – Called before a tender line is added to the transaction"},{"pos":[9717,9780],"content":"<bpt id=\"p1\">**</bpt>PrePayment<ept id=\"p1\">**</ept> – Called before any payment operation is started","source":"**PrePayment** – Called before any payment operation is started"},{"pos":[9793,9865],"content":"<bpt id=\"p1\">**</bpt>PreVoidPayment<ept id=\"p1\">**</ept> – Called before the void payment operation is started","source":"**PreVoidPayment** – Called before the void payment operation is started"},{"content":"Non-cancelable","pos":[9874,9888]},{"pos":[9901,9958],"content":"<bpt id=\"p1\">**</bpt>PostPayment<ept id=\"p1\">**</ept> – Called after the payment has been added","source":"**PostPayment** – Called after the payment has been added"},{"pos":[9971,10033],"content":"<bpt id=\"p1\">**</bpt>PostVoidPayment<ept id=\"p1\">**</ept> – Called after the payment has been voided","source":"**PostVoidPayment** – Called after the payment has been voided"},{"content":"Printing triggers","pos":[10038,10055]},{"content":"Cancelable","pos":[10064,10074]},{"pos":[10087,10159],"content":"<bpt id=\"p1\">**</bpt>PrePrintReceiptCopy<ept id=\"p1\">**</ept> – Called before a copy of the receipt is printed","source":"**PrePrintReceiptCopy** – Called before a copy of the receipt is printed"},{"content":"Product Triggers","pos":[10164,10180]},{"content":"Cancelable","pos":[10189,10199]},{"pos":[10212,10277],"content":"<bpt id=\"p1\">**</bpt>PreClearQuantity<ept id=\"p1\">**</ept> – Called before the clear quantity operation","source":"**PreClearQuantity** – Called before the clear quantity operation"},{"pos":[10290,10355],"content":"<bpt id=\"p1\">**</bpt>PrePriceOverride<ept id=\"p1\">**</ept> – Called before the price override operation","source":"**PrePriceOverride** – Called before the price override operation"},{"pos":[10368,10426],"content":"<bpt id=\"p1\">**</bpt>PreProductSale<ept id=\"p1\">**</ept> – Called before the item sale operation","source":"**PreProductSale** – Called before the item sale operation"},{"pos":[10439,10504],"content":"<bpt id=\"p1\">**</bpt>PreReturnProduct<ept id=\"p1\">**</ept> – Called before the return product operation","source":"**PreReturnProduct** – Called before the return product operation"},{"pos":[10517,10578],"content":"<bpt id=\"p1\">**</bpt>PreSetQuantity<ept id=\"p1\">**</ept> – Called before the set quantity operation","source":"**PreSetQuantity** – Called before the set quantity operation"},{"pos":[10591,10726],"content":"<bpt id=\"p1\">**</bpt>PreVoidProducts<ept id=\"p1\">**</ept> – Called after the user confirms that he or she wants to void the transaction, but before the transaction is voided","source":"**PreVoidProducts** – Called after the user confirms that he or she wants to void the transaction, but before the transaction is voided"},{"content":"Non-cancelable","pos":[10735,10749]},{"pos":[10762,10827],"content":"<bpt id=\"p1\">**</bpt>PostClearQuantity<ept id=\"p1\">**</ept> – Called after the clear quantity operation","source":"**PostClearQuantity** – Called after the clear quantity operation"},{"pos":[10840,10905],"content":"<bpt id=\"p1\">**</bpt>PostPriceOverride<ept id=\"p1\">**</ept> – Called after the price override operation","source":"**PostPriceOverride** – Called after the price override operation"},{"pos":[10918,10976],"content":"<bpt id=\"p1\">**</bpt>PostProductSale<ept id=\"p1\">**</ept> – Called after the item sale operation","source":"**PostProductSale** – Called after the item sale operation"},{"pos":[10989,11054],"content":"<bpt id=\"p1\">**</bpt>PostReturnProduct<ept id=\"p1\">**</ept> – Called after the return product operation","source":"**PostReturnProduct** – Called after the return product operation"},{"pos":[11067,11128],"content":"<bpt id=\"p1\">**</bpt>PostSetQuantity<ept id=\"p1\">**</ept> – Called after the set quantity operation","source":"**PostSetQuantity** – Called after the set quantity operation"},{"pos":[11141,11204],"content":"<bpt id=\"p1\">**</bpt>PostVoidProducts<ept id=\"p1\">**</ept> – Called after the void products operation","source":"**PostVoidProducts** – Called after the void products operation"},{"content":"Transaction triggers","pos":[11209,11229]},{"content":"Cancelable","pos":[11238,11248]},{"pos":[11261,11402],"content":"<bpt id=\"p1\">**</bpt>PreConfirmReturnTransaction<ept id=\"p1\">**</ept> – Called after a search for a transaction to return, but before the cart lines appear as available for return","source":"**PreConfirmReturnTransaction** – Called after a search for a transaction to return, but before the cart lines appear as available for return"},{"pos":[11415,11485],"content":"<bpt id=\"p1\">**</bpt>PreEndTransaction<ept id=\"p1\">**</ept> – Called before a sales transaction is completed","source":"**PreEndTransaction** – Called before a sales transaction is completed"},{"pos":[11498,11564],"content":"<bpt id=\"p1\">**</bpt>PreRecallTransaction<ept id=\"p1\">**</ept> – Called before a transaction is recalled","source":"**PreRecallTransaction** – Called before a transaction is recalled"},{"pos":[11577,11643],"content":"<bpt id=\"p1\">**</bpt>PreReturnTransaction<ept id=\"p1\">**</ept> – Called before a transaction is returned","source":"**PreReturnTransaction** – Called before a transaction is returned"},{"pos":[11656,11724],"content":"<bpt id=\"p1\">**</bpt>PreSuspendTransaction<ept id=\"p1\">**</ept> – Called before a transaction is suspended","source":"**PreSuspendTransaction** – Called before a transaction is suspended"},{"pos":[11737,11799],"content":"<bpt id=\"p1\">**</bpt>PreVoidTransaction<ept id=\"p1\">**</ept> – Called before a transaction is voided","source":"**PreVoidTransaction** – Called before a transaction is voided"},{"content":"Non-cancelable","pos":[11808,11822]},{"pos":[11835,11918],"content":"<bpt id=\"p1\">**</bpt>BeginTransaction<ept id=\"p1\">**</ept> – Called before a cart is created and a transaction is started","source":"**BeginTransaction** – Called before a cart is created and a transaction is started"},{"pos":[11931,12001],"content":"<bpt id=\"p1\">**</bpt>PostEndTransaction<ept id=\"p1\">**</ept> – Called after a sales transaction is completed","source":"**PostEndTransaction** – Called after a sales transaction is completed"},{"pos":[12014,12080],"content":"<bpt id=\"p1\">**</bpt>PostRecallTransaction<ept id=\"p1\">**</ept> – Called after a transaction is recalled","source":"**PostRecallTransaction** – Called after a transaction is recalled"},{"pos":[12093,12191],"content":"<bpt id=\"p1\">**</bpt>PostReturnTransaction<ept id=\"p1\">**</ept> – Called after items from a transaction are added to the cart for return","source":"**PostReturnTransaction** – Called after items from a transaction are added to the cart for return"},{"pos":[12204,12270],"content":"<bpt id=\"p1\">**</bpt>PostSuspendTransaction<ept id=\"p1\">**</ept> – Called after suspending a transaction","source":"**PostSuspendTransaction** – Called after suspending a transaction"},{"pos":[12283,12345],"content":"<bpt id=\"p1\">**</bpt>PostVoidTransaction<ept id=\"p1\">**</ept> – Called after a transaction is voided","source":"**PostVoidTransaction** – Called after a transaction is voided"},{"pos":[12350,12380],"content":"Trigger example implementation","linkify":"Trigger example implementation","nodes":[{"content":"Trigger example implementation","pos":[0,30]}]},{"content":"The best way to understand triggers is to look at a sample implementation scenario.","pos":[12381,12464]},{"pos":[12470,12565],"content":"Modern POS/Cloud POS changes to support Swedish localization requirements by using POS triggers","linkify":"Modern POS/Cloud POS changes to support Swedish localization requirements by using POS triggers","nodes":[{"content":"Modern POS/Cloud POS changes to support Swedish localization requirements by using POS triggers","pos":[0,95]}]},{"content":"Transactions can't have both return and sale operations if a fiscal register is connected.","pos":[12567,12657]},{"content":"An <bpt id=\"p1\">**</bpt>IPreProductSaleTrigger<ept id=\"p1\">**</ept> trigger is implemented to detect this situation if it occurs and to show a message to prompt the cashier.","pos":[12658,12793],"source":" An **IPreProductSaleTrigger** trigger is implemented to detect this situation if it occurs and to show a message to prompt the cashier."},{"content":"This is a requirement in Sweden.","pos":[12794,12826]},{"pos":[12832,12945],"content":"Implement an <bpt id=\"p1\">**</bpt>IPreProductSaleTrigger<ept id=\"p1\">**</ept> trigger to detect the situation and show a message to prompt the cashier.","source":"Implement an **IPreProductSaleTrigger** trigger to detect the situation and show a message to prompt the cashier."},{"pos":[12950,13033],"content":"Write trigger business logic in the <bpt id=\"p1\">**</bpt>Execute<ept id=\"p1\">**</ept> method in the implementation class.","source":"Write trigger business logic in the **Execute** method in the implementation class."},{"pos":[13038,13142],"content":"Register the trigger as part of the <bpt id=\"p1\">**</bpt>PostLogonTrigger<ept id=\"p1\">**</ept> implementation on the <bpt id=\"p2\">**</bpt>DOMContentLoad<ept id=\"p2\">**</ept> event.","source":"Register the trigger as part of the **PostLogonTrigger** implementation on the **DOMContentLoad** event."},{"pos":[13145,13205],"content":"<bpt id=\"p1\">[</bpt><ph id=\"ph1\">![</ph>Trigger01<ept id=\"p1\">](./media/trigger01.png)](./media/trigger01.png)</ept>","source":"[![Trigger01](./media/trigger01.png)](./media/trigger01.png)"},{"content":"<bpt id=\"p1\">**</bpt>Purpose:<ept id=\"p1\">**</ept> To customize Modern POS/Cloud POS to implement the Swedish localization requirement that the same transaction not include both sale and return lines when a fiscal register is connected.","pos":[13207,13405],"source":"**Purpose:** To customize Modern POS/Cloud POS to implement the Swedish localization requirement that the same transaction not include both sale and return lines when a fiscal register is connected."},{"content":"Open a Modern POS project, and add a new TypeScript (.ts) file to add the trigger implementation.","pos":[13406,13503]},{"content":"We are creating a new TypeScript file for our customization to keep our customization separate from the product code and make upgrades easier to manage.","pos":[13504,13656]},{"content":"Start Microsoft Visual Studio 2015 as an administrator.","pos":[13662,13717]},{"content":"Open the Modern POS solution from the Retail SDK directory:","pos":[13722,13781]},{"content":"If you're using a cloud-hosted computer, the path is I:/RetailSDK.","pos":[13790,13856]},{"content":"If you're using a locally downloaded machine, the path is C:<ph id=\"ph1\">\\\\</ph>Microsoft Dynamics AX<ph id=\"ph2\">\\\\</ph>70<ph id=\"ph3\">\\\\</ph>Retail SDK.","pos":[13865,13965],"source":"If you're using a locally downloaded machine, the path is C:\\\\Microsoft Dynamics AX\\\\70\\\\Retail SDK."},{"pos":[13971,14060],"content":"In POS.Core<ph id=\"ph1\">\\\\</ph>Triggers<ph id=\"ph2\">\\\\</ph>, create a new TypeScript file that is named <bpt id=\"p1\">**</bpt>TriggerSample.ts<ept id=\"p1\">**</ept>.","source":"In POS.Core\\\\Triggers\\\\, create a new TypeScript file that is named **TriggerSample.ts**."},{"pos":[14063,14132],"content":"<bpt id=\"p1\">[</bpt><ph id=\"ph1\">![</ph>Trigger02<ept id=\"p1\">](./media/trigger02-1024x411.png)](./media/trigger02.png)</ept>","source":"[![Trigger02](./media/trigger02-1024x411.png)](./media/trigger02.png)"},{"content":"Add the following code to the TriggerSample.ts file.","pos":[14138,14190]},{"pos":[17948,18038],"content":"Inspect the TriggerSample.ts file to see the implementation of <bpt id=\"p1\">**</bpt>IPreProductSaleTrigger<ept id=\"p1\">**</ept>.","source":"Inspect the TriggerSample.ts file to see the implementation of **IPreProductSaleTrigger**."},{"pos":[19239,19312],"content":"Inspect the registration of <bpt id=\"p1\">**</bpt>ValidateProductSalePreProductSaleTrigger<ept id=\"p1\">**</ept>.","source":"Inspect the registration of **ValidateProductSalePreProductSaleTrigger**."},{"pos":[20234,20309],"content":"Inspect the <bpt id=\"p1\">**</bpt>performRegistration<ept id=\"p1\">**</ept> method where the trigger is registered.","source":"Inspect the **performRegistration** method where the trigger is registered."},{"pos":[21009,21090],"content":"Inspect the registration of <bpt id=\"p1\">**</bpt>PostLogonTrigger<ept id=\"p1\">**</ept> on the <bpt id=\"p2\">**</bpt>DOMContentLoad<ept id=\"p2\">**</ept> event.","source":"Inspect the registration of **PostLogonTrigger** on the **DOMContentLoad** event."},{"content":"Compile and rebuild Modern POS to verify the implementation:","pos":[21644,21704]},{"content":"Go to <bpt id=\"p1\">**</bpt>Show Journal<ept id=\"p1\">**</ept>, and select a transaction to return.","pos":[21713,21772],"source":"Go to **Show Journal**, and select a transaction to return."},{"content":"If the transaction has multiple lines, return one line.","pos":[21773,21828]},{"content":"A return line should be added in the cart.","pos":[21829,21871]},{"content":"In the left navigation pane, use product search (the search icon) to search for the text \"shirt.\"","pos":[21880,21977]},{"pos":[21986,22065],"content":"Select one of the shirt products, and then, on the app bar, click <bpt id=\"p1\">**</bpt>Sell now<ept id=\"p1\">**</ept>.","source":"Select one of the shirt products, and then, on the app bar, click **Sell now**."},{"content":"Observe that <bpt id=\"p1\">**</bpt>IPreProductSaleTrigger<ept id=\"p1\">**</ept> trigger is run.","pos":[22074,22129],"source":"Observe that **IPreProductSaleTrigger** trigger is run."},{"content":"You should receive a message that states that you can't perform a sale and a return in same transaction.","pos":[22130,22234]}],"content":"---\n# required metadata\n\ntitle: Modern POS and Cloud POS trigger extensibility\ndescription: This article explains the client-side trigger functionality in Modern POS and Cloud POS.\nauthor: RobinARH\nmanager: AnnBe\nms.date: 04/04/2017\nms.topic: article\nms.prod: \nms.service: Dynamics365Operations\nms.technology: \n\n# optional metadata\n\n# ms.search.form: \n# ROBOTS: \naudience: Developer\n# ms.devlang: \n# ms.reviewer: robinr\nms.search.scope: AX 7.0.0, Operations\n# ms.tgt_pltfrm: \nms.custom: 17751\nms.assetid: 6767d342-73e0-432b-a02f-ea8191464506\nms.search.region: Global\n# ms.search.industry: \nms.author: sijoshi\nms.search.validFrom: 2016-02-28\nms.dyn365.ops.version: AX 7.0.0\n\n---\n\n# Modern POS and Cloud POS trigger extensibility\n\nThis article explains the client-side trigger functionality in Modern POS and Cloud POS.\n\nTrigger overview\n----------------\n\nTriggers are events that are raised by Microsoft Dynamics 365 for Operations for Retail POS. Triggers let you insert custom code before or after operations. There are two kinds of triggers: pre-triggers and post-triggers.\n\n| Pre-triggers                                                                                                                                                                                                                                                    | Post-triggers                                                                                                                                                                                                                                                        |\n|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| Pre-triggers can be used to insert custom code before an operation is run. For example, if a customer uses a coupon for a purchase, you can use a pre-trigger to insert custom code to validate that the coupon hasn't expired and hasn't previously been used. | Post-triggers can be used to insert custom code that responds to a completed operation. For example, you can write code that runs after the **CustomerAdd** operation and prompts the cashier to wish the customer a happy birthday if it's the customer’s birthday. |\n\n### Trigger types\n\nIn Modern POS and Cloud POS, triggers are either cancelable or non-cancelable.\n\n| Cancelable                                                                                                                                                                                                                                                                                                                                                                                                              | Non-cancelable                                                                                                                                                                                                                                                                                                                                             |\n|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| Trigger implementations that extend **ICancelableTriggerCancelable** triggers can succeed, fail, or be canceled. Execution of the workflow is canceled without displaying an error. An example is a trigger to confirm that the user wants to use his or her loyalty points for tender. If the user selects **No**, the workflow to enter loyalty information is canceled without showing an error message to the user. | Trigger implementations that extend **ITriggerNon-cancelable** triggers can either succeed or fail. If the trigger succeeds, the workflow continues. If the trigger fails, a message appears in the UI. An example is a trigger to support Swedish localization requirements by guiding the cashier to create separate transactions for sales and returns. |\n\n### Guidelines\n\n-   **Trigger registration** – All triggers should be registered by using the **TriggerManager::register** method. The **ApplicationStart**, **PreLogOn**, and **PostLogOn** triggers must be registered inside a function that is called when the **DOMContentLoaded** event is raised. Other triggers can be registered in the same manner, but they can also be registered conditionally.\n    -   **Conditional registration** – If the decision about whether to register a trigger is based on information in the channel, the trigger can be registered conditionally. Conditional registration should be performed inside a **PostLogOn** trigger. **Note:** It's important that the conditional registration be performed only during the first sign-in after the app has been loaded. For an example implementation, see the sample code later in this article.\n-   **Trigger implementation** – Each trigger event that is listed in the \"Supported trigger events\" section has a trigger interface that is associated with it. These trigger interfaces define the contract between the application and the trigger implementations. Each trigger should implement the predefined interface that is associated with the trigger event type that it's registered for.\n\n### Triggers execution workflow\n\nThe following diagram shows the execution workflow for both pre-triggers and post-triggers for the **ItemSaleOperation** workflow/operation. \n\n[![Trigger Execution Flow](./media/trigger-execution-flow.png)](./media/trigger-execution-flow.png)\n\n### Supported trigger events\n\nTogether with pre-operation and post-operation triggers that are triggered for every operation, the following triggers are supported out of the box:\n\n-   Application triggers\n    -   Cancelable\n        -   **PreLogOn** – Called before sign-in to Modern POS\n            -   operatorId\n    -   Non-cancelable\n        -   **ApplicationStart** – Called when the application is launched\n        -   **ApplicationSuspend** – Called when the application is suspended\n        -   **PostLogOff** – Called after the sign-out operation is completed\n        -   **PostLogOn** – Called after the sign-in operation is completed\n-   Cash management triggers\n    -   Cancelable\n        -   **PreTenderDeclaration** – Called before the tender declaration operation is run\n    -   Non-cancelable\n        -   **PostTenderDeclaration** – Called as the last step in the tender declaration workflow\n-   Customer triggers\n    -   Cancelable\n        -   **PreCustomerAdd** – Called before a new customer is created\n        -   **PreCustomerClear** – Called before the customer is cleared from the current transaction\n        -   **PreCustomerSearch** – Called before a search for a customer\n        -   **PreCustomerSet** – Called before the customer is set on the transaction\n    -   Non-cancelable\n        -   **PostCustomerAdd** – Called after a new customer is created\n        -   **PostCustomerClear** – Called after the customer is cleared from the transaction\n        -   **PostCustomerSearch** – Called after a search for a customer\n-   Discount triggers\n    -   Cancelable\n        -   **PreLineDiscountAmount** – Called during the line discount amount operation, after validation determines whether a discount can be applied\n        -   **PreLineDiscountPercent** – Called during the line discount percent operation, after validation determines whether a discount can be applied\n        -   **PreTotalDiscountAmount** – Called during the total discount amount operation, after validation determines whether a discount can be applied\n        -   **PreTotalDiscountPercent** – Called during the total discount percent operation, after validation determines whether a discount can be applied\n    -   Non-cancelable\n        -   **PostLineDiscountAmount** - Called as the last step in the line discount amount workflow\n        -   **PostLineDiscountPercent** – Called as the last step in the line discount percent workflow\n        -   **PostTotalDiscountAmount** – Called as the last step in the total discount amount workflow\n        -   **PostTotalDiscountPercent** – Called as the last step in the total discount percent workflow\n-   Operation triggers\n    -   Cancelable\n        -   **PreOperation** – Called before every operation is run, before the prehandler and operation validators\n    -   Non-cancelable\n        -   **OperationFailure** – Called when an operation fails, and can be used to perform recovery actions\n        -   **PostOperation** – Called when an operation is completed successfully\n-   Payment triggers\n    -   Cancelable\n        -   **PreAddTenderLine** – Called before a tender line is added to the transaction\n        -   **PrePayment** – Called before any payment operation is started\n        -   **PreVoidPayment** – Called before the void payment operation is started\n    -   Non-cancelable\n        -   **PostPayment** – Called after the payment has been added\n        -   **PostVoidPayment** – Called after the payment has been voided\n-   Printing triggers\n    -   Cancelable\n        -   **PrePrintReceiptCopy** – Called before a copy of the receipt is printed\n-   Product Triggers\n    -   Cancelable\n        -   **PreClearQuantity** – Called before the clear quantity operation\n        -   **PrePriceOverride** – Called before the price override operation\n        -   **PreProductSale** – Called before the item sale operation\n        -   **PreReturnProduct** – Called before the return product operation\n        -   **PreSetQuantity** – Called before the set quantity operation\n        -   **PreVoidProducts** – Called after the user confirms that he or she wants to void the transaction, but before the transaction is voided\n    -   Non-cancelable\n        -   **PostClearQuantity** – Called after the clear quantity operation\n        -   **PostPriceOverride** – Called after the price override operation\n        -   **PostProductSale** – Called after the item sale operation\n        -   **PostReturnProduct** – Called after the return product operation\n        -   **PostSetQuantity** – Called after the set quantity operation\n        -   **PostVoidProducts** – Called after the void products operation\n-   Transaction triggers\n    -   Cancelable\n        -   **PreConfirmReturnTransaction** – Called after a search for a transaction to return, but before the cart lines appear as available for return\n        -   **PreEndTransaction** – Called before a sales transaction is completed\n        -   **PreRecallTransaction** – Called before a transaction is recalled\n        -   **PreReturnTransaction** – Called before a transaction is returned\n        -   **PreSuspendTransaction** – Called before a transaction is suspended\n        -   **PreVoidTransaction** – Called before a transaction is voided\n    -   Non-cancelable\n        -   **BeginTransaction** – Called before a cart is created and a transaction is started\n        -   **PostEndTransaction** – Called after a sales transaction is completed\n        -   **PostRecallTransaction** – Called after a transaction is recalled\n        -   **PostReturnTransaction** – Called after items from a transaction are added to the cart for return\n        -   **PostSuspendTransaction** – Called after suspending a transaction\n        -   **PostVoidTransaction** – Called after a transaction is voided\n\n## Trigger example implementation\nThe best way to understand triggers is to look at a sample implementation scenario.\n\n### Modern POS/Cloud POS changes to support Swedish localization requirements by using POS triggers\n\nTransactions can't have both return and sale operations if a fiscal register is connected. An **IPreProductSaleTrigger** trigger is implemented to detect this situation if it occurs and to show a message to prompt the cashier. This is a requirement in Sweden.\n\n1.  Implement an **IPreProductSaleTrigger** trigger to detect the situation and show a message to prompt the cashier.\n2.  Write trigger business logic in the **Execute** method in the implementation class.\n3.  Register the trigger as part of the **PostLogonTrigger** implementation on the **DOMContentLoad** event. \n\n[![Trigger01](./media/trigger01.png)](./media/trigger01.png)\n\n**Purpose:** To customize Modern POS/Cloud POS to implement the Swedish localization requirement that the same transaction not include both sale and return lines when a fiscal register is connected. Open a Modern POS project, and add a new TypeScript (.ts) file to add the trigger implementation. We are creating a new TypeScript file for our customization to keep our customization separate from the product code and make upgrades easier to manage.\n\n1.  Start Microsoft Visual Studio 2015 as an administrator.\n2.  Open the Modern POS solution from the Retail SDK directory:\n    -   If you're using a cloud-hosted computer, the path is I:/RetailSDK.\n    -   If you're using a locally downloaded machine, the path is C:\\\\Microsoft Dynamics AX\\\\70\\\\Retail SDK.\n\n3.  In POS.Core\\\\Triggers\\\\, create a new TypeScript file that is named **TriggerSample.ts**. \n\n[![Trigger02](./media/trigger02-1024x411.png)](./media/trigger02.png)\n\n4.  Add the following code to the TriggerSample.ts file.\n\n        ///<reference path=\"ITrigger.ts\" />\n        ///<reference path=\"ApplicationTriggers.ts\" />\n        ///<reference path=\"TransactionTriggers.ts\" />\n        module Commerce.Triggers.Samples {\n            \"use strict\";\n            /**\n             * Implementation of a pre product sale trigger that is used to ensure there are no return lines in the cart.\n             */\n            export class ValidateProductSalePreProductSaleTrigger implements IPreProductSaleTrigger {\n                private static SALE_NOT_ALLOWED_IN_SAME_TRANSACTION_AS_RETURN_ERROR_CODE: string = \"Return and sale not allowed in same transaction\";\n                /**\n                 * Executes the trigger.\n                 */\n                public execute(options: Operations.IItemSaleOperationOptions): IAsyncResult<ICancelableResult> {\n                    var hasReturnLine: boolean = Session.instance.cart.CartLines.some((cartLine: Proxy.Entities.CartLine): boolean => {\n                        return cartLine.Quantity < 0 && !cartLine.IsVoided;\n                    });\n                    var result: AsyncResult<ICancelableResult> = new AsyncResult<ICancelableResult>(null);\n                    if (hasReturnLine) {\n                        var error: Proxy.Entities.Error =\n                            new Proxy.Entities.Error(ValidateProductSalePreProductSaleTrigger.SALE_NOT_ALLOWED_IN_SAME_TRANSACTION_AS_RETURN_ERROR_CODE);\n                        result.reject([error]);\n                    } else {\n                        result.resolve({ canceled: false });\n                    }\n                    return result;\n                }\n            }\n            /**\n             * Implementation of a post log on trigger that is used to perform conidtional registration of other triggers.\n             */\n            export class ConditionalRegistrationPostLogOnTrigger implements IPostLogOnTrigger {\n                private static alreadyRegistered: boolean = false;\n                /**\n                 * Executes the trigger.\n                 */\n                public execute(options: IPostLogOnTriggerOptions): IVoidAsyncResult {\n                    // Check to ensure the triggers have not already been registered.\n                    if (!ConditionalRegistrationPostLogOnTrigger.alreadyRegistered) {\n                        this.performRegistration();\n                        // Set already registered field to true to prevent duplicate trigger registration.\n                        ConditionalRegistrationPostLogOnTrigger.alreadyRegistered = true;\n                    }\n                    return VoidAsyncResult.createResolved();\n                }\n                /**\n                 * Perform the conditional registration of triggers.\n                 */\n                private performRegistration(): void {\n                    var conditionIsMet: boolean = true;\n                    if (conditionIsMet) {              \n                        TriggerManager.instance.register(\n                            CancelableTriggerType.PreProductSale,\n                            new ValidateProductSalePreProductSaleTrigger());\n                    }\n                }\n            }\n        }\n        /**\n         * Trigger types that do not support conditional registration should be registered when the DOMContentLoaded event is fired.\n         * @remarks These trigger types include: ApplicationStart, PreLogOn and PostLogOn.\n         */\n        document.addEventListener(\"DOMContentLoaded\", function (): void {\n            Commerce.Triggers.TriggerManager.instance.register(\n                Commerce.Triggers.NonCancelableTriggerType.PostLogOn,\n                new Commerce.Triggers.Samples.ConditionalRegistrationPostLogOnTrigger());\n        });\n\n5.  Inspect the TriggerSample.ts file to see the implementation of **IPreProductSaleTrigger**.\n\n        export class ValidateProductSalePreProductSaleTrigger implements IPreProductSaleTrigger {\n            private static SALE_NOT_ALLOWED_IN_SAME_TRANSACTION_AS_RETURN_ERROR_CODE: string = \"Return and sale not allowed in same transaction\";       \n            /**\n            * Executes the trigger.\n            */\n            public execute(options: Operations.IItemSaleOperationOptions): IAsyncResult<ICancelableResult> {\n                var hasReturnLine: boolean = Session.instance.cart.CartLines.some((cartLine: Proxy.Entities.CartLine): boolean => {\n                    return cartLine.Quantity < 0 && !cartLine.IsVoided;\n                });\n                var result: AsyncResult<ICancelableResult> = new AsyncResult<ICancelableResult>(null);\n                if (hasReturnLine) {\n                    var error: Proxy.Entities.Error =\n                    new Proxy.Entities.Error(ValidateProductSalePreProductSaleTrigger.SALE_NOT_ALLOWED_IN_SAME_TRANSACTION_AS_RETURN_ERROR_CODE);\n                    result.reject([error]);\n                } else {\n                    result.resolve({ canceled: false });\n                }\n                return result;\n            }    \n        }\n\n6.  Inspect the registration of **ValidateProductSalePreProductSaleTrigger**.\n\n        /**\n        * Implementation of a post log on trigger that is used to perform conidtional registration of other triggers.\n        */\n        export class ConditionalRegistrationPostLogOnTrigger implements IPostLogOnTrigger {\n            private static alreadyRegistered: boolean = false;\n            /**\n            * Executes the trigger.\n            */\n            public execute(options: IPostLogOnTriggerOptions): IVoidAsyncResult {\n                // Check to ensure the triggers have not already been registered.\n                if (!ConditionalRegistrationPostLogOnTrigger.alreadyRegistered) {\n                    this.performRegistration();\n                // Set already registered field to true to prevent duplicate trigger registration.\n                ConditionalRegistrationPostLogOnTrigger.alreadyRegistered = true;\n            }\n            return VoidAsyncResult.createResolved();\n        }\n\n7.  Inspect the **performRegistration** method where the trigger is registered.\n\n        private performRegistration(): void {\n            var conditionIsMet: boolean = true;\n            if (conditionIsMet) {\n                //TriggerManager.instance.register(\n                //    CancelableTriggerType.PreConfirmReturnTransaction,\n                //    new ValidateReturnPreConfirmReturnTransactionTrigger());\n                TriggerManager.instance.register(\n                    CancelableTriggerType.PreProductSale,\n                    new ValidateProductSalePreProductSaleTrigger());\n                //TriggerManager.instance.register(\n                //    NonCancelableTriggerType.PostCustomerAdd,\n                //    new GiveBirthDayDiscountTrigger());\n        }\n\n8.  Inspect the registration of **PostLogonTrigger** on the **DOMContentLoad** event.\n\n        /**\n        * Trigger types that do not support conditional registration should be registered when the DOMContentLoaded event is fired.\n        * @remarks These trigger types include: ApplicationStart, PreLogOn and PostLogOn.\n        */\n        document.addEventListener(\"DOMContentLoaded\", function (): void {\n            Commerce.Triggers.TriggerManager.instance.register(\n            Commerce.Triggers.NonCancelableTriggerType.PostLogOn,\n            new Commerce.Triggers.Samples.ConditionalRegistrationPostLogOnTrigger());\n        });\n\n9.  Compile and rebuild Modern POS to verify the implementation:\n    1.  Go to **Show Journal**, and select a transaction to return. If the transaction has multiple lines, return one line. A return line should be added in the cart.\n    2.  In the left navigation pane, use product search (the search icon) to search for the text \"shirt.\"\n    3.  Select one of the shirt products, and then, on the app bar, click **Sell now**.\n    4.  Observe that **IPreProductSaleTrigger** trigger is run. You should receive a message that states that you can't perform a sale and a return in same transaction.\n\n\n\n"}