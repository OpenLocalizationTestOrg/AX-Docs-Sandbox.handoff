{"nodes":[{"pos":[32,104],"content":"Create a copy of a Dynamics 365 for Operations database to restore later","needQuote":true,"needEscape":true,"nodes":[{"content":"Create a copy of a Dynamics 365 for Operations database to restore later","pos":[0,72]}]},{"pos":[118,379],"content":"This topic provides instructions for exporting a Microsoft Dynamics 365 for Operations database to a file and then reimporting that file to the same instance or another instance of the application. This procedure can only be used in non-production environments.","needQuote":true,"needEscape":true,"nodes":[{"content":"This topic provides instructions for exporting a Microsoft Dynamics 365 for Operations database to a file and then reimporting that file to the same instance or another instance of the application. This procedure can only be used in non-production environments.","pos":[0,261],"nodes":[{"content":"This topic provides instructions for exporting a Microsoft Dynamics 365 for Operations database to a file and then reimporting that file to the same instance or another instance of the application.","pos":[0,197]},{"content":"This procedure can only be used in non-production environments.","pos":[198,261]}]}]},{"pos":[892,964],"content":"Create a copy of a Dynamics 365 for Operations database to restore later","linkify":"Create a copy of a Dynamics 365 for Operations database to restore later","nodes":[{"content":"Create a copy of a Dynamics 365 for Operations database to restore later","pos":[0,72]}]},{"content":"This topic provides instructions for exporting a Microsoft Dynamics 365 for Operations database to a file and then reimporting that file to the same instance or another instance of the application.","pos":[966,1163]},{"content":"This procedure can only be used in non-production environments.","pos":[1164,1227]},{"content":"You might want to retain a copy of a Dynamics 365 for Operations database process in several situations:","pos":[1230,1334]},{"content":"To take strategic backups to restore to in the future.","pos":[1340,1394]},{"content":"For example, before or after a major code update you might want copies to use for reference later.","pos":[1395,1493]},{"content":"To back up a database before destructive testing and then restore it afterward.","pos":[1498,1577]},{"content":"When upgrading to a new major release of Microsoft Dynamics 365 for Operations, this process can be used to export your old test database and bring it forward to the new version.","pos":[1582,1760]},{"content":"Be aware that Microsoft also provides a standard feature which provides the ability to restore an Azure SQL database environment to a point-in-time within the last 35 days via a service request.","pos":[1762,1956]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>Request a point-in-time database restore on a non-production environment<ept id=\"p1\">](request-point-in-time-restore.md)</ept>.","pos":[1957,2092],"source":" For more information, see [Request a point-in-time database restore on a non-production environment](request-point-in-time-restore.md)."},{"pos":[2097,2110],"content":"Prerequisites","linkify":"Prerequisites","nodes":[{"content":"Prerequisites","pos":[0,13]}]},{"content":"To export a database from a sandbox environment you must install the latest SQL Server 2016 Management Studio to the AOS machine in that environment and perform the export on that AOS machine.","pos":[2111,2303]},{"content":"This is for two reasons.","pos":[2304,2328]},{"content":"First, there is an IP access restriction on the sandbox SQL Server instance, which only allows a connection from a machine within that environment.","pos":[2329,2476]},{"content":"Second, the version of SQL Server Management Studio installed by default is for a previous version of SQL Server and can’t complete the tasks required.","pos":[2477,2628]},{"pos":[2633,2680],"content":"Export the Dynamics 365 for Operations database","linkify":"Export the Dynamics 365 for Operations database","nodes":[{"content":"Export the Dynamics 365 for Operations database","pos":[0,47]}]},{"pos":[2685,2698],"content":"Stop services","linkify":"Stop services","nodes":[{"content":"Stop services","pos":[0,13]}]},{"content":"Use Remote Desktop to connect to all the computers in the environment and stop the following Windows services by using services.msc.","pos":[2700,2832]},{"content":"These services will have open connections to the Dynamics 365 for Operations database.","pos":[2833,2919]},{"content":"World wide web publishing service (on all AOS computers)","pos":[2925,2981]},{"content":"Microsoft Dynamics 365 for Operations Batch Management Service (on non-private AOS computers only)","pos":[2986,3084]},{"content":"Management Reporter 2012 Process Service (on BI computers only)","pos":[3089,3152]},{"pos":[3158,3227],"content":"Execute sqlpackage to export the Dynamics 365 for Operations database","linkify":"Execute sqlpackage to export the Dynamics 365 for Operations database","nodes":[{"content":"Execute sqlpackage to export the Dynamics 365 for Operations database","pos":[0,69]}]},{"content":"Open a command prompt as an Administrator, and then execute the following commands.","pos":[3229,3312]},{"content":"The parameters include:","pos":[3604,3627]},{"pos":[3633,3724],"content":"<bpt id=\"p1\">**</bpt>ssn<ept id=\"p1\">**</ept> (source server name) - The name of the SQL Azure server from which you will export.","source":"**ssn** (source server name) - The name of the SQL Azure server from which you will export."},{"pos":[3729,3808],"content":"<bpt id=\"p1\">**</bpt>sdn<ept id=\"p1\">**</ept> (source database name) - The name of the database that you will export.","source":"**sdn** (source database name) - The name of the database that you will export."},{"pos":[3813,3883],"content":"<bpt id=\"p1\">**</bpt>tf<ept id=\"p1\">**</ept> (target file) - The path and file name that you will export to.","source":"**tf** (target file) - The path and file name that you will export to."},{"pos":[3888,3958],"content":"<bpt id=\"p1\">**</bpt>sp<ept id=\"p1\">**</ept> (source password) - The SQL password for the source SQL Server.","source":"**sp** (source password) - The SQL password for the source SQL Server."},{"content":"<bpt id=\"p1\">**</bpt>su<ept id=\"p1\">**</ept> (source user) - The SQL user name for the source SQL Server.","pos":[3963,4030],"source":"**su** (source user) - The SQL user name for the source SQL Server."},{"content":"We recommend that you use the <bpt id=\"p1\">**</bpt>sqladmin<ept id=\"p1\">**</ept> user, which the deployment will have created on every Dynamics SQL instance.","pos":[4031,4150],"source":" We recommend that you use the **sqladmin** user, which the deployment will have created on every Dynamics SQL instance."},{"content":"You can retrieve the password for this user from your Lifecycle Services (LCS) project.","pos":[4151,4238]},{"content":"Running this command creates a .bacpac file on the D:<ph id=\"ph1\">\\\\</ph>Exportedbacpac folder.","pos":[4240,4317],"source":"Running this command creates a .bacpac file on the D:\\\\Exportedbacpac folder."},{"content":"You can take this file and copy or upload it to secure location so that it can be imported into a different environment at another time.","pos":[4318,4454]},{"content":"You can use the AzCopy command line utility to upload the file to an Azure storage account<bpt id=\"p1\">[</bpt>,<ept id=\"p1\">](https://azure.microsoft.com/en-gb/documentation/articles/storage-use-azcopy/)</ept> and then download it to the target AOS computer.","pos":[4455,4675],"source":" You can use the AzCopy command line utility to upload the file to an Azure storage account[,](https://azure.microsoft.com/en-gb/documentation/articles/storage-use-azcopy/) and then download it to the target AOS computer."},{"content":"For more information, see <bpt id=\"p1\">[</bpt>Copy or upload the file to an Azure storage account<ept id=\"p1\">](https://docs.microsoft.com/en-gb/azure/storage/storage-use-azcopy)</ept>.","pos":[4676,4823],"source":" For more information, see [Copy or upload the file to an Azure storage account](https://docs.microsoft.com/en-gb/azure/storage/storage-use-azcopy)."},{"content":"<bpt id=\"p1\">**</bpt>Note:<ept id=\"p1\">**</ept> Microsoft doesn’t provide a storage account as part of your Dynamics 365 for Operations agreement.","pos":[4824,4932],"source":"**Note:** Microsoft doesn’t provide a storage account as part of your Dynamics 365 for Operations agreement."},{"content":"You must either purchase a storage account or use a storage account from a separate Azure subscription.","pos":[4933,5036]},{"content":"<bpt id=\"p1\">**</bpt>Important:<ept id=\"p1\">**</ept> Be aware of the behavior of the D drive on Azure Virtual Machines, do not keep your exported database files here permanently unless you are prepared to lose them.","pos":[5037,5214],"source":"**Important:** Be aware of the behavior of the D drive on Azure Virtual Machines, do not keep your exported database files here permanently unless you are prepared to lose them."},{"content":"For details, see <bpt id=\"p1\">[</bpt>Understanding the temporary drive on Windows Azure virtual machines (blog post)<ept id=\"p1\">](https://blogs.msdn.microsoft.com/mast/2013/12/06/understanding-the-temporary-drive-on-windows-azure-virtual-machines/)</ept>.","pos":[5215,5433],"source":" For details, see [Understanding the temporary drive on Windows Azure virtual machines (blog post)](https://blogs.msdn.microsoft.com/mast/2013/12/06/understanding-the-temporary-drive-on-windows-azure-virtual-machines/)."},{"pos":[5439,5453],"content":"Start services","linkify":"Start services","nodes":[{"content":"Start services","pos":[0,14]}]},{"content":"Use services.msc to restart the services that you stopped earlier:","pos":[5455,5521]},{"content":"World wide web publishing service (on all AOS computers)","pos":[5527,5583]},{"content":"Microsoft Dynamics 365 for Operations Batch Management Service (on non-private AOS computers only)","pos":[5588,5686]},{"content":"Management Reporter 2012 Process Service (on BI computers only)","pos":[5691,5754]},{"pos":[5759,5806],"content":"Import the Dynamics 365 for Operations database","linkify":"Import the Dynamics 365 for Operations database","nodes":[{"content":"Import the Dynamics 365 for Operations database","pos":[0,47]}]},{"pos":[5811,5824],"content":"Stop services","linkify":"Stop services","nodes":[{"content":"Stop services","pos":[0,13]}]},{"content":"Use Remote Desktop to connect to all the computers in the environment and stop the following Windows services by using services.msc.","pos":[5826,5958]},{"content":"These services will have open connections to the Dynamics 365 for Operations database.","pos":[5959,6045]},{"content":"World wide web publishing service (on all AOS computers)","pos":[6051,6107]},{"content":"Microsoft Dynamics 365 for Operations Batch Management Service (on non-private AOS computers only)","pos":[6112,6210]},{"content":"Management Reporter 2012 Process Service (on BI computers only)","pos":[6215,6278]},{"pos":[6284,6306],"content":"Import the bacpac file","linkify":"Import the bacpac file","nodes":[{"content":"Import the bacpac file","pos":[0,22]}]},{"content":"Copy the .bacpac file that was generated in the export step to the AOS computer in the target environment.","pos":[6308,6414]},{"content":"For performance reasons, we recommend that you place the .bacpac file on the drive D on the AOS computer.","pos":[6415,6520]},{"content":"Open a <bpt id=\"p1\">**</bpt>Command Prompt<ept id=\"p1\">**</ept> window as an administrator, and run the following commands.","pos":[6521,6606],"source":" Open a **Command Prompt** window as an administrator, and run the following commands."},{"content":"The parameters include:","pos":[6937,6960]},{"content":"<bpt id=\"p1\">**</bpt>tsn<ept id=\"p1\">**</ept> (target server name) – The name of the SQL Azure server to import into.","pos":[6966,7045],"source":"**tsn** (target server name) – The name of the SQL Azure server to import into."},{"content":"The name can be found in LCS.","pos":[7046,7075]},{"content":"Add the suffix <bpt id=\"p1\">**</bpt>database.windows.net<ept id=\"p1\">**</ept>.","pos":[7076,7116],"source":" Add the suffix **database.windows.net**."},{"content":"<bpt id=\"p1\">**</bpt>tdn<ept id=\"p1\">**</ept> (target database name) – The name of the database to import into.","pos":[7121,7194],"source":"**tdn** (target database name) – The name of the database to import into."},{"content":"The database should <bpt id=\"p1\">**</bpt>not<ept id=\"p1\">**</ept> already exist.","pos":[7195,7237],"source":" The database should **not** already exist."},{"content":"The import process will create it.","pos":[7238,7272]},{"pos":[7277,7338],"content":"<bpt id=\"p1\">**</bpt>sf<ept id=\"p1\">**</ept> (source file) – The path and file name to import from.","source":"**sf** (source file) – The path and file name to import from."},{"content":"<bpt id=\"p1\">**</bpt>tu<ept id=\"p1\">**</ept> (target user) – The SQL user name for the target Azure SQL database instance.","pos":[7343,7427],"source":"**tu** (target user) – The SQL user name for the target Azure SQL database instance."},{"content":"We recommend that you use the standard <bpt id=\"p1\">**</bpt>sqladmin<ept id=\"p1\">**</ept> user.","pos":[7428,7485],"source":" We recommend that you use the standard **sqladmin** user."},{"content":"You can retrieve the password for this user from your LCS project.","pos":[7486,7552]},{"pos":[7557,7636],"content":"<bpt id=\"p1\">**</bpt>tp<ept id=\"p1\">**</ept> (target password) – The password for the target Azure SQL database user.","source":"**tp** (target password) – The password for the target Azure SQL database user."},{"pos":[7642,7705],"content":"Run a script to update the Dynamics 365 for Operations database","linkify":"Run a script to update the Dynamics 365 for Operations database","nodes":[{"content":"Run a script to update the Dynamics 365 for Operations database","pos":[0,63]}]},{"content":"If the source and target environments have different SQL user passwords, then you will need to run this script.","pos":[7707,7818]},{"content":"If you are not sure if the passwords are different, you need to run this script.","pos":[7819,7899]},{"content":"Run the following script against the imported database.","pos":[7900,7955]},{"content":"The script will drop the database users and recreate them with the correct passwords for the target environment.","pos":[7956,8068]},{"pos":[9486,9497],"content":"Limitations","linkify":"Limitations","nodes":[{"content":"Limitations","pos":[0,11]}]},{"content":"The link between the database and document handling documents that are stored in Azure blob storage might be broken after importing a database.","pos":[9498,9641]},{"content":"If you have custom code that utilizes the X++ class FileUpload to place files in blob storage, the links to these files might also be broken.","pos":[9642,9783]}],"content":"---\n# required metadata\n\ntitle: Create a copy of a Dynamics 365 for Operations database to restore later\ndescription: This topic provides instructions for exporting a Microsoft Dynamics 365 for Operations database to a file and then reimporting that file to the same instance or another instance of the application. This procedure can only be used in non-production environments. \nauthor: MargoC\nmanager: AnnBe\nms.date: 04/04/2017\nms.topic: article\nms.prod: \nms.service: Dynamics365Operations\nms.technology: \n\n# optional metadata\n\n# ms.search.form: \n# ROBOTS: \naudience: Developer, IT Pro\n# ms.devlang: \n# ms.reviewer: 11\nms.search.scope: Operations, Platform\n# ms.tgt_pltfrm: \nms.custom: 269254\nms.assetid: 7464b180-8ace-4b65-8b53-ba608d0611e1\nms.search.region: Global\n# ms.search.industry: \nms.author: tabell\nms.search.validFrom: 2016-11-30\nms.dyn365.ops.version: Platform update 3\n\n---\n\n# Create a copy of a Dynamics 365 for Operations database to restore later\n\nThis topic provides instructions for exporting a Microsoft Dynamics 365 for Operations database to a file and then reimporting that file to the same instance or another instance of the application. This procedure can only be used in non-production environments. \n\nYou might want to retain a copy of a Dynamics 365 for Operations database process in several situations:\n\n-   To take strategic backups to restore to in the future. For example, before or after a major code update you might want copies to use for reference later.\n-   To back up a database before destructive testing and then restore it afterward.\n-   When upgrading to a new major release of Microsoft Dynamics 365 for Operations, this process can be used to export your old test database and bring it forward to the new version.\n\nBe aware that Microsoft also provides a standard feature which provides the ability to restore an Azure SQL database environment to a point-in-time within the last 35 days via a service request. For more information, see [Request a point-in-time database restore on a non-production environment](request-point-in-time-restore.md).\n\n## Prerequisites\nTo export a database from a sandbox environment you must install the latest SQL Server 2016 Management Studio to the AOS machine in that environment and perform the export on that AOS machine. This is for two reasons. First, there is an IP access restriction on the sandbox SQL Server instance, which only allows a connection from a machine within that environment. Second, the version of SQL Server Management Studio installed by default is for a previous version of SQL Server and can’t complete the tasks required.\n\n## Export the Dynamics 365 for Operations database\n### Stop services\n\nUse Remote Desktop to connect to all the computers in the environment and stop the following Windows services by using services.msc. These services will have open connections to the Dynamics 365 for Operations database.\n\n-   World wide web publishing service (on all AOS computers)\n-   Microsoft Dynamics 365 for Operations Batch Management Service (on non-private AOS computers only)\n-   Management Reporter 2012 Process Service (on BI computers only)\n\n### Execute sqlpackage to export the Dynamics 365 for Operations database\n\nOpen a command prompt as an Administrator, and then execute the following commands.\n\n    cd C:\\Program Files (x86)\\Microsoft SQL Server\\130\\DAC\\bin\n\n    SqlPackage.exe /a:export /ssn:<server>.database.windows.net /sdn:<database to export> /tf:D:\\Exportedbacpac\\my.bacpac /p:CommandTimeout=1200 /p:VerifyFullTextDocumentTypesSupported=false /sp:<sql password> /su:<sql user>\n\nThe parameters include:\n\n-   **ssn** (source server name) - The name of the SQL Azure server from which you will export.\n-   **sdn** (source database name) - The name of the database that you will export.\n-   **tf** (target file) - The path and file name that you will export to.\n-   **sp** (source password) - The SQL password for the source SQL Server.\n-   **su** (source user) - The SQL user name for the source SQL Server. We recommend that you use the **sqladmin** user, which the deployment will have created on every Dynamics SQL instance. You can retrieve the password for this user from your Lifecycle Services (LCS) project.\n\nRunning this command creates a .bacpac file on the D:\\\\Exportedbacpac folder. You can take this file and copy or upload it to secure location so that it can be imported into a different environment at another time. You can use the AzCopy command line utility to upload the file to an Azure storage account[,](https://azure.microsoft.com/en-gb/documentation/articles/storage-use-azcopy/) and then download it to the target AOS computer. For more information, see [Copy or upload the file to an Azure storage account](https://docs.microsoft.com/en-gb/azure/storage/storage-use-azcopy). **Note:** Microsoft doesn’t provide a storage account as part of your Dynamics 365 for Operations agreement. You must either purchase a storage account or use a storage account from a separate Azure subscription. **Important:** Be aware of the behavior of the D drive on Azure Virtual Machines, do not keep your exported database files here permanently unless you are prepared to lose them. For details, see [Understanding the temporary drive on Windows Azure virtual machines (blog post)](https://blogs.msdn.microsoft.com/mast/2013/12/06/understanding-the-temporary-drive-on-windows-azure-virtual-machines/).\n\n### Start services\n\nUse services.msc to restart the services that you stopped earlier:\n\n-   World wide web publishing service (on all AOS computers)\n-   Microsoft Dynamics 365 for Operations Batch Management Service (on non-private AOS computers only)\n-   Management Reporter 2012 Process Service (on BI computers only)\n\n## Import the Dynamics 365 for Operations database\n### Stop services\n\nUse Remote Desktop to connect to all the computers in the environment and stop the following Windows services by using services.msc. These services will have open connections to the Dynamics 365 for Operations database.\n\n-   World wide web publishing service (on all AOS computers)\n-   Microsoft Dynamics 365 for Operations Batch Management Service (on non-private AOS computers only)\n-   Management Reporter 2012 Process Service (on BI computers only)\n\n### Import the bacpac file\n\nCopy the .bacpac file that was generated in the export step to the AOS computer in the target environment. For performance reasons, we recommend that you place the .bacpac file on the drive D on the AOS computer. Open a **Command Prompt** window as an administrator, and run the following commands.\n\n    cd C:\\Program Files (x86)\\Microsoft SQL Server\\130\\DAC\\bin\\\n\n    SqlPackage.exe /a:import /sf:D:\\Exportedbacpac\\my.bacpac /tsn:<azure sql database server name>.database.windows.net /tu:sqladmin /tp:<password from LCS> /tdn:<New database name> /p:CommandTimeout=1200 /p:DatabaseEdition=Premium /p:DatabaseServiceObjective=P2\n\nThe parameters include:\n\n-   **tsn** (target server name) – The name of the SQL Azure server to import into. The name can be found in LCS. Add the suffix **database.windows.net**.\n-   **tdn** (target database name) – The name of the database to import into. The database should **not** already exist. The import process will create it.\n-   **sf** (source file) – The path and file name to import from.\n-   **tu** (target user) – The SQL user name for the target Azure SQL database instance. We recommend that you use the standard **sqladmin** user. You can retrieve the password for this user from your LCS project.\n-   **tp** (target password) – The password for the target Azure SQL database user.\n\n### Run a script to update the Dynamics 365 for Operations database\n\nIf the source and target environments have different SQL user passwords, then you will need to run this script. If you are not sure if the passwords are different, you need to run this script. Run the following script against the imported database. The script will drop the database users and recreate them with the correct passwords for the target environment.\n\n    ALTER AUTHORIZATION ON Fulltext Catalog::[<enter the name of the full text catalog in your database] TO [dbo];\n\n    declare @userSQL varchar(1000)\n    set quoted_identifier off\n\n    declare userCursor CURSOR for\n    select 'DROP USER ' + name\n    from sys.sysusers\n    where issqlrole = 0 and hasdbaccess = 1 and name <> 'dbo'\n\n    OPEN userCursor\n    FETCH userCursor into @userSQL\n    WHILE @@Fetch_Status = 0\n    BEGIN\n    exec(@userSQL)\n    FETCH userCursor into @userSQL\n    END\n    CLOSE userCursor\n    DEALLOCATE userCursor\n\n    CREATE USER axdeployuser FROM LOGIN axdeployuser\n    EXEC sp_addrolemember 'db_owner', 'axdeployuser'\n\n    CREATE USER axdbadmin WITH PASSWORD = '<password from LCS>'\n    EXEC sp_addrolemember 'db_owner', 'axdbadmin'\n\n    CREATE USER axruntimeuser WITH PASSWORD = '<password from LCS>'\n    EXEC sp_addrolemember 'db_datareader', 'axruntimeuser'\n    EXEC sp_addrolemember 'db_datawriter', 'axruntimeuser'\n\n    CREATE USER axmrruntimeuser WITH PASSWORD = '<password from LCS>'\n    EXEC sp_addrolemember 'ReportingIntegrationUser', 'axmrruntimeuser'\n    EXEC sp_addrolemember 'db_datareader', 'axmrruntimeuser'\n    EXEC sp_addrolemember 'db_datawriter', 'axmrruntimeuser'\n\n    CREATE USER axretailruntimeuser WITH PASSWORD = '<password from LCS>'\n    EXEC sp_addrolemember 'UsersRole', 'axretailruntimeuser'\n    EXEC sp_addrolemember 'ReportUsersRole', 'axretailruntimeuser'\n\n## Limitations\nThe link between the database and document handling documents that are stored in Azure blob storage might be broken after importing a database. If you have custom code that utilizes the X++ class FileUpload to place files in blob storage, the links to these files might also be broken.\n\n"}